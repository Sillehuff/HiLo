<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hilo Playlist ‚Äì Instructor Edition</title>
  <meta name="description" content="Professional class planning with playlist optimization and Google Sheets integration" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><circle cx='24' cy='24' r='22' stroke='%23c9a15d' stroke-width='2' fill='none'/><path d='M14 30C16 20 20 16 24 16C28 16 32 20 34 30' stroke='%23c9a15d' stroke-width='3' stroke-linecap='round'/><path d='M12 36H36' stroke='%23c9a15d' stroke-width='2' stroke-linecap='round'/></svg>" />
  
  <style>
    :root {
      --primary: #243b33;
      --accent: #c9a15d;
      --cream: #f6f4f0;
      --ink: #0f0f0f;
      --ink-light: #2b2b2b;
      --glass: rgba(255,255,255,0.08);
      --radius: 16px;
      --radius-lg: 22px;
      --shadow: 0 10px 30px rgba(0,0,0,.22), 0 4px 12px rgba(0,0,0,.18);
      --inner-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.15);
      --blur: blur(16px);
      --gap: 18px;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #3498db;
    }
    /* Apple-like base */
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #0d1512 0%, #16231d 40%, #1b2d25 100%);
      color: var(--cream);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Inter", "Helvetica Neue", Arial, system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }
    * { box-sizing: border-box; }
    a { color: inherit; text-decoration: none; }
    .nav {
      position: sticky; top: 0; z-index: 20;
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px clamp(14px, 3vw, 28px);
      background: rgba(20, 34, 28, .85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand {
      display:flex; align-items:center; gap:10px;
      font-weight: 700; letter-spacing:.2px;
    }
    .brand svg { width: 28px; height: 28px; }
    .tabs {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .tab-btn {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255, .06);
      border: 1px solid rgba(255,255,255,.08);
      color: #f7f7f7;
      cursor: pointer;
      transition: all .15s ease;
      font-size: 14px;
      font-weight: 500;
    }
    .tab-btn[aria-selected="true"] {
      background: linear-gradient(180deg, rgba(201,161,93,.28), rgba(201,161,93,.14));
      border-color: rgba(201,161,93,.55);
      box-shadow: 0 6px 18px rgba(201,161,93,.26);
    }
    .tab-btn:hover {
      background: rgba(255,255,255, .1);
      transform: translateY(-1px);
    }
    .tab-btn:active { transform: scale(.98); }
    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 clamp(12px, 3vw, 24px);
      display: grid;
      gap: var(--gap);
    }
    /* Hero */
    .hero {
      position: relative;
      border-radius: var(--radius-lg);
      padding: clamp(18px, 3vw, 28px);
      background: radial-gradient(1200px 600px at 0% -10%, rgba(201,161,93,.12), transparent 60%),
                  radial-gradient(800px 500px at 100% 110%, rgba(201,161,93,.08), transparent 60%),
                  rgba(28, 45, 38, .6);
      backdrop-filter: var(--blur);
      border: 1px solid rgba(255,255,255,.07);
      box-shadow: var(--shadow);
    }
    .hero h1 {
      margin: 0 0 6px 0;
      font-size: clamp(22px, 3vw, 32px);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .subtle { color: rgba(255,255,255,.75); font-weight: 500; }
    .hero .row {
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 10px;
    }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1);
      padding: 8px 12px; border-radius:999px;
      font-size: 13px;
      transition: all .2s ease;
    }
    .pill:hover {
      transform: translateY(-1px);
    }
    /* Status indicators */
    .status-connected { background: rgba(46, 204, 113, .18); border-color: rgba(46, 204, 113, .45); }
    .status-disconnected { background: rgba(231, 76, 60, .18); border-color: rgba(231, 76, 60, .45); }
    .status-draft { background: rgba(241, 196, 15, .18); border-color: rgba(241, 196, 15, .45); }
    .status-finalized { background: rgba(46, 204, 113, .18); border-color: rgba(46, 204, 113, .45); }
    .status-info { background: rgba(52, 152, 219, .18); border-color: rgba(52, 152, 219, .45); }
    /* Glass cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--gap);
    }
    .card {
      position: relative;
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.09);
      box-shadow: var(--shadow);
      overflow:hidden;
      transition: all .3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 36px rgba(0,0,0,.26), 0 6px 16px rgba(0,0,0,.22);
    }
    .card .body { padding: 16px; }
    .card .title { font-weight: 700; letter-spacing:.2px; margin-bottom: 4px; }
    .card .muted { color: rgba(255,255,255,.74); font-size: 14px; }
    .primary-card {
      background: linear-gradient(180deg, rgba(36,59,51,.82), rgba(36,59,51,.68));
      border-color: rgba(201,161,93,.55);
    }
    .primary-card .title { color: #fff; font-size: 18px; }
    .metric-row {
      display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px;
    }
    .metric {
      background: rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px;
      text-align:center;
    }
    .metric .value { font-weight: 800; font-size: 22px; }
    .metric .label { color: rgba(255,255,255,.74); font-size: 12px; margin-top: 4px; }
    .btn { 
      padding: 10px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2);
      color: #fff; cursor:pointer;
      transition: all .15s ease;
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover {
      background: linear-gradient(180deg, rgba(201,161,93,.3), rgba(201,161,93,.15));
      box-shadow: 0 8px 22px rgba(201,161,93,.25);
      transform: translateY(-1px);
    }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(180deg, var(--accent), rgba(201,161,93,.8));
      border-color: var(--accent);
    }
    .btn-success {
      background: linear-gradient(180deg, var(--success), rgba(46, 204, 113, .8));
      border-color: var(--success);
    }
    .btn-warning {
      background: linear-gradient(180deg, var(--warning), rgba(243, 156, 18, .8));
      border-color: var(--warning);
    }
    .btn-danger {
      background: linear-gradient(180deg, var(--danger), rgba(231, 76, 60, .8));
      border-color: var(--danger);
    }
    .btn-info {
      background: linear-gradient(180deg, var(--info), rgba(52, 152, 219, .8));
      border-color: var(--info);
    }
    .suggestions { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--gap); }
    .suggestion-card { 
      padding: 14px; 
      cursor: pointer;
      transition: all .2s ease;
    }
    .suggestion-card:hover { 
      background: rgba(255,255,255,.08);
      transform: translateY(-2px);
    }
    /* Date/Time Selection */
    .datetime-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      background: rgba(0,0,0,.1);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255,255,255,.08);
      margin: 16px 0;
    }
    .datetime-selector label {
      font-weight: 500;
      color: rgba(255,255,255,.9);
      font-size: 14px;
    }
    .datetime-selector input {
      padding: 8px 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .datetime-selector input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(201,161,93,.2);
    }
    /* Guest Selection UI */
    .guest-selector {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: rgba(0,0,0,.1);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .selected-guests-container {
      min-height: 50px;
      padding: 10px;
      background: rgba(0,0,0,.15);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .selected-guests {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .no-selection {
      color: rgba(255,255,255,.5);
      font-style: italic;
      padding: 8px 4px;
    }
    .selected-guest-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(201,161,93,.28), rgba(201,161,93,.14));
      border: 1px solid rgba(201,161,93,.35);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 14px;
      animation: fadeIn .2s ease;
    }
    .remove-guest {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .remove-guest:hover {
      opacity: 1;
    }
    .guest-list-container {
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0,0,0,.15);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .guest-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      padding: 12px;
    }
    .guest-list-item {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    .guest-list-item:hover {
      background: rgba(255,255,255,.1);
      border-color: rgba(201,161,93,.4);
      transform: translateY(-1px);
    }
    .guest-list-item.selected {
      background: linear-gradient(180deg, rgba(201,161,93,.28), rgba(201,161,93,.14));
      border-color: rgba(201,161,93,.55);
      font-weight: 500;
    }
    /* Search Container */
    .search-container {
      position: relative;
      max-width: 300px;
    }
    
    .search-container input {
      width: 100%;
      padding: 12px 16px;
      padding-left: 40px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: #fff;
      font-size: 14px;
    }
    
    .search-container::before {
      content: 'üîç';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.6;
    }
    .search-wrap { display:flex; gap:8px; flex-wrap:wrap; }
    .search { 
      flex:1;
      min-width: 240px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px; border-radius: 12px; color:#fff;
    }
    .select { 
      min-width: 160px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px; border-radius: 12px; color:#fff;
      cursor: pointer;
    }
    /* Enhanced Tables */
    .table-container {
      border-radius: var(--radius);
      overflow: hidden;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }
    
    .data-table { 
      width:100%; 
      border-collapse: collapse; 
      background: transparent;
    }
    
    .data-table th, .data-table td { 
      text-align:left; 
      padding: 16px 20px; 
      border-bottom: 1px solid rgba(255,255,255,.08); 
    }
    
    .data-table th { 
      color: rgba(255,255,255,.9); 
      font-weight: 600; 
      background: rgba(255,255,255,.06);
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    
    .data-table tbody tr:hover { 
      background: rgba(255,255,255,.06);
      transition: background 0.2s ease;
    }
    
    .data-table tbody tr:last-child td {
      border-bottom: none;
    }
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    .sortable:hover {
      color: var(--accent);
    }
    
    .sortable::after {
      content: '‚Üï';
      position: absolute;
      right: 8px;
      opacity: 0.5;
      font-size: 12px;
    }
    .sortable.asc::after {
      content: '‚Üë';
      opacity: 1;
    }
    .sortable.desc::after {
      content: '‚Üì';
      opacity: 1;
    }
    /* Section Header */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .section-header h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }
    /* Weekly Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 16px;
      margin-top: 20px;
    }
    .day-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      padding: 16px;
      min-height: 200px;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .day-card:hover {
      background: rgba(255,255,255,.1);
      transform: translateY(-2px);
    }
    .day-card.has-classes {
      border-color: rgba(201,161,93,.4);
      background: rgba(201,161,93,.08);
    }
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    .day-name {
      font-weight: 600;
      color: #fff;
    }
    .day-date {
      font-size: 12px;
      color: rgba(255,255,255,.7);
    }
    .class-list {
      flex-grow: 1;
    }
    .class-item {
      background: rgba(0,0,0,.2);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
    }
    .class-item:hover {
      background: rgba(0,0,0,.3);
      transform: translateX(2px);
    }
    .class-time {
      font-weight: 600;
      color: var(--accent);
    }
    .class-info {
      color: rgba(255,255,255,.8);
      font-size: 12px;
      margin-top: 2px;
    }
    .class-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }
    /* Guest Grid */
    .guests-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .guest-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .guest-card:hover {
      background: rgba(255,255,255,.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    .guest-card-header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .guest-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), rgba(201,161,93,.6));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: #fff;
    }
    .guest-info h4 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: #fff;
    }
    .guest-info p {
      margin: 0;
      font-size: 13px;
      color: rgba(255,255,255,.7);
    }
    .guest-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .guest-stat {
      text-align: center;
      padding: 8px;
      background: rgba(0,0,0,.15);
      border-radius: 8px;
    }
    .guest-stat .value {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    .guest-stat .label {
      display: block;
      font-size: 11px;
      color: rgba(255,255,255,.6);
      margin-top: 2px;
    }
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn .2s ease;
    }
    
    .modal__content {
      background: rgba(28, 45, 38, .95);
      backdrop-filter: var(--blur);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      animation: slideUp .3s ease;
    }
    
    .modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      flex-shrink: 0;
    }
    
    .modal__header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }
    
    .modal__close {
      background: none;
      border: none;
      font-size: 24px;
      color: rgba(255,255,255,.7);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .modal__close:hover {
      background: rgba(255,255,255,.1);
      color: #fff;
    }
    
    .modal__body {
      padding: 24px;
      overflow-y: auto;
    }
     .modal__footer {
      padding: 16px 24px;
      border-top: 1px solid rgba(255,255,255,.08);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
    }
    /* Form styling */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: rgba(255,255,255,.9);
      font-size: 14px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(201,161,93,.2);
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    /* Connection status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .connection-status.connected {
      background: rgba(46, 204, 113, .1);
      border: 1px solid rgba(46, 204, 113, .3);
    }
    .connection-status.disconnected {
      background: rgba(231, 76, 60, .1);
      border: 1px solid rgba(231, 76, 60, .3);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .status-dot.connected { background: var(--success); }
    .status-dot.disconnected { background: var(--danger); }
    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,.6);
    }
    
    .empty-state h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: rgba(255,255,255,.8);
    }
    /* Toast notifications */
    #toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    
    .toast {
      pointer-events: auto;
      min-width: 280px;
      max-width: 420px;
      background: rgba(28,28,30,.95);
      color: #fff;
      padding: 14px 18px;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
      font: 500 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.1);
      animation: slideInRight .3s ease;
    }
    
    .toast.success {
      background: rgba(46, 204, 113, .95);
      border-color: rgba(46, 204, 113, .5);
    }
    
    .toast.error {
      background: rgba(231, 76, 60, .95);
      border-color: rgba(231, 76, 60, .5);
    }
    
    .toast.info {
      background: rgba(52, 152, 219, .95);
      border-color: rgba(52, 152, 219, .5);
    }
    /* Loading indicator */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn .3s ease both; }
    /* Debug Panel */
    .debug-panel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,.9);
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      font-size: 11px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 10000;
    }
    .debug-panel.show {
      display: block;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .calendar-grid {
        grid-template-columns: 1fr;
      }
      
      .metric-row {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .datetime-selector {
        flex-direction: column;
        align-items: stretch;
      }
      
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap;
        scrollbar-width: none; /* Firefox */
      }
      .tabs::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
      }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand">
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="24" cy="24" r="22" stroke="#c9a15d" stroke-width="2"/>
        <path d="M14 30C16 20 20 16 24 16C28 16 32 20 34 30" stroke="#c9a15d" stroke-width="3" stroke-linecap="round"/>
        <path d="M12 36H36" stroke="#c9a15d" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Hilo Playlist</span>
    </div>
    <div class="tabs" role="tablist">
      <button class="tab-btn" role="tab" aria-selected="true" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="weekly">Weekly Planner</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="explorer">Playlist Explorer</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="history">History</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="guests">Guests</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="settings">Settings</button>
    </div>
  </nav>
  <main class="container">
    <section id="dashboard" class="fade-in">
      <div class="hero">
        <h1>Class Planning Dashboard</h1>
        <div class="subtle" id="currentDateTime"></div>
        
        <div id="connection-status" class="connection-status disconnected">
          <div class="status-dot disconnected"></div>
          <span>Google Sheets: Not Connected</span>
        </div>
        
        <div class="datetime-selector">
          <div style="flex: 1;">
            <label for="class-date-dashboard">Class Date</label>
            <input type="date" id="class-date-dashboard">
          </div>
          <div style="flex: 1;">
            <label for="class-time-dashboard">Class Time</label>
            <input type="time" id="class-time-dashboard" value="09:00">
          </div>
          <button id="todayBtn" class="btn btn-info">Set to Now</button>
        </div>
        
        <div style="margin-top:20px;">
          <div class="guest-selector">
            <div class="search-container" style="max-width:100%;">
              <input type="text" id="guest-search" placeholder="Search House Guests...">
            </div>
            
            <div class="selected-guests-container">
              <div class="selected-guests" id="rosterChips">
                <div class="no-selection" id="no-selection-message">No House Guests selected</div>
              </div>
            </div>
            
            <div class="guest-list-container">
              <div class="guest-list" id="guest-list"></div>
            </div>
          </div>
        </div>
        
        <div class="row" style="margin-top:14px;">
          <div class="search-wrap" style="flex:1;">
            <select id="playlistWindow" class="select" title="Stale window">
              <option value="45" selected>Stale ‚â• 45 days</option>
              <option value="30">Stale ‚â• 30 days</option>
              <option value="60">Stale ‚â• 60 days</option>
              <option value="90">Stale ‚â• 90 days</option>
            </select>
            <button id="saveDraftBtn" class="btn btn-warning" title="Save as draft">
              <span>üíæ</span> Save Draft
            </button>
            <button id="finalizeBtn" class="btn btn-success" title="Finalize and sync" disabled>
              <span>‚úî</span> Finalize Class
            </button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <span class="pill" id="rosterCountPill">0 attendees</span>
          <span class="pill" id="recordsCountPill">0 records</span>
          <span id="draftStatusPill" class="pill hidden">No draft</span>
        </div>
      </div>
      <div class="cards" style="margin-top:14px;">
        <div class="card primary-card" id="bestCard">
          <div class="body">
            <div class="title">Best Fit Recommendation</div>
            <div class="muted">Maximizes freshness for the current roster</div>
            <div id="bestSummary" style="margin-top:10px;"></div>
            <div class="metric-row">
              <div class="metric">
                <div class="value" id="bestNever">‚Äî</div>
                <div class="label">Never-heard</div>
              </div>
              <div class="metric">
                <div class="value" id="bestMedian">‚Äî</div>
                <div class="label">Median days</div>
              </div>
              <div class="metric">
                <div class="value" id="bestStale">‚Äî</div>
                <div class="label">Stale %</div>
              </div>
            </div>
            <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" id="selectPlaylistBtn">Use This Playlist</button>
              <button class="btn" id="previewRosterBtn">View Details</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <div class="title">Runner-ups</div>
            <div class="muted">Strong alternatives ranked by freshness</div>
            <div class="suggestions" id="runnerUps"></div>
          </div>
        </div>
      </div>
    </section>
    <section id="weekly" class="hidden fade-in">
      <div class="hero">
        <h1>Weekly Class Planner</h1>
        <div class="subtle">Plan and manage your upcoming week of classes</div>
        
        <div class="row" style="margin-top:14px;">
          <div class="search-wrap" style="flex:1;">
            <button id="prevWeekBtn" class="btn">‚Üê Previous Week</button>
            <button id="currentWeekBtn" class="btn btn-info">Current Week</button>
            <button id="nextWeekBtn" class="btn">Next Week ‚Üí</button>
            <button id="syncAllBtn" class="btn btn-success" disabled>Sync All Finalized</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <span class="pill" id="weekRangePill">Week of ...</span>
          <span class="pill status-draft" id="draftsCountPill">0 drafts</span>
          <span class="pill status-finalized" id="finalizedCountPill">0 finalized</span>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        </div>
    </section>
    <section id="explorer" class="hidden fade-in">
      <div class="hero">
        <h1>Playlist Explorer</h1>
        <div class="subtle">Compare all playlists by freshness metrics for the current roster</div>
      </div>
      <div class="card">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="playlist">Playlist</th>
                <th class="sortable" data-sort="never">Never-heard</th>
                <th class="sortable" data-sort="median">Median days</th>
                <th class="sortable" data-sort="stalePct">Stale %</th>
                <th class="sortable" data-sort="score">Score</th>
              </tr>
            </thead>
            <tbody id="explorerTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="history" class="hidden fade-in">
      <div class="section-header">
        <h2>Class History</h2>
        <div class="search-container">
          <input type="text" id="history-search" placeholder="Search classes...">
        </div>
      </div>
      <div class="card">
        <div class="table-container">
          <table id="history-table" class="data-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="datetime">Date & Time</th>
                <th class="sortable" data-sort="playlist">Playlist</th>
                <th class="sortable" data-sort="count">Attendees</th>
                <th>Guest Names</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="guests" class="hidden fade-in">
      <div class="section-header">
        <h2>Guest Profiles</h2>
        <div class="search-container">
          <input type="text" id="guest-search-filter" placeholder="Search guests...">
        </div>
      </div>
      <div id="guests-grid" class="guests-grid">
        <div class="empty-state">
          <h3>No guest data available</h3>
          <p>Connect Google Sheets to see guest profiles</p>
        </div>
      </div>
    </section>
    <section id="settings" class="hidden fade-in">
      <div class="hero">
        <h1>Settings</h1>
        <div class="subtle">Configure Google Sheets integration and app preferences</div>
      </div>
      <div class="cards">
        <div class="card">
          <div class="body">
            <div class="title">Google Sheets Integration</div>
            <div class="muted">Connected via Apps Script Web App</div>
            
            <div style="margin-top:16px;">
              <div class="form-group">
                <label>Connection Status</label>
                <div id="sheets-connection-info" style="padding: 12px; background: rgba(0,0,0,.1); border-radius: 8px; color: rgba(255,255,255,.9);">
                  <div style="margin-bottom: 8px;">Web App URL: Configured ‚úî</div>
                  <div>API Token: Configured ‚úî</div>
                </div>
              </div>
              
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 16px;">
                <button id="testConnectionBtn" class="btn btn-primary">Test Connection</button>
                <button id="refreshDataBtn" class="btn">Refresh Data</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <div class="title">Data Management</div>
            <div class="muted">Import/export and sync your class data</div>
            
            <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="importCsvBtn" class="btn">üì• Import CSV</button>
              <button id="exportCsvBtn" class="btn">üì§ Export CSV</button>
              <button id="syncFromSheetsBtn" class="btn">üîÑ Pull from Sheets</button>
              <button id="clearDataBtn" class="btn btn-danger">üóëÔ∏è Clear All Data</button>
            </div>
            <input id="fileInput" type="file" accept=".csv" class="hidden" />
          </div>
        </div>
      </div>
    </section>
    <div id="class-modal" class="modal hidden">
      <div class="modal__content">
        <div class="modal__header">
          <h3 id="class-modal-title">Plan Class</h3>
          <button id="close-class-modal" class="modal__close">&times;</button>
        </div>
        <div class="modal__body">
          <div class="form-row">
            <div class="form-group">
              <label for="modal-class-date">Date</label>
              <input type="date" id="modal-class-date">
            </div>
            <div class="form-group">
              <label for="modal-class-time">Time</label>
              <input type="time" id="modal-class-time" value="09:00">
            </div>
          </div>
          
          <div class="form-group">
            <label for="modal-class-playlist">Playlist</label>
            <select id="modal-class-playlist">
              <option value="">Select playlist...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Attendees</label>
            <div class="guest-selector">
              <div class="search-container" style="max-width:100%;">
                <input type="text" id="modal-guest-search" placeholder="Search guests...">
              </div>
              
              <div class="selected-guests-container">
                <div class="selected-guests" id="modal-selected-guests">
                  <div class="no-selection">No guests selected</div>
                </div>
              </div>
              
              <div class="guest-list-container" style="max-height: 200px;">
                <div class="guest-list" id="modal-guest-list"></div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="modal-class-notes">Notes (optional)</label>
            <textarea id="modal-class-notes" placeholder="Add any notes about this class..."></textarea>
          </div>
        </div>
         <div class="modal__footer">
            <button id="delete-class-modal" class="btn btn-danger" style="margin-right: auto;">üóëÔ∏è Delete</button>
            <button id="cancel-modal" class="btn">Cancel</button>
            <button id="save-draft-modal" class="btn btn-warning">üíæ Save as Draft</button>
            <button id="finalize-modal" class="btn btn-success">‚úî Finalize</button>
        </div>
      </div>
    </div>
    <div id="guest-modal" class="modal hidden">
      <div class="modal__content">
        <div class="modal__header">
          <h3 id="guest-modal-title">Guest Profile</h3>
          <button id="close-guest-modal" class="modal__close">&times;</button>
        </div>
        <div class="modal__body" id="guest-modal-body">
          <div id="guest-modal-content"></div>
        </div>
      </div>
    </div>
  </main>
  <div id="debug-panel" class="debug-panel">
    <strong>Debug Info:</strong>
    <div id="debug-content"></div>
  </div>
<script>
  // --- Configuration for Google Apps Script ---
  const APPS_SCRIPT_CONFIG = {
    url: 'https://script.google.com/macros/s/AKfycbyp5q-4rIC2XHa60ZnYS2x0bZrxDmNYAV3YvOf5EmxnnVqW2nAKEq6Em6UWgCy8ftULgQ/exec',
    token: '4c94713e-9b2b-4980-8b07-2b3948f6f6a1'
  };
  // --- Debug Mode ---
  const DEBUG_MODE = false; // Set to true to enable debug logging
  function debugLog(...args) {
    if (DEBUG_MODE) {
      console.log('[DEBUG]', ...args);
      const panel = document.getElementById('debug-panel');
      const content = document.getElementById('debug-content');
      if (panel && content) {
        panel.classList.add('show');
        const timestamp = new Date().toLocaleTimeString();
        content.innerHTML = `<div>${timestamp}: ${args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ')}</div>` + content.innerHTML;
        const messages = content.querySelectorAll('div');
        if (messages.length > 20) {
          messages[messages.length - 1].remove();
        }
      }
    }
  }
  // --- Enhanced state with Google Sheets integration ---
  const state = {
    attendees: new Set(),
    playlists: Array.from({ length: 12 }, (_, i) => i + 1),
    records: [], // Historical records with date, time, guest, playlist
    selectedWindow: 45,
    allGuests: new Set(),
    sortOrder: { column: 'datetime', ascending: false },
    explorerSortOrder: { column: 'score', ascending: false },
    
    // Google Sheets integration
    googleSheetsConnected: false,
    lastSyncTime: null,
    
    // Weekly planner state
    weeklyPlan: new Map(), // DateTime string -> class object
    currentWeekStart: null,
    selectedClass: null, // Holds the class being edited in the modal
    
    // Current selection for dashboard
    selectedDate: null,
    selectedTime: null,
    
    // Track active JSONP requests
    activeRequests: new Set()
  };
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  // --- Google Apps Script API Functions (Fixed JSONP Version) ---
  async function makeApiRequest(action, data = {}) {
    return new Promise((resolve, reject) => {
      const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
      
      state.activeRequests.add(callbackName);
      debugLog(`Starting API request: ${action}`, callbackName);
      
      const script = document.createElement('script');
      let timeoutId;
      window[callbackName] = (responseData) => {
        debugLog(`Received response for ${action}:`, responseData);
        clearTimeout(timeoutId);
        state.activeRequests.delete(callbackName);
        if (script.parentNode) {
          document.body.removeChild(script);
        }
        delete window[callbackName];
        
        if (responseData && responseData.success !== undefined) {
          if (responseData.error) {
            reject(new Error(responseData.error));
          } else {
            resolve(responseData);
          }
        } else {
          reject(new Error('Invalid response format'));
        }
      };
      script.onerror = () => {
        debugLog(`Script error for ${action}`);
        clearTimeout(timeoutId);
        state.activeRequests.delete(callbackName);
        if (script.parentNode) {
          document.body.removeChild(script);
        }
        delete window[callbackName];
        reject(new Error('API request failed: Script error'));
      };
      
      timeoutId = setTimeout(() => {
        debugLog(`Request timeout for ${action}`);
        state.activeRequests.delete(callbackName);
        if (window[callbackName]) {
          if (script.parentNode) {
            document.body.removeChild(script);
          }
          delete window[callbackName];
          reject(new Error('API request timed out'));
        }
      }, 15000); // 15-second timeout
      const params = new URLSearchParams({
        token: APPS_SCRIPT_CONFIG.token,
        action: action,
        callback: callbackName
      });
      
      if (data.rows) {
        params.set('rows', JSON.stringify(data.rows));
      }
      script.src = `${APPS_SCRIPT_CONFIG.url}?${params.toString()}`;
      debugLog(`Request URL: ${script.src}`);
      document.body.appendChild(script);
    });
  }
   function setLoading(button, isLoading) {
    if (!button) return;
    if (isLoading) {
      button.disabled = true;
      button.dataset.originalContent = button.innerHTML;
      button.innerHTML = '<div class="loading-spinner"></div>';
    } else {
      button.disabled = false;
      if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
      }
    }
  }
  async function testConnection() {
    debugLog('Testing connection...');
    setLoading($("#testConnectionBtn"), true);
    
    try {
      const result = await makeApiRequest('test');
      debugLog('Connection test result:', result);
      
      if (result.success) {
        state.googleSheetsConnected = true;
        updateConnectionStatus();
        showToast('Connection successful!', 'success');
        return true;
      } else {
        throw new Error(result.error || 'Connection test failed');
      }
    } catch (error) {
      console.error('Connection test failed:', error);
      debugLog('Connection test error:', error.message);
      state.googleSheetsConnected = false;
      updateConnectionStatus();
      showToast('Connection failed: ' + error.message, 'error');
      return false;
    } finally {
      setLoading($("#testConnectionBtn"), false);
    }
  }
  async function fetchDataFromSheets() {
    debugLog('Fetching data from sheets...');
    
    try {
      const result = await makeApiRequest('read');
      debugLog('Fetch result:', result);
      
      if (result.success && result.data) {
        const localRecords = new Set(state.records.map(r => `${r.date}|${r.time}|${r.guest}|${r.playlist}`));
        let newRecordsCount = 0;
        
        result.data.forEach((row, index) => {
          if (row && row.length >= 4) {
            const [dateStr, timeStr, guest, playlistStr] = row;
            
            if (dateStr && guest && playlistStr) {
              const date = typeof dateStr === 'string' ? dateStr.slice(0, 10) : formatDateKey(new Date(dateStr));
              const time = timeStr || '09:00';
              const playlist = parseInt(playlistStr, 10);
              
              if (!isNaN(playlist) && playlist >= 1 && playlist <= 12) {
                  const recordKey = `${date}|${time}|${guest.trim()}|${playlist}`;
                  if (!localRecords.has(recordKey)) {
                    state.records.push({ date, time, guest: guest.trim(), playlist });
                    state.allGuests.add(guest.trim());
                    newRecordsCount++;
                  }
              }
            }
          }
        });
        
        debugLog(`Synced ${newRecordsCount} new records from Sheets.`);
        state.lastSyncTime = new Date();
        saveStateToLocalStorage();
        showToast(`Loaded ${newRecordsCount} new records from Google Sheets`, 'success');
        return true;
      }
      return false;
    } catch (error) {
      console.error('Failed to fetch data:', error);
      debugLog('Fetch error:', error.message);
      throw error;
    }
  }
  async function writeToSheets(classData) {
    debugLog('Writing to sheets:', classData);
    if (!state.googleSheetsConnected) {
        showToast('Cannot sync: Not connected to Google Sheets.', 'error');
        return false;
    }
    
    try {
      const rows = [];
      classData.attendees.forEach(guest => {
        rows.push([
          classData.date,
          classData.time || '09:00',
          guest,
          classData.playlist.toString()
        ]);
      });
      
      debugLog('Sending rows:', rows);
      const result = await makeApiRequest('append', { rows: rows });
      debugLog('Write result:', result);
      
      if (result.success) {
        showToast(`Synced ${rows.length} records to Google Sheets`, 'success');
        return true;
      }
      return false;
    } catch (error) {
      console.error('Failed to write to sheets:', error);
      debugLog('Write error:', error.message);
      showToast('Failed to sync to Google Sheets: ' + error.message, 'error');
      return false;
    }
  }
  // --- Local Storage Persistence ---
  function saveStateToLocalStorage() {
      try {
          const dataToSave = {
              records: state.records,
              weeklyPlan: Array.from(state.weeklyPlan.entries()),
              allGuests: Array.from(state.allGuests)
          };
          localStorage.setItem('hiloPlaylistData', JSON.stringify(dataToSave));
          debugLog('State saved to localStorage');
      } catch (e) {
          console.error("Failed to save state to localStorage", e);
      }
  }
  function loadStateFromLocalStorage() {
      try {
          const savedData = localStorage.getItem('hiloPlaylistData');
          if (savedData) {
              const parsedData = JSON.parse(savedData);
              state.records = parsedData.records || [];
              state.weeklyPlan = new Map(parsedData.weeklyPlan || []);
              // Convert attendee arrays back to Sets
              state.weeklyPlan.forEach(cls => {
                  cls.attendees = new Set(cls.attendees);
              });
              state.allGuests = new Set(parsedData.allGuests || []);
              debugLog('State loaded from localStorage');
          }
      } catch (e) {
          console.error("Failed to load state from localStorage", e);
      }
  }
  // --- Utility Functions ---
  const formatDate = (d) => {
    if (!d) return '';
    const date = new Date(d);
    // Adjust for timezone offset to prevent off-by-one day errors
    const userTimezoneOffset = date.getTimezoneOffset() * 60000;
    const correctedDate = new Date(date.getTime() + userTimezoneOffset);
    return correctedDate.toLocaleDateString('en-US', { 
      weekday: 'short', 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  };
  const formatTime = (timeStr) => {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours, 10);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${String(minutes).padStart(2, '0')} ${ampm}`;
  };
  const formatDateTime = (date, time) => {
    return `${formatDate(date)} at ${formatTime(time)}`;
  };
  const createDateTimeKey = (date, time) => {
    return `${date}T${time}`;
  };
  const parseDateTimeKey = (key) => {
    const [date, time] = key.split('T');
    return { date, time };
  };
  const daysBetween = (d1, d2) => {
    const date1 = new Date(d1);
    const date2 = new Date(d2);
    const diffTime = Math.abs(date2 - date1);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  };
  const median = (arr) => {
    if (!arr.length) return 0;
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 ? sorted[mid] : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
  };
  const getWeekStart = (date) => {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day; // Sunday = 0
    return new Date(d.setDate(diff));
  };
  const getWeekDays = (weekStart) => {
    const days = [];
    for (let i = 0; i < 7; i++) {
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + i);
      days.push(day);
    }
    return days;
  };
  const formatDateKey = (date) => date.toISOString().slice(0, 10);
  
  // --- Initialize App ---
  async function initializeApp() {
    debugLog('Initializing app...');
    loadStateFromLocalStorage();
    
    const today = new Date();
    const currentTime = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;
    
    $("#class-date-dashboard").value = formatDateKey(today);
    $("#class-date-dashboard").min = formatDateKey(today);
    $("#class-time-dashboard").value = currentTime;
    
    state.selectedDate = formatDateKey(today);
    state.selectedTime = currentTime;
    state.currentWeekStart = getWeekStart(today);
    
    const connected = await testConnection();
    if (connected) {
      await loadDataFromSheets();
    }
    
    addEventListeners();
    populateGuestList();
    renderSelectedGuests();
    updateConnectionStatus();
    updateDashboardStatus();
    updateRecordsPill();
    refreshAll();
  }
  function updateCurrentDateTime() {
    const now = new Date();
    $("#currentDateTime").textContent = now.toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }
  updateCurrentDateTime();
  setInterval(updateCurrentDateTime, 60000);
  
  async function loadDataFromSheets() {
    debugLog('Loading data from sheets...');
    setLoading($("#refreshDataBtn"), true);
    setLoading($("#syncFromSheetsBtn"), true);
    
    try {
      const success = await fetchDataFromSheets();
      if (success) {
        populateGuestList();
        updateRecordsPill();
        refreshAll();
        refreshHistory();
        refreshGuests();
      }
    } catch (error) {
      showToast('Failed to load data: ' + error.message, 'error');
    } finally {
      setLoading($("#refreshDataBtn"), false);
      setLoading($("#syncFromSheetsBtn"), false);
    }
  }
  // --- Toast Notification System ---
  function showToast(message, type = 'info', duration = 3000) {
    let container = $('#toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    
    const removeToast = () => {
        toast.style.animation = 'slideOutRight 0.3s ease forwards';
        toast.addEventListener('animationend', () => toast.remove());
    };
    
    const timer = setTimeout(removeToast, duration);
    
    toast.addEventListener('click', () => {
        clearTimeout(timer);
        removeToast();
    });
  }
  
  // Add CSS for slide out animation
  const styleSheet = document.createElement("style");
  styleSheet.type = "text/css";
  styleSheet.innerText = `@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
  document.head.appendChild(styleSheet);
  
  function updateConnectionStatus() {
    const statusEl = $("#connection-status");
    const dotEl = statusEl.querySelector('.status-dot');
    
    if (state.googleSheetsConnected) {
      statusEl.className = 'connection-status connected';
      dotEl.className = 'status-dot connected';
      statusEl.querySelector('span').textContent = 'Google Sheets: Connected';
      $("#finalizeBtn").disabled = false;
      $("#syncAllBtn").disabled = false;
    } else {
      statusEl.className = 'connection-status disconnected';
      dotEl.className = 'status-dot disconnected';
      statusEl.querySelector('span').textContent = 'Google Sheets: Not Connected';
      $("#finalizeBtn").disabled = true;
      $("#syncAllBtn").disabled = true;
    }
  }
  // --- Class Management ---
  function createClass(date, time, playlist = null, attendees = new Set(), notes = '', status = 'draft') {
    return {
      id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
      date: date,
      time: time,
      playlist: playlist,
      attendees: new Set(attendees),
      status: status,
      notes: notes,
      synced: false
    };
  }
  function saveDraftClass() {
    if (state.attendees.size === 0) {
      showToast('Please select at least one attendee', 'error');
      return;
    }
    const metrics = computeMetrics();
    const bestPlaylist = metrics[0]?.playlist;
    
    if (!bestPlaylist) {
      showToast('No playlist recommendation available', 'error');
      return;
    }
    const dateTimeKey = createDateTimeKey(state.selectedDate, state.selectedTime);
    let existingClass = state.weeklyPlan.get(dateTimeKey);
    
    if (existingClass) {
      existingClass.playlist = bestPlaylist;
      existingClass.attendees = new Set(state.attendees);
      existingClass.status = 'draft'; // Revert to draft if re-saved
      existingClass.synced = false;
    } else {
      const newClass = createClass(state.selectedDate, state.selectedTime, bestPlaylist, state.attendees);
      state.weeklyPlan.set(dateTimeKey, newClass);
    }
    
    updateDashboardStatus();
    saveStateToLocalStorage();
    showToast('Draft saved!', 'success');
  }
  async function finalizeClass() {
    const dateTimeKey = createDateTimeKey(state.selectedDate, state.selectedTime);
    const draftClass = state.weeklyPlan.get(dateTimeKey);
    
    if (!draftClass || state.attendees.size === 0) {
      showToast('No valid draft found. Please select attendees and save a draft first.', 'error');
      return;
    }
    if (draftClass.status === 'finalized') {
      showToast('This class has already been finalized.', 'info');
      return;
    }
    setLoading($("#finalizeBtn"), true);
    
    try {
      draftClass.status = 'finalized';
      const synced = await writeToSheets(draftClass);
      if (synced) {
        draftClass.synced = true;
        draftClass.attendees.forEach(guest => {
          state.records.push({ date: draftClass.date, time: draftClass.time, guest: guest, playlist: draftClass.playlist });
        });
        
        saveStateToLocalStorage();
        updateDashboardStatus();
        updateRecordsPill();
        refreshAll();
        showToast('Class finalized and synced!', 'success');
      } else {
        draftClass.status = 'draft'; // Revert if sync failed
        showToast('Failed to sync. Class remains as draft.', 'error');
      }
    } finally {
      setLoading($("#finalizeBtn"), false);
    }
  }
  function updateDashboardStatus() {
    const dateTimeKey = createDateTimeKey(state.selectedDate, state.selectedTime);
    const currentClass = state.weeklyPlan.get(dateTimeKey);
    const draftStatusPill = $("#draftStatusPill");
    
    if (currentClass) {
      draftStatusPill.textContent = currentClass.status === 'draft' ? 'Draft saved' : 'Finalized';
      draftStatusPill.className = `pill ${currentClass.status === 'draft' ? 'status-draft' : 'status-finalized'}`;
      draftStatusPill.classList.remove('hidden');
      $("#finalizeBtn").disabled = currentClass.status === 'finalized' || !state.googleSheetsConnected;
    } else {
      draftStatusPill.classList.add('hidden');
      $("#finalizeBtn").disabled = state.attendees.size === 0 || !state.googleSheetsConnected;
    }
  }
  function updateRecordsPill() {
    $("#recordsCountPill").textContent = `${state.records.length} records`;
  }
  // --- Weekly Calendar ---
  function renderWeeklyCalendar() {
    const calendarGrid = $("#calendarGrid");
    const weekDays = getWeekDays(state.currentWeekStart);
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    calendarGrid.innerHTML = '';
    
    weekDays.forEach((day, index) => {
      const dayKey = formatDateKey(day);
      const isToday = dayKey === formatDateKey(new Date());
      
      const dayClasses = Array.from(state.weeklyPlan.entries())
        .filter(([key]) => key.startsWith(dayKey))
        .map(([key, cls]) => ({...cls, dateTimeKey: key}))
        .sort((a, b) => a.time.localeCompare(b.time));
      
      const dayCard = document.createElement('div');
      dayCard.className = `day-card ${dayClasses.length > 0 ? 'has-classes' : ''}`;
      
      let classesHTML = '';
      if (dayClasses.length > 0) {
        classesHTML = dayClasses.map(cls => `
          <div class="class-item" onclick="openClassModal('${cls.dateTimeKey}')">
            <div class="class-time">${formatTime(cls.time)}</div>
            <div class="class-info">
              Playlist #${cls.playlist} ‚Ä¢ ${cls.attendees.size} guests
            </div>
            <div class="pill ${cls.status === 'draft' ? 'status-draft' : 'status-finalized'} " style="margin-top: 4px; font-size: 11px; padding: 4px 8px;">
              ${cls.status}${cls.synced ? ' (Synced)' : ''}
            </div>
          </div>
        `).join('');
      } else {
        classesHTML = '<div class="empty-state" style="padding: 20px 0;"><p style="margin:0;">No classes scheduled</p></div>';
      }
      
      dayCard.innerHTML = `
        <div class="day-header">
          <div class="day-name">${dayNames[index]} ${isToday ? '‚Ä¢ Today' : ''}</div>
          <div class="day-date">${day.getMonth() + 1}/${day.getDate()}</div>
        </div>
        <div class="class-list">${classesHTML}</div>
        <div class="class-actions">
          <button class="btn btn-sm btn-primary" onclick="openNewClassModal('${dayKey}')">+ Add Class</button>
        </div>
      `;
      
      calendarGrid.appendChild(dayCard);
    });
    
    updateWeeklyStats();
  }
  function updateWeeklyStats() {
    const weekStart = state.currentWeekStart;
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    $("#weekRangePill").textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
    
    let drafts = 0, finalized = 0;
    state.weeklyPlan.forEach(cls => {
        const clsDate = new Date(cls.date);
        if (clsDate >= weekStart && clsDate <= weekEnd) {
            if (cls.status === 'draft') drafts++;
            else finalized++;
        }
    });
    
    $("#draftsCountPill").textContent = `${drafts} draft${drafts !== 1 ? 's' : ''}`;
    $("#finalizedCountPill").textContent = `${finalized} finalized`;
  }
  function navigateWeek(direction) {
    if (direction === 0) {
        state.currentWeekStart = getWeekStart(new Date());
    } else {
        const newStart = new Date(state.currentWeekStart);
        newStart.setDate(newStart.getDate() + (direction * 7));
        state.currentWeekStart = newStart;
    }
    renderWeeklyCalendar();
  }
  
  window.openNewClassModal = function(dateKey) {
    state.selectedClass = createClass(dateKey, '09:00');
    state.attendees = new Set(); // Start with empty roster for new class
    
    $("#class-modal-title").textContent = 'Plan New Class';
    $("#modal-class-date").value = dateKey;
    $("#modal-class-time").value = '09:00';
    $("#modal-class-playlist").value = '';
    $("#modal-class-notes").value = '';
    
    populateModalPlaylistOptions();
    populateModalGuestList();
    renderModalSelectedGuests();
    
    $("#delete-class-modal").classList.add('hidden');
    $("#class-modal").classList.remove('hidden');
  };
  window.openClassModal = function(dateTimeKey) {
    const classData = state.weeklyPlan.get(dateTimeKey);
    if (!classData) return;
    
    state.selectedClass = classData;
    state.attendees = new Set(classData.attendees); // Load roster from class
    
    $("#class-modal-title").textContent = 'Edit Class';
    $("#modal-class-date").value = classData.date;
    $("#modal-class-time").value = classData.time;
    $("#modal-class-playlist").value = classData.playlist || '';
    $("#modal-class-notes").value = classData.notes || '';
    
    populateModalPlaylistOptions();
    populateModalGuestList();
    renderModalSelectedGuests();
    
    $("#delete-class-modal").classList.remove('hidden');
    $("#class-modal").classList.remove('hidden');
  };
  function populateModalPlaylistOptions() {
    const select = $("#modal-class-playlist");
    select.innerHTML = '<option value="">Select playlist...</option>';
    state.playlists.forEach(pl => {
      const option = document.createElement('option');
      option.value = pl;
      option.textContent = `Playlist #${pl}`;
      select.appendChild(option);
    });
  }
  // --- Guest Selection System ---
  function populateGuestList() {
    const guestList = $("#guest-list");
    guestList.innerHTML = "";
    const sortedGuests = Array.from(state.allGuests).sort();
    
    if (sortedGuests.length === 0) {
      guestList.innerHTML = '<div class="no-selection" style="padding: 20px;">No guests found. Import data to get started.</div>';
      return;
    }
    
    sortedGuests.forEach(guest => {
      const guestElement = document.createElement("div");
      guestElement.className = `guest-list-item ${state.attendees.has(guest) ? 'selected' : ''}`;
      guestElement.dataset.guest = guest;
      guestElement.textContent = guest;
      
      guestElement.addEventListener("click", () => toggleGuestSelection(guest, true));
      guestList.appendChild(guestElement);
    });
  }
  function populateModalGuestList() {
    const modalGuestList = $("#modal-guest-list");
    modalGuestList.innerHTML = "";
    
    Array.from(state.allGuests).sort().forEach(guest => {
      const guestElement = document.createElement("div");
      guestElement.className = `guest-list-item ${state.attendees.has(guest) ? 'selected' : ''}`;
      guestElement.dataset.guest = guest;
      guestElement.textContent = guest;
      
      guestElement.addEventListener("click", () => {
        toggleGuestSelection(guest, false); // don't refresh all on modal toggle
        renderModalSelectedGuests();
        updateModalGuestListSelection();
      });
      modalGuestList.appendChild(guestElement);
    });
  }
  function toggleGuestSelection(guest, refresh = true) {
    if (state.attendees.has(guest)) {
      state.attendees.delete(guest);
    } else {
      state.attendees.add(guest);
    }
    
    if (refresh) {
      renderSelectedGuests();
      updateGuestListSelection();
      refreshAll();
    }
  }
  function renderSelectedGuests() {
    const rosterChips = $("#rosterChips");
    const rosterCountPill = $("#rosterCountPill");
    
    rosterChips.innerHTML = "";
    
    if (state.attendees.size === 0) {
      rosterChips.innerHTML = `<div class="no-selection">No House Guests selected</div>`;
    } else {
      [...state.attendees].sort().forEach(name => {
        const guestChip = document.createElement("div");
        guestChip.className = "selected-guest-item";
        guestChip.innerHTML = `<span>${name}</span><span class="remove-guest" data-guest="${name}">‚úï</span>`;
        guestChip.querySelector(".remove-guest").addEventListener("click", (e) => {
          e.stopPropagation();
          state.attendees.delete(name);
          renderSelectedGuests();
          updateGuestListSelection();
          refreshAll();
        });
        rosterChips.appendChild(guestChip);
      });
    }
    
    rosterCountPill.textContent = `${state.attendees.size} attendee${state.attendees.size !== 1 ? 's' : ''}`;
    updateDashboardStatus();
  }
  function renderModalSelectedGuests() {
    const container = $("#modal-selected-guests");
    container.innerHTML = "";
    
    if (state.attendees.size === 0) {
      container.innerHTML = `<div class="no-selection">No guests selected</div>`;
    } else {
      [...state.attendees].sort().forEach(name => {
        const guestChip = document.createElement("div");
        guestChip.className = "selected-guest-item";
        guestChip.innerHTML = `<span>${name}</span><span class="remove-guest" data-guest="${name}">‚úï</span>`;
        guestChip.querySelector(".remove-guest").addEventListener("click", (e) => {
          e.stopPropagation();
          state.attendees.delete(name);
          renderModalSelectedGuests();
          updateModalGuestListSelection();
        });
        container.appendChild(guestChip);
      });
    }
  }
  function updateGuestListSelection() {
    $$("#guest-list .guest-list-item").forEach(item => {
      item.classList.toggle("selected", state.attendees.has(item.dataset.guest));
    });
  }
  function updateModalGuestListSelection() {
    $$("#modal-guest-list .guest-list-item").forEach(item => {
      item.classList.toggle("selected", state.attendees.has(item.dataset.guest));
    });
  }
  
  // --- Metrics Calculation ---
  function lastHeardMap() {
    const map = new Map();
    state.records.forEach(r => {
      if (!map.has(r.guest)) map.set(r.guest, new Map());
      const pm = map.get(r.guest);
      const prev = pm.get(r.playlist);
      if (!prev || new Date(r.date) > new Date(prev)) {
        pm.set(r.playlist, r.date);
      }
    });
    return map;
  }
  function computeMetrics() {
    const lm = lastHeardMap();
    const roster = [...state.attendees];
    const windowDays = state.selectedWindow;
    const todayISO = formatDateKey(new Date());
    const byPlaylist = state.playlists.map(pl => {
      let never = 0;
      let deltas = [];
      let staleCount = 0;
      roster.forEach(g => {
        const last = lm.get(g)?.get(pl);
        if (!last) {
          never++;
          staleCount++;
        } else {
          const d = daysBetween(todayISO, last);
          deltas.push(d);
          if (d >= windowDays) staleCount++;
        }
      });
      const medianDays = deltas.length ? median(deltas) : 0;
      const stalePct = roster.length ? Math.round((staleCount / roster.length) * 100) : 0;
      // Score: high stale %, high never count are "good" (they need to be heard)
      // Low median is also "good" as it means other songs are fresh, but less important.
      const score = (stalePct * 2) + (never * 3) - (medianDays * 0.1);

      return { playlist: pl, never, median: medianDays, stalePct, score };
    });
    // Sort by score descending
    byPlaylist.sort((a, b) => b.score - a.score);
    return byPlaylist;
  }
  // --- UI Refresh Functions ---
  function refreshAll() {
      const metrics = computeMetrics();
      refreshDashboard(metrics);
      refreshExplorer(metrics);
      updateDashboardStatus();
      saveStateToLocalStorage();
  }
  function refreshDashboard(metrics) {
    const best = metrics[0];
    
    if (!best || state.attendees.size === 0) {
      $("#bestSummary").innerHTML = '<div class="muted">Add attendees above to see the best recommendation.</div>';
      $("#bestNever").textContent = "‚Äî";
      $("#bestMedian").textContent = "‚Äî";
      $("#bestStale").textContent = "‚Äî";
      $("#runnerUps").innerHTML = '<div class="empty-state"><p>Select attendees to see alternatives</p></div>';
      $("#selectPlaylistBtn").disabled = true;
      return;
    }
     $("#selectPlaylistBtn").disabled = false;
    
    $("#bestSummary").innerHTML = `
      <div style="font-size:20px; font-weight:700; margin-top:10px;">
        Playlist <span style="color: var(--accent);">#${best.playlist}</span>
      </div>
      <div class="subtle" style="margin-top:4px;">Optimized for ${state.attendees.size} attendees ‚Ä¢ Stale threshold: ${state.selectedWindow} days</div>
    `;
    
    $("#bestNever").textContent = best.never;
    $("#bestMedian").textContent = best.median;
    $("#bestStale").textContent = best.stalePct + "%";
    
    const runners = metrics.slice(1, 4);
    const wrap = $("#runnerUps");
    wrap.innerHTML = "";
    
    if (runners.length === 0) {
      wrap.innerHTML = '<div class="empty-state"><p>No alternative playlists available</p></div>';
    } else {
      runners.forEach(r => {
        wrap.innerHTML += `
          <div class="card suggestion-card">
            <div class="title">Playlist #${r.playlist}</div>
            <div class="metric-row" style="margin-top:8px;">
              <div class="metric"><div class="value">${r.never}</div><div class="label">Never</div></div>
              <div class="metric"><div class="value">${r.median}</div><div class="label">Median</div></div>
              <div class="metric"><div class="value">${r.stalePct}%</div><div class="label">Stale</div></div>
            </div>
          </div>`;
      });
    }
  }
  function refreshExplorer(metrics) {
    const tbody = $("#explorerTbody");
    tbody.innerHTML = "";
    const { column, ascending } = state.explorerSortOrder;

    metrics.sort((a, b) => {
        if (a[column] < b[column]) return ascending ? -1 : 1;
        if (a[column] > b[column]) return ascending ? 1 : -1;
        return 0;
    });

    metrics.forEach(m => {
      tbody.innerHTML += `
        <tr>
          <td><strong>Playlist #${m.playlist}</strong></td>
          <td>${m.never}</td>
          <td>${m.median}</td>
          <td>${m.stalePct}%</td>
          <td><span class="pill status-info">${m.score.toFixed(1)}</span></td>
        </tr>`;
    });
  }
  function refreshHistory() {
    const tbody = $("#historyTbody");
    const searchTerm = $("#history-search").value.toLowerCase();
    
    const byClass = new Map();
    [...state.records, ...Array.from(state.weeklyPlan.values()).filter(c => c.status === 'finalized')]
    .forEach(r => {
        if (!r.playlist) return;
        const key = `${r.date}T${r.time}::${r.playlist}`;
        if (!byClass.has(key)) {
            byClass.set(key, { date: r.date, time: r.time, playlist: r.playlist, guests: new Set(), status: 'finalized' });
        }
        if (r.guest) {
            byClass.get(key).guests.add(r.guest);
        } else if (r.attendees) {
            r.attendees.forEach(g => byClass.get(key).guests.add(g));
        }
    });

    let rows = [...byClass.values()].filter(row => {
        if (!searchTerm) return true;
        const guestNames = [...row.guests].join(' ').toLowerCase();
        return row.date.includes(searchTerm) || row.playlist.toString().includes(searchTerm) || guestNames.includes(searchTerm);
    });
    
    const { column, ascending } = state.sortOrder;
    rows.sort((a, b) => {
        let aVal, bVal;
        if (column === 'datetime') {
            aVal = new Date(`${a.date}T${a.time}`);
            bVal = new Date(`${b.date}T${b.time}`);
        } else if (column === 'count') {
            aVal = a.guests.size;
            bVal = b.guests.size;
        } else {
            aVal = a[column];
            bVal = b[column];
        }
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
    });

    tbody.innerHTML = "";
    rows.forEach(row => {
      const guestArray = [...row.guests].sort();
      tr = `
        <tr>
          <td>${formatDate(row.date)} ${formatTime(row.time)}</td>
          <td><strong>Playlist #${row.playlist}</strong></td>
          <td><span class="pill">${guestArray.length}</span></td>
          <td>${guestArray.slice(0, 3).join(", ")}${guestArray.length > 3 ? ` +${guestArray.length - 3} more` : ""}</td>
          <td><span class="pill status-finalized">Completed</span></td>
        </tr>
      `;
      tbody.innerHTML += tr;
    });
  }
  function refreshGuests() {
    const container = $("#guests-grid");
    const searchTerm = $("#guest-search-filter").value.toLowerCase();
    
    if (state.allGuests.size === 0) {
      container.innerHTML = `<div class="empty-state"><h3>No guest data available</h3><p>Import data or connect Google Sheets</p></div>`;
      return;
    }
    const guestStats = Array.from(state.allGuests)
      .filter(guest => guest.toLowerCase().includes(searchTerm))
      .map(guest => {
        const guestRecords = state.records.filter(r => r.guest === guest);
        const totalClasses = guestRecords.length;
        const playlistsHeard = new Set(guestRecords.map(r => r.playlist)).size;
        const lastClassDate = guestRecords.length > 0 ? new Date(Math.max(...guestRecords.map(r => new Date(`${r.date}T${r.time}`)))) : null;
        const daysSince = lastClassDate ? daysBetween(new Date(), lastClassDate) : null;
        return { name: guest, totalClasses, playlistsHeard, daysSince, records: guestRecords };
      })
      .sort((a, b) => (b.daysSince ?? 9999) - (a.daysSince ?? 9999)); // Sort by most recent first
    
    container.innerHTML = "";
    guestStats.forEach(guest => {
      const guestCard = document.createElement("div");
      guestCard.className = "guest-card";
      guestCard.dataset.guestName = guest.name;
      guestCard.innerHTML = `
        <div class="guest-card-header">
          <div class="guest-avatar">${guest.name.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
          <div class="guest-info">
            <h4>${guest.name}</h4>
            <p>${guest.daysSince !== null ? `Last seen: ${guest.daysSince} days ago` : 'No classes yet'}</p>
          </div>
        </div>
        <div class="guest-stats">
          <div class="guest-stat"><span class="value">${guest.totalClasses}</span><span class="label">Classes</span></div>
          <div class="guest-stat"><span class="value">${guest.playlistsHeard}</span><span class="label">Playlists</span></div>
        </div>`;
      guestCard.addEventListener('click', () => showGuestDetailModal(guest.name));
      container.appendChild(guestCard);
    });
  }
  function showGuestDetailModal(guestName) {
      const guestRecords = state.records
          .filter(r => r.guest === guestName)
          .sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));
      
      $('#guest-modal-title').textContent = `${guestName}'s Profile`;
      
      let contentHTML = `<div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Playlist</th></tr></thead><tbody>`;
      if (guestRecords.length > 0) {
          guestRecords.forEach(record => {
              contentHTML += `<tr><td>${formatDateTime(record.date, record.time)}</td><td>Playlist #${record.playlist}</td></tr>`;
          });
      } else {
          contentHTML += `<tr><td colspan="2" style="text-align:center;">No class history found.</td></tr>`;
      }
      contentHTML += `</tbody></table></div>`;
      
      $('#guest-modal-content').innerHTML = contentHTML;
      $('#guest-modal').classList.remove('hidden');
  }

  // --- EVENT LISTENERS ---
  function addEventListeners() {
      // Tab navigation
      $$('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
              const tab = btn.dataset.tab;
              $$('.tab-btn').forEach(b => b.setAttribute('aria-selected', 'false'));
              btn.setAttribute('aria-selected', 'true');
              $$('main > section').forEach(s => s.classList.add('hidden'));
              $(`#${tab}`).classList.remove('hidden');

              // Refresh content on tab switch
              if(tab === 'weekly') renderWeeklyCalendar();
              if(tab === 'history') refreshHistory();
              if(tab === 'guests') refreshGuests();
              if(tab === 'explorer') refreshAll();
          });
      });
      // Dashboard controls
      $('#class-date-dashboard').addEventListener('change', (e) => {
          state.selectedDate = e.target.value;
          updateDashboardStatus();
      });
      $('#class-time-dashboard').addEventListener('change', (e) => {
          state.selectedTime = e.target.value;
          updateDashboardStatus();
      });
      $('#todayBtn').addEventListener('click', () => {
          const now = new Date();
          state.selectedDate = formatDateKey(now);
          state.selectedTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          $('#class-date-dashboard').value = state.selectedDate;
          $('#class-time-dashboard').value = state.selectedTime;
          updateDashboardStatus();
      });
      $('#playlistWindow').addEventListener('change', (e) => {
          state.selectedWindow = parseInt(e.target.value, 10);
          refreshAll();
      });
      $('#saveDraftBtn').addEventListener('click', saveDraftClass);
      $('#finalizeBtn').addEventListener('click', finalizeClass);
      
      $('#selectPlaylistBtn').addEventListener('click', () => {
        const metrics = computeMetrics();
        const bestPlaylist = metrics[0]?.playlist;
        if(bestPlaylist) {
          saveDraftClass(); // This will use the best playlist
        } else {
          showToast('Cannot select playlist, no recommendation available.', 'error');
        }
      });
      
      // Guest search
      $('#guest-search').addEventListener("input", (e) => {
          const term = e.target.value.toLowerCase();
          $$("#guest-list .guest-list-item").forEach(item => {
              item.style.display = item.dataset.guest.toLowerCase().includes(term) ? '' : 'grid';
          });
      });
      $('#guest-search-filter').addEventListener('input', refreshGuests);
      $('#history-search').addEventListener('input', refreshHistory);

      // Sorting table headers
      $$('#history-table .sortable, #explorer thead .sortable').forEach(header => {
          header.addEventListener('click', () => {
              const sortKey = header.dataset.sort;
              const isExplorer = header.closest('#explorer');
              const sortState = isExplorer ? state.explorerSortOrder : state.sortOrder;

              if (sortState.column === sortKey) {
                  sortState.ascending = !sortState.ascending;
              } else {
                  sortState.column = sortKey;
                  sortState.ascending = false;
              }
              
              $$('.sortable').forEach(h => h.classList.remove('asc', 'desc'));
              header.classList.add(sortState.ascending ? 'asc' : 'desc');
              
              if (isExplorer) refreshExplorer(computeMetrics()); else refreshHistory();
          });
      });

      // Weekly Planner Navigation
      $('#prevWeekBtn').addEventListener('click', () => navigateWeek(-1));
      $('#currentWeekBtn').addEventListener('click', () => navigateWeek(0));
      $('#nextWeekBtn').addEventListener('click', () => navigateWeek(1));

      // Settings Buttons
      $('#testConnectionBtn').addEventListener('click', testConnection);
      $('#refreshDataBtn').addEventListener('click', loadDataFromSheets);
      $('#syncFromSheetsBtn').addEventListener('click', loadDataFromSheets);
      $('#clearDataBtn').addEventListener('click', () => {
          if (confirm('Are you sure you want to delete ALL local data? This cannot be undone.')) {
              localStorage.removeItem('hiloPlaylistData');
              state.records = [];
              state.allGuests.clear();
              state.weeklyPlan.clear();
              window.location.reload();
          }
      });
      $('#importCsvBtn').addEventListener('click', () => $('#fileInput').click());
      $('#exportCsvBtn').addEventListener('click', exportToCsv);
      $('#fileInput').addEventListener('change', handleCsvImport);

      // Modals
      $('#close-class-modal, #cancel-modal').addEventListener('click', () => $('#class-modal').classList.add('hidden'));
      $('#close-guest-modal').addEventListener('click', () => $('#guest-modal').classList.add('hidden'));
      $('#save-draft-modal').addEventListener('click', handleModalSave);
      $('#finalize-modal').addEventListener('click', handleModalFinalize);
      $('#delete-class-modal').addEventListener('click', handleModalDelete);
  }

  // --- Modal Handlers ---
  function handleModalSave() {
      const cls = state.selectedClass;
      if (!cls) return;
      if (state.attendees.size === 0) {
          showToast('Please select at least one guest.', 'error');
          return;
      }
      const newPlaylist = $('#modal-class-playlist').value;
      if (!newPlaylist) {
          showToast('Please select a playlist.', 'error');
          return;
      }

      // Remove old entry if date/time changed
      const oldKey = createDateTimeKey(cls.date, cls.time);
      const newKey = createDateTimeKey($('#modal-class-date').value, $('#modal-class-time').value);
      if (oldKey !== newKey) {
          state.weeklyPlan.delete(oldKey);
      }

      cls.date = $('#modal-class-date').value;
      cls.time = $('#modal-class-time').value;
      cls.playlist = parseInt(newPlaylist, 10);
      cls.attendees = new Set(state.attendees);
      cls.notes = $('#modal-class-notes').value;
      cls.status = 'draft';
      cls.synced = false;

      state.weeklyPlan.set(newKey, cls);
      saveStateToLocalStorage();
      renderWeeklyCalendar();
      showToast('Draft saved!', 'success');
      $('#class-modal').classList.add('hidden');
  }

  async function handleModalFinalize() {
      const cls = state.selectedClass;
      if (!cls || state.attendees.size === 0 || !$('#modal-class-playlist').value) {
          showToast('Please select attendees and a playlist.', 'error');
          return;
      }
      setLoading($('#finalize-modal'), true);
      
      // Update class data from modal before finalizing
      const oldKey = createDateTimeKey(cls.date, cls.time);
      cls.date = $('#modal-class-date').value;
      cls.time = $('#modal-class-time').value;
      cls.playlist = parseInt($('#modal-class-playlist').value, 10);
      cls.attendees = new Set(state.attendees);
      cls.notes = $('#modal-class-notes').value;
      cls.status = 'finalized';

      const synced = await writeToSheets(cls);
      if (synced) {
          cls.synced = true;
          if (oldKey !== createDateTimeKey(cls.date, cls.time)) {
              state.weeklyPlan.delete(oldKey);
          }
          state.weeklyPlan.set(createDateTimeKey(cls.date, cls.time), cls);

          // Add to local records
          cls.attendees.forEach(guest => {
              state.records.push({ date: cls.date, time: cls.time, guest: guest, playlist: cls.playlist });
          });

          saveStateToLocalStorage();
          renderWeeklyCalendar();
          refreshHistory();
          refreshGuests();
          showToast('Class finalized and synced!', 'success');
          $('#class-modal').classList.add('hidden');
      } else {
          cls.status = 'draft'; // Revert on failure
          showToast('Sync failed. Class saved as draft.', 'error');
      }
      setLoading($('#finalize-modal'), false);
  }
 function handleModalDelete() {
    const cls = state.selectedClass;
    if (!cls) return;
    if (confirm('Are you sure you want to delete this class?')) {
        const key = createDateTimeKey(cls.date, cls.time);
        state.weeklyPlan.delete(key);
        saveStateToLocalStorage();
        renderWeeklyCalendar();
        showToast('Class deleted.', 'info');
        $('#class-modal').classList.add('hidden');
    }
}
  // --- CSV Import/Export ---
  function exportToCsv() {
      if (state.records.length === 0) {
          showToast('No data to export.', 'info');
          return;
      }
      const headers = ['Date', 'Time', 'Guest', 'Playlist'];
      const csvRows = [headers.join(',')];
      state.records.forEach(r => {
          csvRows.push([r.date, r.time, `"${r.guest}"`, r.playlist].join(','));
      });
      const csvString = csvRows.join('\r\n');
      const blob = new Blob([csvString], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hilo_playlist_export_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV export complete.', 'success');
  }

  function handleCsvImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
          const text = e.target.result;
          const rows = text.split('\n').slice(1); // Skip header
          let importedCount = 0;
          rows.forEach(row => {
              const cols = row.trim().split(',');
              if (cols.length >= 4) {
                  const [date, time, guest, playlist] = cols;
                  if (date && guest && playlist) {
                      state.records.push({ date, time, guest: guest.replace(/"/g, ''), playlist: parseInt(playlist) });
                      state.allGuests.add(guest.replace(/"/g, ''));
                      importedCount++;
                  }
              }
          });
          saveStateToLocalStorage();
          populateGuestList();
          refreshAll();
          showToast(`Imported ${importedCount} records.`, 'success');
      };
      reader.readAsText(file);
      $('#fileInput').value = ''; // Reset for next import
  }
  // --- Start the App ---
  document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>