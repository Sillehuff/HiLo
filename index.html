<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111814">
  <meta name="apple-mobile-web-app-title" content="Hilo">
  
  <title>Hilo Playlist</title>
  
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%2316231d'><circle cx='256' cy='256' r='220' stroke='%23c9a15d' stroke-width='30' fill='none'/><path d='M150 320C180 200 230 160 256 160C300 160 340 200 362 320' stroke='%23c9a15d' stroke-width='40' stroke-linecap='round'/><path d='M130 390H382' stroke='%23c9a15d' stroke-width='30' stroke-linecap='round'/></svg>">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><circle cx='24' cy='24' r='22' stroke='%23c9a15d' stroke-width='2' fill='none'/><path d='M14 30C16 20 20 16 24 16C28 16 32 20 34 30' stroke='%23c9a15d' stroke-width='3' stroke-linecap='round'/><path d='M12 36H36' stroke='%23c9a15d' stroke-width='2' stroke-linecap='round'/></svg>" />
  
  <style>
    :root {
      --bg-grad-start: #0d1512;
      --bg-grad-mid: #16231d;
      --bg-grad-end: #1b2d25;
      --accent: #d4af37;
      --accent-dim: rgba(212, 175, 55, 0.2);
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.55);
      --glass-bg: rgba(30, 40, 35, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --blur-amt: 25px;
      --radius: 20px;
      --safe-top: env(safe-area-inset-top, 20px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
      --success: #32d74b;
      --warning: #ff9f0a;
      --danger: #ff453a;
    }

    html { height: 100%; overflow: hidden; }
    body {
      margin: 0; padding: 0;
      background: linear-gradient(180deg, var(--bg-grad-start) 0%, var(--bg-grad-mid) 40%, var(--bg-grad-end) 100%);
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      height: 100%; overflow-y: auto;
      -webkit-overflow-scrolling: touch; overscroll-behavior-y: none;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    button, input, select { font-family: inherit; }

    h1, h2, h3 { margin: 0; font-weight: 700; letter-spacing: -0.5px; }
    .subtle { font-size: 13px; color: var(--text-muted); }

    .app-frame { display: flex; flex-direction: column; min-height: 100%; padding-bottom: calc(80px + var(--safe-bottom)); }
    .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 20px; }

    .nav {
      position: sticky; top: 0; z-index: 100;
      padding-top: max(12px, var(--safe-top)); padding-bottom: 12px;
      background: rgba(13, 21, 18, 0.85);
      backdrop-filter: blur(var(--blur-amt)); -webkit-backdrop-filter: blur(var(--blur-amt));
      border-bottom: 1px solid var(--glass-border);
    }
    .nav-content { display: flex; flex-direction: column; gap: 12px; max-width: 600px; margin: 0 auto; padding: 0 16px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 17px; color: var(--accent); }
    .brand svg { width: 24px; height: 24px; }
    .tabs-scroller { width: 100%; overflow-x: auto; scrollbar-width: none; }
    .tabs-scroller::-webkit-scrollbar { display: none; }
    .tabs { display: flex; gap: 8px; padding-bottom: 4px; }
    .tab-btn {
      white-space: nowrap; padding: 8px 18px; border-radius: 100px;
      background: rgba(255,255,255,0.05); border: none; color: var(--text-muted);
      font-size: 13px; font-weight: 600; transition: all 0.25s;
    }
    .tab-btn[aria-selected="true"] { background: var(--accent); color: #000; box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); }

    .card {
      background: var(--glass-bg); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
      border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .hero {
      text-align: center; padding: 24px 20px;
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border); border-radius: var(--radius);
    }

    input[type="text"], input[type="date"], input[type="time"], select {
      font-size: 16px !important; background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border); color: white; padding: 14px;
      border-radius: 14px; width: 100%; appearance: none; outline: none; transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--accent); }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 16px; border-radius: 14px; font-weight: 600; font-size: 16px;
      border: none; cursor: pointer; transition: transform 0.1s, opacity 0.2s; width: 100%; touch-action: manipulation;
    }
    .btn:active { transform: scale(0.97); opacity: 0.9; }
    .btn-primary { background: var(--accent); color: #111; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--danger); }
    .btn-success { background: var(--success); color: #000; }

    .fab {
      position: fixed; bottom: calc(20px + var(--safe-bottom)); right: 20px;
      width: 56px; height: 56px; border-radius: 50%; background: var(--accent); color: #000;
      font-size: 28px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4); z-index: 90; transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.9); }

    .guest-area { background: rgba(0,0,0,0.2); border-radius: 14px; padding: 14px; border: 1px solid var(--glass-border); }
    .chips-wrap { display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; margin-bottom: 12px; }
    .chip {
      background: var(--accent-dim); border: 1px solid rgba(212, 175, 55, 0.3);
      color: #fff; padding: 6px 12px; border-radius: 20px;
      font-size: 14px; display: flex; align-items: center; gap: 6px;
    }
    .list-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;
      max-height: 240px; overflow-y: auto; padding-top: 8px; border-top: 1px solid var(--glass-border);
    }
    .list-item {
      background: rgba(255,255,255,0.05); padding: 12px 8px; border-radius: 10px;
      font-size: 13px; text-align: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: background 0.2s;
    }
    .list-item.active { background: var(--accent); color: #000; font-weight: 700; }

    .cal-entry {
      background: rgba(255,255,255,0.07); padding: 16px; margin-bottom: 10px; border-radius: 14px;
      display: flex; justify-content: space-between; align-items: center; border-left: 4px solid transparent;
    }
    .cal-entry.draft { border-color: var(--warning); }
    .cal-entry.final { border-color: var(--success); }

    .metric-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
    .metric-box { background: rgba(0,0,0,0.3); padding: 16px 8px; border-radius: 14px; text-align: center; }
    .metric-val { font-size: 22px; font-weight: 800; color: #fff; }
    .metric-lbl { font-size: 11px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    .modal-backdrop {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(6px);
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
      display: flex; flex-direction: column; justify-content: flex-end;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: auto; }
    .modal-sheet {
      background: #1b2621; border-top: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0; padding: 24px 20px calc(20px + var(--safe-bottom));
      width: 100%; max-height: 92vh; overflow-y: auto;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
    }
    .modal-backdrop.open .modal-sheet { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .close-icon { font-size: 24px; background: rgba(255,255,255,0.1); width: 32px; height: 32px; border-radius: 50%; display:flex; align-items:center; justify-content:center; color:#fff; border:none; }

    .hidden { display: none !important; }
    .pill { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    .pill-warn { background: rgba(255, 159, 10, 0.2); color: var(--warning); }
    .pill-ok { background: rgba(50, 215, 75, 0.2); color: var(--success); }

    .table-container { overflow-x: auto; border-radius: 14px; border: 1px solid var(--glass-border); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 14px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
    th { background: rgba(0,0,0,0.4); color: var(--accent); font-size: 12px; font-weight: 700; text-transform: uppercase; }

    #toast-area { position: fixed; top: var(--safe-top); left: 0; right: 0; padding: 20px; z-index: 300; pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .toast { pointer-events: auto; background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 14px; font-weight: 600; border: 1px solid var(--glass-border); animation: slideDown 0.3s ease-out; }
    .toast.success { background: #1b3a24; color: var(--success); border-color: var(--success); }
    .toast.error { background: #3a1b1b; color: var(--danger); border-color: var(--danger); }
    @keyframes slideDown { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
    body.ios-locked { overflow: hidden; position: fixed; width: 100%; }
  </style>
</head>
<body>

  <div class="app-frame">
    <nav class="nav">
      <div class="nav-content">
        <div class="brand">
          <svg viewBox="0 0 48 48" fill="none" stroke="#d4af37">
            <circle cx="24" cy="24" r="22" stroke-width="2"/>
            <path d="M14 30C16 20 20 16 24 16C28 16 32 20 34 30" stroke-width="3" stroke-linecap="round"/>
          </svg>
          <span>Hilo</span>
        </div>
        <div class="tabs-scroller">
          <div class="tabs" role="tablist">
            <button class="tab-btn" aria-selected="true" data-tab="dashboard">Dashboard</button>
            <button class="tab-btn" aria-selected="false" data-tab="weekly">Planner</button>
            <button class="tab-btn" aria-selected="false" data-tab="explorer">Explorer</button>
            <button class="tab-btn" aria-selected="false" data-tab="history">History</button>
            <button class="tab-btn" aria-selected="false" data-tab="settings">Settings</button>
          </div>
        </div>
      </div>
    </nav>

    <main class="container">
      <section id="dashboard" class="fade-in">
        <div class="hero">
          <h1 id="greeting">Hello</h1>
          <div class="subtle" id="currentDateTime">...</div>
          <div id="conn-status" class="pill pill-warn" style="margin-top:8px; display:inline-block;">Offline</div>
        </div>

        <div class="card">
          <h2 style="font-size:18px; margin-bottom:4px;">Who's Here?</h2>
          <p class="subtle" style="margin-bottom:16px;">Select attendees to optimize the playlist.</p>
          
          <div class="guest-area">
            <input type="text" id="dash-search" placeholder="Search guests..." autocomplete="off">
            <div id="dash-chips" class="chips-wrap" style="margin-top:12px;"><span class="subtle">Empty room...</span></div>
            <div id="dash-list" class="list-grid"></div>
          </div>

          <div id="rec-box" class="hidden" style="margin-top: 24px; border-top: 1px solid var(--glass-border); padding-top: 20px;">
            <div style="text-align:center;">
                <div class="subtle" style="text-transform:uppercase; letter-spacing:1px; color:var(--accent);">Best Match</div>
                <div style="font-size:24px; font-weight:800; color:#fff; text-shadow:0 0 20px rgba(212,175,55,0.3); margin: 10px 0; line-height:1.2;">
                  <span id="rec-id">--</span>
                </div>
            </div>

            <div class="metric-row">
              <div class="metric-box">
                <div class="metric-val" id="rec-never">0</div>
                <div class="metric-lbl">New To</div>
              </div>
              <div class="metric-box">
                <div class="metric-val" id="rec-median">0</div>
                <div class="metric-lbl">Avg Days</div>
              </div>
              <div class="metric-box">
                <div class="metric-val" id="rec-stale">0%</div>
                <div class="metric-lbl">Stale</div>
              </div>
            </div>

            <button id="btn-quick-add" class="btn btn-primary">üìÖ Schedule This Mix</button>
            
            <div style="margin-top:20px;">
                <p class="subtle" style="margin-bottom:8px; font-size:11px; font-weight:700;">RUNNER UPS</p>
                <div id="rec-alts" style="display:flex; gap:10px; overflow-x:auto; padding-bottom:4px;"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="weekly" class="hidden">
        <div class="hero" style="display:flex; justify-content:space-between; align-items:center; text-align:left;">
          <div>
            <h1>Planner</h1>
            <div class="subtle" id="week-label">--</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button class="btn btn-secondary" style="padding:10px 16px;" id="prevWeek">‚Üê</button>
            <button class="btn btn-secondary" style="padding:10px 16px;" id="nextWeek">‚Üí</button>
          </div>
        </div>
        <div id="cal-container" style="margin-top:10px;"></div>
        <p id="cal-empty" class="subtle" style="text-align:center; padding:40px; display:none;">No classes this week.</p>
        <div class="fab" id="fab-add">+</div>
      </section>

      <section id="explorer" class="hidden">
        <div class="card">
          <h2 style="font-size:18px;">Playlist Metrics</h2>
          <p class="subtle" style="margin-bottom:16px;">Analysis based on current dashboard selection.</p>
          <div class="table-container">
            <table>
              <thead><tr><th>Playlist</th><th>New</th><th>Med</th><th>Scr</th></tr></thead>
              <tbody id="expl-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="history" class="hidden">
        <div class="card">
          <input type="text" id="hist-search" placeholder="Search history..." style="margin-bottom:16px;">
          <div class="table-container">
            <table>
              <thead><tr><th>Date</th><th>Mix</th><th>Guest</th></tr></thead>
              <tbody id="hist-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="settings" class="hidden">
        <div class="card">
          <h2 style="font-size:18px;">Data Sync</h2>
          <p class="subtle" style="margin-bottom:20px;">Google Sheets Integration</p>
          <div style="display:grid; gap:14px;">
            <button id="btn-test" class="btn btn-secondary">Test Connection (Auto-Syncs)</button>
            <button id="btn-pull" class="btn btn-secondary">‚¨á Force Pull from Sheets</button>
            <button id="btn-import" class="btn btn-secondary">üìÇ Import CSV</button>
            <button id="btn-nuke" class="btn btn-danger">Reset Local Data</button>
            <input type="file" id="csv-file" accept=".csv" class="hidden">
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--glass-border); text-align:center;">
                <p class="subtle">Version 2.2 (Dynamic Playlist Support)</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal-sheet">
      <div class="modal-header">
        <h3 id="modal-title">Plan Class</h3>
        <button class="close-icon" id="modal-close">‚úï</button>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:20px;">
        <div>
          <label class="subtle" style="margin-bottom:6px; display:block;">Date</label>
          <input type="date" id="m-date">
        </div>
        <div>
          <label class="subtle" style="margin-bottom:6px; display:block;">Time</label>
          <input type="time" id="m-time">
        </div>
      </div>
      <div style="margin-bottom:24px;">
        <label class="subtle" style="margin-bottom:6px; display:block;">Playlist</label>
        <select id="m-playlist">
          <option value="">Select Playlist...</option>
        </select>
      </div>
      <div style="margin-bottom:30px;">
         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label class="subtle">Attendees (<span id="m-count">0</span>)</label>
            <button id="m-copy" style="background:none; border:none; color:var(--accent); font-weight:600; font-size:13px;">+ Add Dashboard Guests</button>
         </div>
         <div class="guest-area">
            <div id="m-chips" class="chips-wrap"></div>
            <input type="text" id="m-search" placeholder="Add guest..." style="margin-bottom:8px;">
            <div id="m-list" class="list-grid" style="max-height:160px;"></div>
         </div>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <button id="m-delete" class="btn btn-danger hidden">Delete</button>
        <button id="m-save" class="btn btn-secondary">Save Draft</button>
        <button id="m-final" class="btn btn-success" style="grid-column: 1 / -1; padding: 18px;">‚úî Finalize & Sync</button>
      </div>
    </div>
  </div>
  <div id="toast-area"></div>

<script>
/**
 * Hilo Playlist App - v2.2
 * Changes: Dynamic Playlist Strings + Auto-Sync on Connect
 */

const CONFIG = {
    scriptUrl: 'https://script.google.com/macros/s/AKfycbyp5q-4rIC2XHa60ZnYS2x0bZrxDmNYAV3YvOf5EmxnnVqW2nAKEq6Em6UWgCy8ftULgQ/exec',
    token: '4c94713e-9b2b-4980-8b07-2b3948f6f6a1'
};

const store = {
    selected: new Set(),
    guests: new Set(),
    history: [],
    plans: new Map(),
    weekStart: getMonday(new Date()),
    editId: null,
    modalGuests: new Set(),
    connected: false,
    playlists: new Set() // Stores dynamic playlist names
};

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    initUI();
    updateClock();
    checkConnectivity(); // Auto-check & Auto-Pull
    setInterval(updateClock, 60000);
});

// --- DATA LAYER ---
function loadData() {
    try {
        const raw = localStorage.getItem('hilo_v2');
        if (raw) {
            const d = JSON.parse(raw);
            store.history = d.history || [];
            store.guests = new Set(d.guests || []);
            if (d.plans) {
                d.plans.forEach(([k, v]) => {
                    v.attendees = new Set(v.attendees);
                    store.plans.set(k, v);
                });
            }
            // Rebuild known playlists from history
            rebuildPlaylistSet();
        }
        // Add defaults if empty
        if(store.playlists.size === 0) {
            for(let i=1; i<=12; i++) store.playlists.add(String(i));
        }
    } catch (e) { console.error("Storage load fail", e); }
    
    refreshPlaylistDropdown();
}

function rebuildPlaylistSet() {
    store.playlists.clear();
    // Add defaults (1-12)
    for(let i=1; i<=12; i++) store.playlists.add(String(i));
    // Add from history (handles strings like "90s HipHop")
    store.history.forEach(r => {
        if(r.playlist) store.playlists.add(String(r.playlist));
    });
}

function refreshPlaylistDropdown() {
    const sel = document.getElementById('m-playlist');
    sel.innerHTML = '<option value="">Select Playlist...</option>';
    
    // Sort: Try to sort numerically if possible, otherwise alphabetically
    const sorted = Array.from(store.playlists).sort((a,b) => {
        const numA = parseFloat(a), numB = parseFloat(b);
        if(!isNaN(numA) && !isNaN(numB)) return numA - numB;
        return a.localeCompare(b);
    });

    sorted.forEach(p => {
        // Display Name Logic: If it's just a number, say "Playlist #X", else show name
        const display = !isNaN(parseFloat(p)) && isFinite(p) ? `Playlist #${p}` : p;
        sel.innerHTML += `<option value="${p}">${display}</option>`;
    });
}

function saveData() {
    try {
        const d = {
            history: store.history,
            guests: Array.from(store.guests),
            plans: Array.from(store.plans.entries())
        };
        localStorage.setItem('hilo_v2', JSON.stringify(d));
    } catch (e) { toast('Storage Full/Error', 'error'); }
}

// --- UI RENDERING ---
function initUI() {
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.onclick = () => {
            document.querySelectorAll('.tab-btn').forEach(t => t.setAttribute('aria-selected', false));
            b.setAttribute('aria-selected', true);
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            const tid = b.dataset.tab;
            document.getElementById(tid).classList.remove('hidden');
            if(tid === 'weekly') renderCalendar();
            if(tid === 'explorer') renderExplorer();
            if(tid === 'history') renderHistory();
        };
    });

    const dSearch = document.getElementById('dash-search');
    dSearch.addEventListener('input', () => renderDashboardList(dSearch.value));
    const mSearch = document.getElementById('m-search');
    mSearch.addEventListener('input', () => renderModalList(mSearch.value));
    document.getElementById('hist-search').addEventListener('input', renderHistory);

    document.getElementById('prevWeek').onclick = () => changeWeek(-7);
    document.getElementById('nextWeek').onclick = () => changeWeek(7);
    document.getElementById('fab-add').onclick = () => openModal();

    document.getElementById('modal-close').onclick = closeModal;
    document.getElementById('m-copy').onclick = () => {
        store.selected.forEach(g => store.modalGuests.add(g));
        renderModalChips(); renderModalList();
    };
    document.getElementById('m-save').onclick = () => commitClass('draft');
    document.getElementById('m-final').onclick = () => commitClass('final');
    document.getElementById('m-delete').onclick = deleteClass;
    
    document.getElementById('btn-quick-add').onclick = () => {
        const pl = document.getElementById('rec-id').innerText;
        openModal({ playlist: pl, attendees: store.selected });
    };

    document.getElementById('btn-test').onclick = checkConnectivity;
    document.getElementById('btn-pull').onclick = pullSheets;
    document.getElementById('btn-nuke').onclick = () => {
        if(confirm("Reset all data?")) { localStorage.removeItem('hilo_v2'); location.reload(); }
    };
    document.getElementById('btn-import').onclick = () => document.getElementById('csv-file').click();
    document.getElementById('csv-file').onchange = parseCSV;

    renderDashboardList();
    renderDashboardChips();
}

// --- CORE LOGIC ---
function renderDashboardList(filter = '') {
    const list = document.getElementById('dash-list');
    list.innerHTML = '';
    const term = filter.toLowerCase();
    Array.from(store.guests).sort().forEach(g => {
        if(g.toLowerCase().includes(term)) {
            const isActive = store.selected.has(g);
            const el = document.createElement('div');
            el.className = `list-item ${isActive ? 'active' : ''}`;
            el.textContent = g;
            el.onclick = () => {
                if(store.selected.has(g)) store.selected.delete(g);
                else store.selected.add(g);
                renderDashboardList(term);
                renderDashboardChips();
                calcRecs();
            };
            list.appendChild(el);
        }
    });
}

function renderDashboardChips() {
    const box = document.getElementById('dash-chips');
    if(store.selected.size === 0) {
        box.innerHTML = '<span class="subtle">Empty room...</span>';
        document.getElementById('rec-box').classList.add('hidden');
        return;
    }
    box.innerHTML = '';
    store.selected.forEach(g => {
        const c = document.createElement('div');
        c.className = 'chip';
        c.innerHTML = `${g} <span style="opacity:0.6">√ó</span>`;
        c.onclick = () => {
            store.selected.delete(g);
            renderDashboardList(document.getElementById('dash-search').value);
            renderDashboardChips();
            calcRecs();
        };
        box.appendChild(c);
    });
    calcRecs();
}

function calcRecs() {
    if(store.selected.size === 0) return;
    document.getElementById('rec-box').classList.remove('hidden');

    // Map: Guest -> Map(PlaylistString -> DateStr)
    const guestHist = new Map(); 
    store.history.forEach(r => {
        const pStr = String(r.playlist); // Normalize to string
        if(!guestHist.has(r.guest)) guestHist.set(r.guest, new Map());
        const pm = guestHist.get(r.guest);
        if(!pm.has(pStr) || new Date(r.date) > new Date(pm.get(pStr))) {
            pm.set(pStr, r.date);
        }
    });

    const scores = [];
    // Iterate over ALL known playlists (strings included)
    store.playlists.forEach(plID => {
        let never = 0, stale = 0;
        let days = [];
        
        store.selected.forEach(g => {
            const last = guestHist.get(g)?.get(plID);
            if(!last) {
                never++; stale++;
            } else {
                const diff = Math.floor((new Date() - new Date(last))/(86400000));
                days.push(diff);
                if(diff > 45) stale++;
            }
        });

        days.sort((a,b)=>a-b);
        const median = days.length ? days[Math.floor(days.length/2)] : 0;
        const staleRate = Math.round((stale / store.selected.size) * 100);
        // Score Algo
        const score = (staleRate * 2) + (never * 4) + (median * 0.2);
        scores.push({ id: plID, never, median, staleRate, score });
    });

    scores.sort((a,b) => b.score - a.score);
    const top = scores[0];

    // Format Display Name for Top Pick
    const topName = !isNaN(parseFloat(top.id)) && isFinite(top.id) ? `Playlist #${top.id}` : top.id;
    document.getElementById('rec-id').innerText = topName;
    
    document.getElementById('rec-never').innerText = top.never;
    document.getElementById('rec-median').innerText = top.median;
    document.getElementById('rec-stale').innerText = top.staleRate + '%';

    const alts = document.getElementById('rec-alts');
    alts.innerHTML = '';
    scores.slice(1, 4).forEach(s => {
        const d = document.createElement('div');
        d.className = 'metric-box';
        d.style.minWidth = '80px';
        // Shorten name for runner up bubbles
        let shortName = s.id.length > 8 ? s.id.substring(0,6)+'..' : s.id;
        if(!isNaN(parseFloat(s.id))) shortName = `#${s.id}`;

        d.innerHTML = `<div style="color:var(--accent); font-weight:bold; font-size:11px;">${shortName}</div><div class="metric-lbl">${s.staleRate}%</div>`;
        alts.appendChild(d);
    });
    return scores; 
}

// --- WEEKLY PLANNER ---
function renderCalendar() {
    const con = document.getElementById('cal-container');
    con.innerHTML = '';
    const start = new Date(store.weekStart);
    const end = new Date(start); end.setDate(end.getDate() + 6);
    document.getElementById('week-label').innerText = 
        `${start.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${end.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;

    let hasData = false;
    for(let i=0; i<7; i++) {
        const curr = new Date(start);
        curr.setDate(curr.getDate() + i);
        const key = curr.toISOString().split('T')[0];
        
        const dayPlans = Array.from(store.plans.values())
            .filter(p => p.date === key)
            .sort((a,b) => a.time.localeCompare(b.time));
        
        if(dayPlans.length) {
            hasData = true;
            const wrap = document.createElement('div');
            wrap.innerHTML = `<div class="subtle" style="margin:16px 0 8px 4px; font-weight:700;">${curr.toLocaleDateString('en-US',{weekday:'long'})}</div>`;
            dayPlans.forEach(p => {
                const el = document.createElement('div');
                el.className = `cal-entry ${p.status === 'draft' ? 'draft' : 'final'}`;
                el.onclick = () => openModal({ id: p.id });
                
                // Display Name Check
                const plName = !isNaN(parseFloat(p.playlist)) ? `Playlist #${p.playlist}` : p.playlist;

                el.innerHTML = `
                    <div>
                        <div style="font-size:16px; font-weight:700; margin-bottom:4px;">${fmtTime(p.time)} ‚Ä¢ ${plName}</div>
                        <div class="subtle">${p.attendees.size} Guests ‚Ä¢ ${p.status.toUpperCase()}</div>
                    </div>
                    <div style="opacity:0.3">‚Ä∫</div>
                `;
                wrap.appendChild(el);
            });
            con.appendChild(wrap);
        }
    }
    document.getElementById('cal-empty').style.display = hasData ? 'none' : 'block';
}

function changeWeek(days) {
    store.weekStart.setDate(store.weekStart.getDate() + days);
    renderCalendar();
}

// --- MODAL SYSTEM ---
function openModal(opts = {}) {
    const now = new Date();
    store.editId = opts.id || null;
    
    if(opts.id) {
        const p = store.plans.get(opts.id);
        document.getElementById('m-date').value = p.date;
        document.getElementById('m-time').value = p.time;
        document.getElementById('m-playlist').value = p.playlist;
        store.modalGuests = new Set(p.attendees);
        
        document.getElementById('m-delete').classList.remove('hidden');
        document.getElementById('modal-title').innerText = "Edit Class";
        const draftBtn = document.getElementById('m-save');
        if(p.status === 'final') {
            draftBtn.disabled = true; draftBtn.innerText = "Finalized";
        } else {
            draftBtn.disabled = false; draftBtn.innerText = "Save Draft";
        }
    } else {
        document.getElementById('m-date').value = opts.date || now.toISOString().split('T')[0];
        document.getElementById('m-time').value = opts.time || '09:00';
        document.getElementById('m-playlist').value = opts.playlist || '';
        store.modalGuests = new Set(opts.attendees || []);
        
        document.getElementById('m-delete').classList.add('hidden');
        document.getElementById('modal-title').innerText = "Plan Class";
        document.getElementById('m-save').disabled = false;
        document.getElementById('m-save').innerText = "Save Draft";
    }
    renderModalChips();
    renderModalList();
    document.getElementById('modal-backdrop').classList.add('open');
    document.body.classList.add('ios-locked');
}

function closeModal() {
    document.getElementById('modal-backdrop').classList.remove('open');
    document.body.classList.remove('ios-locked');
}

function renderModalChips() {
    const con = document.getElementById('m-chips');
    document.getElementById('m-count').innerText = store.modalGuests.size;
    con.innerHTML = '';
    store.modalGuests.forEach(g => {
        const c = document.createElement('div');
        c.className = 'chip';
        c.innerHTML = `${g} <span style="opacity:0.6">√ó</span>`;
        c.onclick = () => { store.modalGuests.delete(g); renderModalChips(); renderModalList(); };
        con.appendChild(c);
    });
}

function renderModalList(filter='') {
    const list = document.getElementById('m-list');
    list.innerHTML = '';
    const term = filter.toLowerCase();
    Array.from(store.guests).sort().forEach(g => {
        if(!store.modalGuests.has(g) && g.toLowerCase().includes(term)) {
            const d = document.createElement('div');
            d.className = 'list-item';
            d.innerText = g;
            d.onclick = () => { store.modalGuests.add(g); renderModalChips(); renderModalList(filter); };
            list.appendChild(d);
        }
    });
}

function commitClass(status) {
    const date = document.getElementById('m-date').value;
    const time = document.getElementById('m-time').value;
    const pl = document.getElementById('m-playlist').value;
    
    if(!date || !pl) { toast('Date & Playlist required', 'error'); return; }
    
    const id = store.editId || Date.now().toString(36) + Math.random().toString(36).substr(2);
    const obj = {
        id, date, time, 
        playlist: pl, // Store as string now
        attendees: new Set(store.modalGuests),
        status
    };
    
    store.plans.set(id, obj);
    saveData();
    
    if(status === 'final') {
        obj.attendees.forEach(g => {
            store.history.push({date, time, guest:g, playlist:obj.playlist});
        });
        syncSheet(obj);
        saveData();
        rebuildPlaylistSet(); // New playlist might have been created
        refreshPlaylistDropdown();
    } else {
        toast('Draft Saved', 'success');
    }
    closeModal();
    renderCalendar();
}

function deleteClass() {
    if(confirm("Delete this class?")) {
        store.plans.delete(store.editId);
        saveData();
        closeModal();
        renderCalendar();
        toast('Deleted', 'success');
    }
}

function renderExplorer() {
    const scores = calcRecs();
    const tbody = document.getElementById('expl-body');
    if(!scores) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Select guests on dashboard</td></tr>'; return; }
    
    tbody.innerHTML = scores.map(s => {
        const name = !isNaN(parseFloat(s.id)) ? `#${s.id}` : s.id;
        return `<tr>
            <td style="font-weight:bold; color:var(--accent)">${name}</td>
            <td>${s.never}</td>
            <td>${s.median}</td>
            <td>${s.score.toFixed(1)}</td>
        </tr>`
    }).join('');
}

function renderHistory() {
    const term = document.getElementById('hist-search').value.toLowerCase();
    const tbody = document.getElementById('hist-body');
    const sorted = [...store.history].sort((a,b) => new Date(b.date) - new Date(a.date));
    
    tbody.innerHTML = sorted
        .filter(h => h.guest.toLowerCase().includes(term) || h.date.includes(term))
        .slice(0, 50)
        .map(h => {
            const plName = !isNaN(parseFloat(h.playlist)) ? `#${h.playlist}` : h.playlist;
            return `<tr>
                <td>${h.date}<br><span class="subtle">${h.time}</span></td>
                <td style="color:var(--accent)">${plName}</td>
                <td>${h.guest}</td>
            </tr>`
        }).join('');
}

// --- CONNECTIVITY ---
async function checkConnectivity() {
    const badge = document.getElementById('conn-status');
    try {
        await jsonp('test');
        store.connected = true;
        badge.className = 'pill pill-ok';
        badge.innerText = 'Online';
        // AUTO PULL ON CONNECT
        await pullSheets(true);
    } catch(e) {
        store.connected = false;
        badge.className = 'pill pill-warn';
        badge.innerText = 'Offline';
    }
}

async function syncSheet(obj) {
    if(!store.connected) { toast('Saved locally. Offline.', 'warn'); return; }
    const rows = Array.from(obj.attendees).map(g => [obj.date, obj.time, g, obj.playlist]);
    try {
        await jsonp('append', {rows: JSON.stringify(rows)});
        toast('Synced to Google Sheets', 'success');
    } catch(e) { toast('Sync Error', 'error'); }
}

async function pullSheets(isAuto = false) {
    if(!isAuto) toast('Fetching...', 'normal');
    try {
        const res = await jsonp('read');
        if(res.success && res.data) {
            let count = 0;
            const sigs = new Set(store.history.map(r => `${r.date}|${r.time}|${r.guest}`));
            
            res.data.forEach(row => {
                const [d,t,g,p] = row;
                const cleanDate = d.split('T')[0];
                if(g && p) {
                    const sig = `${cleanDate}|${t}|${g}`;
                    if(!sigs.has(sig)) {
                        store.history.push({
                            date:cleanDate, 
                            time:t||'00:00', 
                            guest:g, 
                            playlist: String(p).trim() // Force string, trim whitespace
                        });
                        store.guests.add(g);
                        count++;
                    }
                }
            });
            saveData();
            rebuildPlaylistSet();
            refreshPlaylistDropdown();
            if(count > 0) toast(`Synced: ${count} new records`, 'success');
            else if(!isAuto) toast('Up to date', 'success');
            renderDashboardList();
        }
    } catch(e) { if(!isAuto) toast('Fetch failed', 'error'); }
}

// --- HELPERS ---
function jsonp(action, params={}) {
    return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).substr(2, 9);
        window[cb] = (data) => { delete window[cb]; document.body.removeChild(script); resolve(data); };
        const url = new URL(CONFIG.scriptUrl);
        url.searchParams.append('token', CONFIG.token);
        url.searchParams.append('action', action);
        url.searchParams.append('callback', cb);
        Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
        const script = document.createElement('script');
        script.src = url.href;
        script.onerror = () => { delete window[cb]; if(script.parentNode) document.body.removeChild(script); reject(); };
        document.body.appendChild(script);
        setTimeout(() => { if(window[cb]) { delete window[cb]; reject(); } }, 8000);
    });
}

function toast(msg, type='normal') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerText = msg;
    document.getElementById('toast-area').appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function getMonday(d) {
    const date = new Date(d);
    const day = date.getDay();
    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(date.setDate(diff));
}

function fmtTime(str) {
    if(!str) return '';
    const [h,m] = str.split(':');
    const hr = parseInt(h);
    const ampm = hr >= 12 ? 'PM' : 'AM';
    const dh = hr % 12 || 12;
    return `${dh}:${m} ${ampm}`;
}

function updateClock() {
    const now = new Date();
    const hrs = now.getHours();
    document.getElementById('greeting').innerText = hrs < 12 ? 'Good Morning' : hrs < 18 ? 'Good Afternoon' : 'Good Evening';
    document.getElementById('currentDateTime').innerText = now.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});
}

function parseCSV() {
    const f = this.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (e) => {
        const lines = e.target.result.split('\n').slice(1);
        let count = 0;
        lines.forEach(l => {
            const c = l.split(',');
            if(c.length >= 4) {
                const [d,t,g,p] = c;
                if(g && p) {
                    store.history.push({
                        date: d.trim(), time: t.trim(), 
                        guest: g.replace(/"/g,'').trim(), 
                        playlist: p.trim() // No parseInt
                    });
                    store.guests.add(g.replace(/"/g,'').trim());
                    count++;
                }
            }
        });
        saveData();
        rebuildPlaylistSet();
        refreshPlaylistDropdown();
        toast(`CSV: ${count} records added`, 'success');
        renderDashboardList();
    };
    r.readAsText(f);
}
</script>
</body>
</html>
