<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hilo Playlist ‚Äì Instructor Edition</title>
  <meta name="description" content="Professional class planning with playlist optimization and cloud sync" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><circle cx='24' cy='24' r='22' stroke='%23c9a15d' stroke-width='2' fill='none'/><path d='M14 30C16 20 20 16 24 16C28 16 32 20 34 30' stroke='%23c9a15d' stroke-width='3' stroke-linecap='round'/><path d='M12 36H36' stroke='%23c9a15d' stroke-width='2' stroke-linecap='round'/></svg>" />
  <meta name="theme-color" content="#0d1512" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

  <style>
    :root {
      --primary: #243b33;
      --accent: #c9a15d;
      --cream: #f6f4f0;
      --ink: #0f0f0f;
      --ink-light: #2b2b2b;
      --glass: rgba(255,255,255,0.08);
      --radius: 16px;
      --radius-lg: 22px;
      --shadow: 0 10px 30px rgba(0,0,0,.22), 0 4px 12px rgba(0,0,0,.18);
      --inner-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.15);
      --blur: blur(16px);
      --gap: 18px;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #3498db;
    }
    /* Apple-like base */
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #0d1512 0%, #16231d 40%, #1b2d25 100%);
      color: var(--cream);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Inter", "Helvetica Neue", Arial, system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }
    * { box-sizing: border-box; }
    a { color: inherit; text-decoration: none; }
    .nav {
      position: sticky; top: 0; z-index: 20;
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px clamp(14px, 3vw, 28px);
      background: rgba(20, 34, 28, .85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand {
      display:flex; align-items:center; gap:10px;
      font-weight: 700; letter-spacing:.2px;
    }
    .brand svg { width: 28px; height: 28px; }
    .tabs {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .tab-btn {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255, .06);
      border: 1px solid rgba(255,255,255,.08);
      color: #f7f7f7;
      cursor: pointer;
      transition: all .15s ease;
      font-size: 14px;
      font-weight: 500;
    }
    .tab-btn[aria-selected="true"] {
      background: linear-gradient(180deg, rgba(201,161,93,.28), rgba(201,161,93,.14));
      border-color: rgba(201,161,93,.55);
      box-shadow: 0 6px 18px rgba(201,161,93,.26);
    }
    .tab-btn:hover {
      background: rgba(255,255,255, .1);
      transform: translateY(-1px);
    }
    .tab-btn:active { transform: scale(.98); }
    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 clamp(12px, 3vw, 24px);
      display: grid;
      gap: var(--gap);
    }
    /* Hero */
    .hero {
      position: relative;
      border-radius: var(--radius-lg);
      padding: clamp(18px, 3vw, 28px);
      background: radial-gradient(1200px 600px at 0% -10%, rgba(201,161,93,.12), transparent 60%),
                  radial-gradient(800px 500px at 100% 110%, rgba(201,161,93,.08), transparent 60%),
                  rgba(28, 45, 38, .6);
      backdrop-filter: var(--blur);
      border: 1px solid rgba(255,255,255,.07);
      box-shadow: var(--shadow);
    }
    .hero h1 {
      margin: 0 0 6px 0;
      font-size: clamp(22px, 3vw, 32px);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .subtle { color: rgba(255,255,255,.75); font-weight: 500; }
    .hero .row {
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 10px;
    }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1);
      padding: 8px 12px; border-radius:999px;
      font-size: 13px;
      transition: all .2s ease;
    }
    .pill:hover {
      transform: translateY(-1px);
    }
    /* Class-type tags */
    .class-type-tag {
      display: inline-flex; align-items: center; gap: 4px;
      background: rgba(52, 152, 219, .18);
      border: 1px solid rgba(52, 152, 219, .35);
      color: rgba(255,255,255,.9);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
    }
    .class-type-tag.compact {
      padding: 2px 7px;
      font-size: 11px;
    }
    .playlist-tags-inline {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .tag-editor-row td {
      background: rgba(0,0,0,.25) !important;
      padding: 12px 20px !important;
    }
    .tag-editor {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tag-editor-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      min-height: 28px;
    }
    .tag-chip-removable {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(52, 152, 219, .22);
      border: 1px solid rgba(52, 152, 219, .4);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 13px;
      animation: fadeIn .2s ease;
    }
    .remove-tag {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      font-size: 12px;
    }
    .remove-tag:hover { opacity: 1; }
    .tag-input-wrapper {
      position: relative;
    }
    .tag-input-wrapper input {
      width: 200px;
      padding: 7px 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
    }
    .tag-input-wrapper input:focus {
      outline: none;
      border-color: var(--info);
      box-shadow: 0 0 0 3px rgba(52,152,219,.2);
    }
    .tag-autocomplete {
      position: absolute;
      top: 100%;
      left: 0;
      width: 200px;
      max-height: 160px;
      overflow-y: auto;
      background: rgba(20, 34, 28, .97);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 8px;
      margin-top: 4px;
      z-index: 50;
      box-shadow: 0 8px 24px rgba(0,0,0,.4);
    }
    .tag-autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      color: rgba(255,255,255,.85);
      transition: background .15s;
    }
    .tag-autocomplete-item:hover,
    .tag-autocomplete-item.active {
      background: rgba(52, 152, 219, .2);
      color: #fff;
    }
    .explorer-row { cursor: pointer; transition: background .15s; }
    .explorer-row:hover { background: rgba(255,255,255,.08) !important; }
    /* Status indicators */
    .status-connected { background: rgba(46, 204, 113, .18); border-color: rgba(46, 204, 113, .45); }
    .status-disconnected { background: rgba(231, 76, 60, .18); border-color: rgba(231, 76, 60, .45); }
    .status-draft { background: rgba(241, 196, 15, .18); border-color: rgba(241, 196, 15, .45); }
    .status-finalized { background: rgba(46, 204, 113, .18); border-color: rgba(46, 204, 113, .45); }
    .status-info { background: rgba(52, 152, 219, .18); border-color: rgba(52, 152, 219, .45); }
    /* Glass cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--gap);
    }
    .card {
      position: relative;
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.09);
      box-shadow: var(--shadow);
      overflow:hidden;
      transition: all .3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 36px rgba(0,0,0,.26), 0 6px 16px rgba(0,0,0,.22);
    }
    .card .body { padding: 16px; }
    .card .title { font-weight: 700; letter-spacing:.2px; margin-bottom: 4px; }
    .card .muted { color: rgba(255,255,255,.74); font-size: 14px; }
    .primary-card {
      background: linear-gradient(180deg, rgba(36,59,51,.82), rgba(36,59,51,.68));
      border-color: rgba(201,161,93,.55);
    }
    .primary-card .title { color: #fff; font-size: 18px; }
    .metric-row {
      display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px;
    }
    .metric {
      background: rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px;
      text-align:center;
    }
    .metric .value { font-weight: 800; font-size: 22px; }
    .metric .label { color: rgba(255,255,255,.74); font-size: 12px; margin-top: 4px; }
    .btn { 
      padding: 10px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2);
      color: #fff; cursor:pointer;
      transition: all .15s ease;
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover {
      background: linear-gradient(180deg, rgba(201,161,93,.3), rgba(201,161,93,.15));
      box-shadow: 0 8px 22px rgba(201,161,93,.25);
      transform: translateY(-1px);
    }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(180deg, var(--accent), rgba(201,161,93,.8));
      border-color: var(--accent);
    }
    .btn-success {
      background: linear-gradient(180deg, var(--success), rgba(46, 204, 113, .8));
      border-color: var(--success);
    }
    .btn-warning {
      background: linear-gradient(180deg, var(--warning), rgba(243, 156, 18, .8));
      border-color: var(--warning);
    }
    .btn-danger {
      background: linear-gradient(180deg, var(--danger), rgba(231, 76, 60, .8));
      border-color: var(--danger);
    }
    .btn-info {
      background: linear-gradient(180deg, var(--info), rgba(52, 152, 219, .8));
      border-color: var(--info);
    }
    .suggestions { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--gap); }
    .suggestion-card { 
      padding: 14px; 
      cursor: pointer;
      transition: all .2s ease;
    }
    .suggestion-card:hover { 
      background: rgba(255,255,255,.08);
      transform: translateY(-2px);
    }
    /* Date/Time Selection */
    .datetime-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      background: rgba(0,0,0,.1);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255,255,255,.08);
      margin: 16px 0;
    }
    .datetime-selector label {
      font-weight: 500;
      color: rgba(255,255,255,.9);
      font-size: 14px;
    }
    .datetime-selector input {
      padding: 8px 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .datetime-selector input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(201,161,93,.2);
    }
    /* Guest Selection UI */
    .guest-selector {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: rgba(0,0,0,.1);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .selected-guests-container {
      min-height: 50px;
      padding: 10px;
      background: rgba(0,0,0,.15);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .selected-guests {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .no-selection {
      color: rgba(255,255,255,.5);
      font-style: italic;
      padding: 8px 4px;
    }
    .selected-guest-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(201,161,93,.28), rgba(201,161,93,.14));
      border: 1px solid rgba(201,161,93,.35);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 14px;
      animation: fadeIn .2s ease;
    }
    .remove-guest {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .remove-guest:hover {
      opacity: 1;
    }
    .guest-list-container {
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0,0,0,.15);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .guest-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      padding: 12px;
    }
    .guest-list-item {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    .guest-list-item:hover {
      background: rgba(255,255,255,.1);
      border-color: rgba(201,161,93,.4);
      transform: translateY(-1px);
    }
    .guest-list-item.selected {
      background: linear-gradient(180deg, rgba(201,161,93,.28), rgba(201,161,93,.14));
      border-color: rgba(201,161,93,.55);
      font-weight: 500;
    }
    /* Search Container */
    .search-container {
      position: relative;
      max-width: 300px;
    }
    
    .search-container input {
      width: 100%;
      padding: 12px 16px;
      padding-left: 40px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: #fff;
      font-size: 14px;
    }
    
    .search-container::before {
      content: 'üîç';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.6;
    }
    .search-wrap { display:flex; gap:8px; flex-wrap:wrap; }
    .search { 
      flex:1;
      min-width: 240px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px; border-radius: 12px; color:#fff;
    }
    .select { 
      min-width: 160px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px; border-radius: 12px; color:#fff;
      cursor: pointer;
    }
    /* Enhanced Tables */
    .table-container {
      border-radius: var(--radius);
      overflow: hidden;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }
    
    .data-table { 
      width:100%; 
      border-collapse: collapse; 
      background: transparent;
    }
    
    .data-table th, .data-table td { 
      text-align:left; 
      padding: 16px 20px; 
      border-bottom: 1px solid rgba(255,255,255,.08); 
    }
    
    .data-table th { 
      color: rgba(255,255,255,.9); 
      font-weight: 600; 
      background: rgba(255,255,255,.06);
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    
    .data-table tbody tr:hover { 
      background: rgba(255,255,255,.06);
      transition: background 0.2s ease;
    }
    
    .data-table tbody tr:last-child td {
      border-bottom: none;
    }
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    .sortable:hover {
      color: var(--accent);
    }
    
    .sortable::after {
      content: '‚Üï';
      position: absolute;
      right: 8px;
      opacity: 0.5;
      font-size: 12px;
    }
    .sortable.asc::after {
      content: '‚Üë';
      opacity: 1;
    }
    .sortable.desc::after {
      content: '‚Üì';
      opacity: 1;
    }
    /* Section Header */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .section-header h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }
    /* Weekly Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 16px;
      margin-top: 20px;
    }
    .day-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      padding: 16px;
      min-height: 200px;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .day-card:hover {
      background: rgba(255,255,255,.1);
      transform: translateY(-2px);
    }
    .day-card.has-classes {
      border-color: rgba(201,161,93,.4);
      background: rgba(201,161,93,.08);
    }
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    .day-name {
      font-weight: 600;
      color: #fff;
    }
    .day-date {
      font-size: 12px;
      color: rgba(255,255,255,.7);
    }
    .class-list {
      flex-grow: 1;
    }
    .class-item {
      background: rgba(0,0,0,.2);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
    }
    .class-item:hover {
      background: rgba(0,0,0,.3);
      transform: translateX(2px);
    }
    .class-time {
      font-weight: 600;
      color: var(--accent);
    }
    .class-info {
      color: rgba(255,255,255,.8);
      font-size: 12px;
      margin-top: 2px;
    }
    .class-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }
    /* Guest Grid */
    .guests-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .guest-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .guest-card:hover {
      background: rgba(255,255,255,.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    .guest-card-header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .guest-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), rgba(201,161,93,.6));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: #fff;
    }
    .guest-info h4 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: #fff;
    }
    .guest-info p {
      margin: 0;
      font-size: 13px;
      color: rgba(255,255,255,.7);
    }
    .guest-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .guest-stat {
      text-align: center;
      padding: 8px;
      background: rgba(0,0,0,.15);
      border-radius: 8px;
    }
    .guest-stat .value {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    .guest-stat .label {
      display: block;
      font-size: 11px;
      color: rgba(255,255,255,.6);
      margin-top: 2px;
    }
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn .2s ease;
    }
    
    .modal__content {
      background: rgba(28, 45, 38, .95);
      backdrop-filter: var(--blur);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      animation: slideUp .3s ease;
    }
    
    .modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      flex-shrink: 0;
    }
    
    .modal__header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }
    
    .modal__close {
      background: none;
      border: none;
      font-size: 24px;
      color: rgba(255,255,255,.7);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .modal__close:hover {
      background: rgba(255,255,255,.1);
      color: #fff;
    }
    
    .modal__body {
      padding: 24px;
      overflow-y: auto;
    }
     .modal__footer {
      padding: 16px 24px;
      border-top: 1px solid rgba(255,255,255,.08);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
    }
    /* Form styling */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: rgba(255,255,255,.9);
      font-size: 14px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(201,161,93,.2);
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    /* Connection status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .connection-status.connected {
      background: rgba(46, 204, 113, .1);
      border: 1px solid rgba(46, 204, 113, .3);
    }
    .connection-status.disconnected {
      background: rgba(231, 76, 60, .1);
      border: 1px solid rgba(231, 76, 60, .3);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .status-dot.connected { background: var(--success); }
    .status-dot.disconnected { background: var(--danger); }
    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,.6);
    }
    
    .empty-state h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: rgba(255,255,255,.8);
    }
    /* Toast notifications */
    #toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    
    .toast {
      pointer-events: auto;
      min-width: 280px;
      max-width: 420px;
      background: rgba(28,28,30,.95);
      color: #fff;
      padding: 14px 18px;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
      font: 500 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.1);
      animation: slideInRight .3s ease;
    }
    
    .toast.success {
      background: rgba(46, 204, 113, .95);
      border-color: rgba(46, 204, 113, .5);
    }
    
    .toast.error {
      background: rgba(231, 76, 60, .95);
      border-color: rgba(231, 76, 60, .5);
    }
    
    .toast.info {
      background: rgba(52, 152, 219, .95);
      border-color: rgba(52, 152, 219, .5);
    }
    /* Loading indicator */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn .3s ease both; }
    /* Debug Panel */
    .debug-panel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,.9);
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      font-size: 11px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 10000;
    }
    .debug-panel.show {
      display: block;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .calendar-grid {
        grid-template-columns: 1fr;
      }
      
      .metric-row {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .datetime-selector {
        flex-direction: column;
        align-items: stretch;
      }
      
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap;
        scrollbar-width: none; /* Firefox */
      }
      .tabs::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
      }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand">
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="24" cy="24" r="22" stroke="#c9a15d" stroke-width="2"/>
        <path d="M14 30C16 20 20 16 24 16C28 16 32 20 34 30" stroke="#c9a15d" stroke-width="3" stroke-linecap="round"/>
        <path d="M12 36H36" stroke="#c9a15d" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Hilo Playlist</span>
    </div>
    <div class="tabs" role="tablist">
      <button class="tab-btn" role="tab" aria-selected="true" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="weekly">Weekly Planner</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="explorer">Playlist Explorer</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="history">History</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="guests">Guests</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="settings">Settings</button>
    </div>
    <div id="auth-container" style="display:flex; align-items:center; gap:8px;">
      <button id="signInBtn" class="btn btn-primary btn-sm">Sign In</button>
      <span id="userDisplay" class="hidden" style="font-size:13px; color:rgba(255,255,255,.7);"></span>
      <button id="signOutBtn" class="btn btn-sm hidden">Sign Out</button>
    </div>
  </nav>
  <main class="container">
    <section id="dashboard" class="fade-in">
      <div class="hero">
        <h1>Class Planning Dashboard</h1>
        <div class="subtle" id="currentDateTime"></div>
        
        <div id="connection-status" class="connection-status disconnected">
          <div class="status-dot disconnected"></div>
          <span>Not signed in</span>
        </div>
        
        <div class="datetime-selector">
          <div style="flex: 1;">
            <label for="class-date-dashboard">Class Date</label>
            <input type="date" id="class-date-dashboard">
          </div>
          <div style="flex: 1;">
            <label for="class-time-dashboard">Class Time</label>
            <input type="time" id="class-time-dashboard" value="09:00">
          </div>
          <button id="todayBtn" class="btn btn-info">Set to Now</button>
        </div>
        
        <div style="margin-top:20px;">
          <div class="guest-selector">
            <div class="search-container" style="max-width:100%;">
              <input type="text" id="guest-search" placeholder="Search House Guests...">
            </div>
            
            <div class="selected-guests-container">
              <div class="selected-guests" id="rosterChips">
                <div class="no-selection" id="no-selection-message">No House Guests selected</div>
              </div>
            </div>
            
            <div class="guest-list-container">
              <div class="guest-list" id="guest-list"></div>
            </div>
          </div>
        </div>
        
        <div class="row" style="margin-top:14px;">
          <div class="search-wrap" style="flex:1;">
            <select id="playlistWindow" class="select" title="Stale window">
              <option value="45" selected>Stale ‚â• 45 days</option>
              <option value="30">Stale ‚â• 30 days</option>
              <option value="60">Stale ‚â• 60 days</option>
              <option value="90">Stale ‚â• 90 days</option>
            </select>
            <button id="saveDraftBtn" class="btn btn-warning" title="Save as draft">
              <span>üíæ</span> Save Draft
            </button>
            <button id="finalizeBtn" class="btn btn-success" title="Finalize and sync" disabled>
              <span>‚úî</span> Finalize Class
            </button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <span class="pill" id="rosterCountPill">0 attendees</span>
          <span class="pill" id="recordsCountPill">0 records</span>
          <span id="draftStatusPill" class="pill hidden">No draft</span>
        </div>
      </div>
      <div class="cards" style="margin-top:14px;">
        <div class="card primary-card" id="bestCard">
          <div class="body">
            <div class="title">Best Fit Recommendation</div>
            <div class="muted">Maximizes freshness for the current roster</div>
            <div id="bestSummary" style="margin-top:10px;"></div>
            <div class="metric-row">
              <div class="metric">
                <div class="value" id="bestNever">‚Äî</div>
                <div class="label">Never-heard</div>
              </div>
              <div class="metric">
                <div class="value" id="bestMedian">‚Äî</div>
                <div class="label">Median days</div>
              </div>
              <div class="metric">
                <div class="value" id="bestStale">‚Äî</div>
                <div class="label">Stale %</div>
              </div>
            </div>
            <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" id="selectPlaylistBtn">Use This Playlist</button>
              <button class="btn" id="previewRosterBtn">View Details</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <div class="title">Runner-ups</div>
            <div class="muted">Strong alternatives ranked by freshness</div>
            <div class="suggestions" id="runnerUps"></div>
          </div>
        </div>
      </div>
    </section>
    <section id="weekly" class="hidden fade-in">
      <div class="hero">
        <h1>Weekly Class Planner</h1>
        <div class="subtle">Plan and manage your upcoming week of classes</div>
        
        <div class="row" style="margin-top:14px;">
          <div class="search-wrap" style="flex:1;">
            <button id="prevWeekBtn" class="btn">‚Üê Previous Week</button>
            <button id="currentWeekBtn" class="btn btn-info">Current Week</button>
            <button id="nextWeekBtn" class="btn">Next Week ‚Üí</button>
            <button id="syncAllBtn" class="btn btn-success" disabled>Finalize All Drafts</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <span class="pill" id="weekRangePill">Week of ...</span>
          <span class="pill status-draft" id="draftsCountPill">0 drafts</span>
          <span class="pill status-finalized" id="finalizedCountPill">0 finalized</span>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        </div>
    </section>
    <section id="explorer" class="hidden fade-in">
      <div class="hero">
        <h1>Playlist Explorer</h1>
        <div class="subtle">Compare all playlists by freshness metrics for the current roster</div>
      </div>
      <div class="card">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="playlist">Playlist</th>
                <th class="sortable" data-sort="never">Never-heard</th>
                <th class="sortable" data-sort="median">Median days</th>
                <th class="sortable" data-sort="stalePct">Stale %</th>
                <th class="sortable" data-sort="score">Score</th>
              </tr>
            </thead>
            <tbody id="explorerTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="history" class="hidden fade-in">
      <div class="section-header">
        <h2>Class History</h2>
        <div class="search-container">
          <input type="text" id="history-search" placeholder="Search classes...">
        </div>
      </div>
      <div class="card">
        <div class="table-container">
          <table id="history-table" class="data-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="datetime">Date & Time</th>
                <th class="sortable" data-sort="playlist">Playlist</th>
                <th class="sortable" data-sort="count">Attendees</th>
                <th>Guest Names</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="guests" class="hidden fade-in">
      <div class="section-header">
        <h2>Guest Profiles</h2>
        <div class="search-container">
          <input type="text" id="guest-search-filter" placeholder="Search guests...">
        </div>
      </div>
      <div id="guests-grid" class="guests-grid">
        <div class="empty-state">
          <h3>No guest data available</h3>
          <p>Sign in to see guest profiles</p>
        </div>
      </div>
    </section>
    <section id="settings" class="hidden fade-in">
      <div class="hero">
        <h1>Settings</h1>
        <div class="subtle">Manage your account and app data</div>
      </div>
      <div class="cards">
        <div class="card">
          <div class="body">
            <div class="title">Account</div>
            <div class="muted">Sign in with Google to sync your data across devices</div>
            <div id="settings-auth-info" style="margin-top:16px; padding: 12px; background: rgba(0,0,0,.1); border-radius: 8px; color: rgba(255,255,255,.9);">
              Not signed in
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:16px;">
              <button id="settingsSignInBtn" class="btn btn-primary">Sign In with Google</button>
              <button id="settingsSignOutBtn" class="btn hidden">Sign Out</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <div class="title">Data Management</div>
            <div class="muted">Import/export your class data</div>

            <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="importCsvBtn" class="btn">üì• Import CSV (App/HiLo)</button>
              <button id="exportCsvBtn" class="btn">üì§ Export CSV</button>
              <button id="clearDataBtn" class="btn btn-danger">üóëÔ∏è Clear All Data</button>
            </div>
            <input id="fileInput" type="file" accept=".csv" class="hidden" />
          </div>
        </div>
      </div>
    </section>
    <div id="class-modal" class="modal hidden">
      <div class="modal__content">
        <div class="modal__header">
          <h3 id="class-modal-title">Plan Class</h3>
          <button id="close-class-modal" class="modal__close">&times;</button>
        </div>
        <div class="modal__body">
          <div class="form-row">
            <div class="form-group">
              <label for="modal-class-date">Date</label>
              <input type="date" id="modal-class-date">
            </div>
            <div class="form-group">
              <label for="modal-class-time">Time</label>
              <input type="time" id="modal-class-time" value="09:00">
            </div>
          </div>
          
          <div class="form-group">
            <label for="modal-class-playlist">Playlist</label>
            <select id="modal-class-playlist">
              <option value="">Select playlist...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Attendees</label>
            <div class="guest-selector">
              <div class="search-container" style="max-width:100%;">
                <input type="text" id="modal-guest-search" placeholder="Search guests...">
              </div>
              
              <div class="selected-guests-container">
                <div class="selected-guests" id="modal-selected-guests">
                  <div class="no-selection">No guests selected</div>
                </div>
              </div>
              
              <div class="guest-list-container" style="max-height: 200px;">
                <div class="guest-list" id="modal-guest-list"></div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="modal-class-notes">Notes (optional)</label>
            <textarea id="modal-class-notes" placeholder="Add any notes about this class..."></textarea>
          </div>
        </div>
         <div class="modal__footer">
            <button id="delete-class-modal" class="btn btn-danger" style="margin-right: auto;">üóëÔ∏è Delete</button>
            <button id="cancel-modal" class="btn">Cancel</button>
            <button id="save-draft-modal" class="btn btn-warning">üíæ Save as Draft</button>
            <button id="finalize-modal" class="btn btn-success">‚úî Finalize</button>
        </div>
      </div>
    </div>
    <div id="guest-modal" class="modal hidden">
      <div class="modal__content">
        <div class="modal__header">
          <h3 id="guest-modal-title">Guest Profile</h3>
          <button id="close-guest-modal" class="modal__close">&times;</button>
        </div>
        <div class="modal__body" id="guest-modal-body">
          <div id="guest-modal-content"></div>
        </div>
      </div>
    </div>
  </main>
  <div id="debug-panel" class="debug-panel">
    <strong>Debug Info:</strong>
    <div id="debug-content"></div>
  </div>
<!-- Firebase SDK (compat for no-build-tool usage) -->
<script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore-compat.js"></script>
<script>
  // --- Firebase Configuration ---
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyA5wVOEPafDg27_Jc-Ixn_03jFb6t2IedM",
    authDomain: "hilo-playlist-app.firebaseapp.com",
    projectId: "hilo-playlist-app",
    storageBucket: "hilo-playlist-app.firebasestorage.app",
    messagingSenderId: "13713370156",
    appId: "1:13713370156:web:2380816951b9c48c4a7589"
  };

  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();
  db.enablePersistence({ synchronizeTabs: true }).catch(err => {
    if (err.code === 'failed-precondition') {
      console.warn('Firestore persistence unavailable: multiple tabs open');
    }
  });
  // --- Debug Mode ---
  const DEBUG_MODE = false; // Set to true to enable debug logging
  function debugLog(...args) {
    if (DEBUG_MODE) {
      console.log('[DEBUG]', ...args);
      const panel = document.getElementById('debug-panel');
      const content = document.getElementById('debug-content');
      if (panel && content) {
        panel.classList.add('show');
        const timestamp = new Date().toLocaleTimeString();
        content.innerHTML = `<div>${timestamp}: ${args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ')}</div>` + content.innerHTML;
        const messages = content.querySelectorAll('div');
        if (messages.length > 20) {
          messages[messages.length - 1].remove();
        }
      }
    }
  }
  // --- App State ---
  const DEFAULT_PLAYLISTS = Array.from({ length: 12 }, (_, i) => String(i + 1));
  const state = {
    attendees: new Set(),
    modalAttendees: new Set(),
    playlists: [...DEFAULT_PLAYLISTS],
    records: [], // Historical records with date, time, guest, playlist
    selectedWindow: 45,
    allGuests: new Set(),
    sortOrder: { column: 'datetime', ascending: false },
    explorerSortOrder: { column: 'score', ascending: false },
    
    // Firebase integration
    firebaseUser: null,
    firestoreConnected: false,
    firestoreHasPendingWrites: false,
    unsubRecords: null,
    unsubClasses: null,
    unsubPlaylists: null,
    playlistTags: new Map(),
    playlistStatus: new Map(),
    expandedPlaylist: null,

    // Weekly planner state
    weeklyPlan: new Map(), // DateTime string -> class object
    currentWeekStart: null,
    selectedClass: null, // Holds the class being edited in the modal

    // Current selection for dashboard
    selectedDate: null,
    selectedTime: null
  };
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const PREDEFINED_CLASS_TYPES = ['Yoga', 'Pilates', 'Spin', 'HIIT', 'Strength', 'Stretch', 'Dance', 'Barre'];
  function normalizePlaylistId(value) {
    if (value === null || value === undefined) return '';
    let raw = typeof value === 'number'
      ? (Number.isFinite(value) ? String(value) : '')
      : String(value).trim();
    if (!raw) return '';
    raw = raw.replace(/^playlist\s*#?/i, '').trim();
    if (!raw) return '';
    if (!/^\d+(\.\d+)?$/.test(raw)) return '';
    if (raw.includes('.')) {
      raw = raw.replace(/(\.\d*?[1-9])0+$/, '$1').replace(/\.0+$/, '').replace(/\.$/, '');
    }
    return raw;
  }
  function comparePlaylistIds(a, b) {
    const aId = normalizePlaylistId(a);
    const bId = normalizePlaylistId(b);
    const aNum = aId && /^\d+(\.\d+)?$/.test(aId) ? Number(aId) : NaN;
    const bNum = bId && /^\d+(\.\d+)?$/.test(bId) ? Number(bId) : NaN;
    if (!Number.isNaN(aNum) && !Number.isNaN(bNum) && aNum !== bNum) return aNum - bNum;
    if (!Number.isNaN(aNum) && Number.isNaN(bNum)) return -1;
    if (Number.isNaN(aNum) && !Number.isNaN(bNum)) return 1;
    return aId.localeCompare(bId, undefined, { numeric: true, sensitivity: 'base' });
  }
  function normalizePlaylistStatus(value) {
    const raw = (value ?? '').toString().trim();
    if (!raw) return '';
    const lower = raw.toLowerCase();
    if (lower === 'active') return 'Active';
    if (lower === 'retired') return 'Retired';
    return raw;
  }
  function ensurePlaylistInState(playlistId) {
    const normalized = normalizePlaylistId(playlistId);
    if (!normalized) return;
    if (!state.playlists.includes(normalized)) {
      state.playlists.push(normalized);
      state.playlists.sort(comparePlaylistIds);
    }
  }
  function rebuildPlaylistsFromData() {
    const found = new Set();
    state.records.forEach(r => {
      const playlistId = normalizePlaylistId(r.playlist);
      if (playlistId) found.add(playlistId);
    });
    state.weeklyPlan.forEach(cls => {
      const playlistId = normalizePlaylistId(cls.playlist);
      if (playlistId) found.add(playlistId);
    });
    state.playlistTags.forEach((_, playlistId) => {
      const normalized = normalizePlaylistId(playlistId);
      if (normalized) found.add(normalized);
    });
    state.playlistStatus.forEach((_, playlistId) => {
      const normalized = normalizePlaylistId(playlistId);
      if (normalized) found.add(normalized);
    });
    state.playlists = (found.size > 0 ? Array.from(found) : [...DEFAULT_PLAYLISTS]).sort(comparePlaylistIds);
  }
  // HTML escape for safe innerHTML interpolation
  function esc(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  function renderPlaylistTags(playlistNum, opts = {}) {
    const playlistId = normalizePlaylistId(playlistNum);
    const tags = playlistId ? (state.playlistTags.get(playlistId) || []) : [];
    if (tags.length === 0) return '';
    const cls = opts.compact ? 'class-type-tag compact' : 'class-type-tag';
    return '<span class="playlist-tags-inline">' + tags.map(t => `<span class="${cls}">${esc(t)}</span>`).join('') + '</span>';
  }
  function getAllUsedTags() {
    const used = new Set();
    state.playlistTags.forEach(tags => tags.forEach(t => used.add(t)));
    return Array.from(used).sort();
  }
  function normalizeTime(timeStr, fallback = '09:00') {
    const raw = (timeStr ?? '').toString().trim();
    if (!raw) return fallback;
    const cleaned = raw.replace(/^\d{4}-\d{2}-\d{2}[T\s]+/, '').trim();
    const match = cleaned.match(/^(\d{1,2})(?::(\d{1,2}))?(?::\d{1,2})?\s*([AaPp][Mm])?$/);
    if (!match) return fallback;
    let hours = Number.parseInt(match[1], 10);
    const minutes = Number.parseInt(match[2] ?? '0', 10);
    if (Number.isNaN(hours) || Number.isNaN(minutes)) return fallback;
    const meridiem = (match[3] || '').toUpperCase();
    if (meridiem === 'PM' && hours < 12) hours += 12;
    if (meridiem === 'AM' && hours === 12) hours = 0;
    return `${String(Math.max(0, Math.min(23, hours))).padStart(2, '0')}:${String(Math.max(0, Math.min(59, minutes))).padStart(2, '0')}`;
  }
  function buildRecordKey(record) {
    return `${record.date}|${normalizeTime(record.time)}|${(record.guest || '').trim()}|${record.playlist}`;
  }
  function normalizeRecord(record) {
    if (!record) return null;
    const guest = (record.guest || '').toString().trim();
    const playlist = normalizePlaylistId(record.playlist);
    if (!guest || !playlist) return null;
    let date = '';
    if (typeof record.date === 'string') {
      const rawDate = record.date.trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
        date = rawDate;
      } else if (/^\d{4}-\d{2}-\d{2}T/.test(rawDate)) {
        date = rawDate.slice(0, 10);
      } else {
        const parsedDate = new Date(rawDate);
        if (!Number.isNaN(parsedDate.getTime())) {
          date = formatDateKey(parsedDate);
        }
      }
    } else {
      const parsedDate = new Date(record.date);
      if (!Number.isNaN(parsedDate.getTime())) {
        date = formatDateKey(parsedDate);
      }
    }
    if (!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) return null;
    return {
      date,
      time: normalizeTime(record.time),
      guest,
      playlist
    };
  }
  // Deduplicate records before pushing
  function addRecordIfNew(record) {
    const normalizedRecord = normalizeRecord(record);
    if (!normalizedRecord) return false;
    const key = buildRecordKey(normalizedRecord);
    const exists = state.records.some(r => buildRecordKey(r) === key);
    if (!exists) {
      state.records.push(normalizedRecord);
      ensurePlaylistInState(normalizedRecord.playlist);
      return true;
    }
    return false;
  }
  // --- Firestore Document ID Helper ---
  function safeDocId(recordKey) {
    let hash = 0x811c9dc5;
    for (let i = 0; i < recordKey.length; i++) {
      hash ^= recordKey.charCodeAt(i);
      hash = Math.imul(hash, 0x01000193);
    }
    const prefix = recordKey.slice(0, 40).replace(/[^a-zA-Z0-9_-]/g, '_');
    return prefix + '__' + (hash >>> 0).toString(36);
  }
  // --- Firebase Data Layer ---
   function setLoading(button, isLoading) {
    if (!button) return;
    if (isLoading) {
      button.disabled = true;
      button.dataset.originalContent = button.innerHTML;
      button.innerHTML = '<div class="loading-spinner"></div>';
    } else {
      button.disabled = false;
      if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
      }
    }
  }
  // --- Firestore Real-time Listeners ---
  function setupFirestoreListeners() {
    if (state.unsubRecords) state.unsubRecords();
    if (state.unsubClasses) state.unsubClasses();
    if (state.unsubPlaylists) state.unsubPlaylists();

    const uid = state.firebaseUser.uid;

    state.unsubRecords = db.collection('users').doc(uid).collection('records')
      .onSnapshot(snapshot => {
        state.firestoreConnected = !snapshot.metadata.fromCache;
        state.firestoreHasPendingWrites = snapshot.metadata.hasPendingWrites;
        updateConnectionStatus();

        state.records = [];
        state.allGuests = new Set();
        snapshot.forEach(doc => {
          const normalized = normalizeRecord(doc.data());
          if (!normalized) return;
          state.records.push(normalized);
          state.allGuests.add(normalized.guest);
        });
        state.weeklyPlan.forEach(cls => {
          (cls.attendees instanceof Set ? cls.attendees : []).forEach(g => state.allGuests.add(g));
        });
        rebuildPlaylistsFromData();
        populateModalPlaylistOptions();
        populateGuestList();
        updateRecordsPill();
        refreshAll();
        refreshHistory();
        refreshGuests();
        saveStateToLocalStorage();
      }, error => {
        console.error('Records listener error:', error);
        showToast('Data sync error: ' + error.message, 'error');
      });

    state.unsubClasses = db.collection('users').doc(uid).collection('classes')
      .onSnapshot(snapshot => {
        state.weeklyPlan = new Map();
        snapshot.forEach(doc => {
          const cls = doc.data();
          cls.id = doc.id;
          cls.playlist = normalizePlaylistId(cls.playlist);
          cls.attendees = new Set(cls.attendees || []);
          const key = createDateTimeKey(cls.date, cls.time);
          state.weeklyPlan.set(key, cls);
          cls.attendees.forEach(g => state.allGuests.add(g));
        });
        rebuildPlaylistsFromData();
        populateModalPlaylistOptions();
        renderWeeklyCalendar();
        updateDashboardStatus();
        saveStateToLocalStorage();
      }, error => {
        console.error('Classes listener error:', error);
      });

    state.unsubPlaylists = db.collection('users').doc(uid).collection('playlists')
      .onSnapshot(snapshot => {
        state.playlistTags = new Map();
        state.playlistStatus = new Map();
        snapshot.forEach(doc => {
          const data = doc.data();
          const playlistId = normalizePlaylistId(doc.id);
          if (!playlistId) return;
          if (Array.isArray(data.classTypes)) {
            const tags = data.classTypes.map(t => (t ?? '').toString().trim()).filter(Boolean);
            if (tags.length > 0) state.playlistTags.set(playlistId, Array.from(new Set(tags)));
          }
          const status = normalizePlaylistStatus(data.status);
          if (status) state.playlistStatus.set(playlistId, status);
        });
        rebuildPlaylistsFromData();
        populateModalPlaylistOptions();
        refreshAll();
        saveStateToLocalStorage();
      }, error => {
        console.error('Playlists listener error:', error);
      });
  }

  // --- Auth State Observer ---
  function setupAuthListener() {
    auth.onAuthStateChanged(user => {
      state.firebaseUser = user;
      if (user) {
        $('#signInBtn').classList.add('hidden');
        $('#userDisplay').textContent = user.displayName || user.email;
        $('#userDisplay').classList.remove('hidden');
        $('#signOutBtn').classList.remove('hidden');
        $('#settingsSignInBtn').classList.add('hidden');
        $('#settingsSignOutBtn').classList.remove('hidden');
        const infoEl = $('#settings-auth-info');
        if (infoEl) infoEl.textContent = `Signed in as ${user.displayName || user.email}`;
        updateConnectionStatus();
        setupFirestoreListeners();
      } else {
        if (state.unsubRecords) { state.unsubRecords(); state.unsubRecords = null; }
        if (state.unsubClasses) { state.unsubClasses(); state.unsubClasses = null; }
        if (state.unsubPlaylists) { state.unsubPlaylists(); state.unsubPlaylists = null; }
        state.playlistTags = new Map();
        state.playlistStatus = new Map();
        $('#signInBtn').classList.remove('hidden');
        $('#userDisplay').classList.add('hidden');
        $('#signOutBtn').classList.add('hidden');
        $('#settingsSignInBtn').classList.remove('hidden');
        $('#settingsSignOutBtn').classList.add('hidden');
        const infoEl = $('#settings-auth-info');
        if (infoEl) infoEl.textContent = 'Not signed in';
        state.firestoreConnected = false;
        rebuildPlaylistsFromData();
        populateModalPlaylistOptions();
        updateConnectionStatus();
      }
    });
  }

  // --- Firestore Write Functions ---
  async function writeRecordsToFirestore(classData) {
    if (!state.firebaseUser) {
      showToast('Please sign in first.', 'error');
      return false;
    }
    const uid = state.firebaseUser.uid;
    const batch = db.batch();
    const recordsRef = db.collection('users').doc(uid).collection('records');

    for (const guest of classData.attendees) {
      const recordKey = buildRecordKey({
        date: classData.date,
        time: normalizeTime(classData.time),
        guest,
        playlist: classData.playlist
      });
      const docRef = recordsRef.doc(safeDocId(recordKey));
      batch.set(docRef, {
        date: classData.date,
        time: normalizeTime(classData.time),
        guest,
        playlist: classData.playlist,
        recordKey
      });
    }

    try {
      await batch.commit();
      showToast(`Synced ${classData.attendees.size} records`, 'success');
      return true;
    } catch (error) {
      showToast('Sync failed: ' + error.message, 'error');
      return false;
    }
  }

  async function saveClassToFirestore(dateTimeKey, classData) {
    if (!state.firebaseUser) {
      showToast('Please sign in first.', 'error');
      return false;
    }
    const uid = state.firebaseUser.uid;
    const docId = safeDocId(dateTimeKey);
    try {
      await db.collection('users').doc(uid).collection('classes').doc(docId).set({
        date: classData.date,
        time: classData.time,
        playlist: classData.playlist,
        attendees: Array.from(classData.attendees),
        status: classData.status || 'draft',
        notes: classData.notes || '',
        dateTimeKey
      });
      return true;
    } catch (error) {
      showToast('Save failed: ' + error.message, 'error');
      return false;
    }
  }

  async function deleteClassFromFirestore(dateTimeKey) {
    if (!state.firebaseUser) return;
    const uid = state.firebaseUser.uid;
    const docId = safeDocId(dateTimeKey);
    await db.collection('users').doc(uid).collection('classes').doc(docId).delete();
  }

  async function clearAllFirestoreData() {
    if (!state.firebaseUser) return;
    const uid = state.firebaseUser.uid;
    const collections = ['records', 'classes', 'playlists'];
    for (const col of collections) {
      let snapshot;
      do {
        snapshot = await db.collection('users').doc(uid).collection(col).limit(500).get();
        if (snapshot.empty) break;
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
      } while (!snapshot.empty);
    }
  }
  async function upsertPlaylistMetadata(playlistId, payload) {
    if (!state.firebaseUser || !playlistId) return;
    const keys = Object.keys(payload || {});
    if (keys.length === 0) return;
    await db.collection('users').doc(state.firebaseUser.uid)
      .collection('playlists').doc(playlistId)
      .set(payload, { merge: true });
  }
  async function setPlaylistStatus(playlistNum, status) {
    const playlistId = normalizePlaylistId(playlistNum);
    const normalizedStatus = normalizePlaylistStatus(status);
    if (!playlistId || !normalizedStatus) return;
    state.playlistStatus.set(playlistId, normalizedStatus);
    ensurePlaylistInState(playlistId);
    saveStateToLocalStorage();
    refreshAll();
    if (state.firebaseUser) {
      try {
        await upsertPlaylistMetadata(playlistId, { status: normalizedStatus });
      } catch (err) {
        showToast('Playlist status save failed: ' + err.message, 'error');
      }
    }
  }
  async function addPlaylistTag(playlistNum, tag) {
    const playlistId = normalizePlaylistId(playlistNum);
    if (!playlistId) return;
    const trimmed = tag.trim();
    if (!trimmed) return;
    const current = state.playlistTags.get(playlistId) || [];
    if (current.includes(trimmed)) return;
    const updated = [...current, trimmed];
    state.playlistTags.set(playlistId, updated);
    ensurePlaylistInState(playlistId);
    saveStateToLocalStorage();
    refreshAll();
    if (state.firebaseUser) {
      try {
        await upsertPlaylistMetadata(playlistId, { classTypes: updated });
      } catch (err) {
        showToast('Tag save failed: ' + err.message, 'error');
      }
    }
  }
  async function removePlaylistTag(playlistNum, tag) {
    const playlistId = normalizePlaylistId(playlistNum);
    if (!playlistId) return;
    const current = state.playlistTags.get(playlistId) || [];
    const updated = current.filter(t => t !== tag);
    if (updated.length > 0) {
      state.playlistTags.set(playlistId, updated);
    } else {
      state.playlistTags.delete(playlistId);
    }
    rebuildPlaylistsFromData();
    saveStateToLocalStorage();
    refreshAll();
    if (state.firebaseUser) {
      try {
        await upsertPlaylistMetadata(playlistId, { classTypes: updated });
      } catch (err) {
        showToast('Tag remove failed: ' + err.message, 'error');
      }
    }
  }
  // --- Local Storage Persistence ---
  function saveStateToLocalStorage() {
      try {
          // Convert weeklyPlan entries: attendees Set -> Array so JSON.stringify works
          const weeklyPlanSerialized = Array.from(state.weeklyPlan.entries()).map(([key, cls]) => [
              key,
              { ...cls, attendees: Array.from(cls.attendees || []) }
          ]);
          const dataToSave = {
              records: state.records,
              weeklyPlan: weeklyPlanSerialized,
              allGuests: Array.from(state.allGuests),
              playlistTags: Array.from(state.playlistTags.entries()),
              playlistStatus: Array.from(state.playlistStatus.entries())
          };
          localStorage.setItem('hiloPlaylistData', JSON.stringify(dataToSave));
          debugLog('State saved to localStorage');
      } catch (e) {
          console.error("Failed to save state to localStorage", e);
      }
  }
  function loadStateFromLocalStorage() {
      try {
          const savedData = localStorage.getItem('hiloPlaylistData');
          if (savedData) {
              const parsedData = JSON.parse(savedData);
              state.records = [];
              (parsedData.records || []).forEach(r => addRecordIfNew(r));
              const normalizedWeeklyPlan = new Map();
              new Map(parsedData.weeklyPlan || []).forEach((cls, key) => {
                  const parsedKey = parseDateTimeKey(key);
                  cls.date = cls.date || parsedKey.date;
                  cls.time = normalizeTime(cls.time || parsedKey.time || '09:00');
                  cls.playlist = normalizePlaylistId(cls.playlist);
                  cls.id = cls.id || `${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;
                  if (Array.isArray(cls.attendees)) {
                      cls.attendees = new Set(cls.attendees);
                  } else if (!(cls.attendees instanceof Set)) {
                      cls.attendees = new Set();
                  }
                  const normalizedKey = createDateTimeKey(cls.date, cls.time);
                  if (!normalizedWeeklyPlan.has(normalizedKey)) {
                      normalizedWeeklyPlan.set(normalizedKey, cls);
                  }
              });
              state.weeklyPlan = normalizedWeeklyPlan;
              state.playlistTags = new Map();
              (parsedData.playlistTags || []).forEach(entry => {
                const [playlistId, tags] = entry;
                const normalizedId = normalizePlaylistId(playlistId);
                if (!normalizedId || !Array.isArray(tags)) return;
                const cleanedTags = tags.map(t => (t ?? '').toString().trim()).filter(Boolean);
                if (cleanedTags.length > 0) state.playlistTags.set(normalizedId, Array.from(new Set(cleanedTags)));
              });
              state.playlistStatus = new Map();
              (parsedData.playlistStatus || []).forEach(entry => {
                const [playlistId, status] = entry;
                const normalizedId = normalizePlaylistId(playlistId);
                const normalizedStatus = normalizePlaylistStatus(status);
                if (!normalizedId || !normalizedStatus) return;
                state.playlistStatus.set(normalizedId, normalizedStatus);
              });
              state.allGuests = new Set(parsedData.allGuests || []);
              // Rebuild allGuests from records in case saved guest list was incomplete
              state.records.forEach(r => { if (r.guest) state.allGuests.add(r.guest); });
              state.weeklyPlan.forEach(cls => cls.attendees.forEach(guest => state.allGuests.add(guest)));
              rebuildPlaylistsFromData();
              debugLog('State loaded from localStorage');
          }
      } catch (e) {
          console.error("Failed to load state from localStorage", e);
      }
  }
  // --- Utility Functions ---
  const parseDateInput = (d) => {
    if (!d) return null;
    if (typeof d === 'number' || (typeof d === 'string' && /^\d+(\.\d+)?$/.test(d.trim()))) {
      const serial = Number(d);
      if (Number.isFinite(serial) && serial > 59) {
        const ms = Math.round((serial - 25569) * 86400 * 1000);
        const excelDate = new Date(ms);
        if (!Number.isNaN(excelDate.getTime())) return excelDate;
      }
    }
    const parsed = (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d))
      ? new Date(d + 'T00:00:00')
      : new Date(d);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  };
  const formatDate = (d) => {
    if (!d) return '';
    const date = parseDateInput(d);
    if (!date) return '';
    return date.toLocaleDateString('en-US', {
      weekday: 'short',
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };
  const formatTime = (timeStr) => {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours, 10);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${String(minutes).padStart(2, '0')} ${ampm}`;
  };
  const formatDateTime = (date, time) => {
    return `${formatDate(date)} at ${formatTime(time)}`;
  };
  const createDateTimeKey = (date, time) => {
    return `${date}T${normalizeTime(time)}`;
  };
  const parseDateTimeKey = (key) => {
    const [date, time] = key.split('T');
    return { date, time: normalizeTime(time) };
  };
  const daysBetween = (referenceDate, comparedDate) => {
    const date1 = parseDateInput(referenceDate);
    const date2 = parseDateInput(comparedDate);
    if (!date1 || !date2) return 0;
    const diffTime = date1.getTime() - date2.getTime();
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  };
  const median = (arr) => {
    if (!arr.length) return 0;
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 ? sorted[mid] : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
  };
  const getWeekStart = (date) => {
    const d = parseDateInput(date) || new Date();
    d.setHours(0, 0, 0, 0);
    const day = d.getDay();
    const diff = d.getDate() - day; // Sunday = 0
    return new Date(d.setDate(diff));
  };
  const getWeekDays = (weekStart) => {
    const days = [];
    for (let i = 0; i < 7; i++) {
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + i);
      days.push(day);
    }
    return days;
  };
  const formatDateKey = (date) => {
    // Use local date components instead of UTC-based toISOString()
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  };
  const setsEqual = (a, b) => {
    const aSet = a instanceof Set ? a : new Set(a || []);
    const bSet = b instanceof Set ? b : new Set(b || []);
    if (aSet.size !== bSet.size) return false;
    for (const value of aSet) {
      if (!bSet.has(value)) return false;
    }
    return true;
  };
  
  // --- Initialize App ---
  async function initializeApp() {
    debugLog('Initializing app...');
    loadStateFromLocalStorage();

    const today = new Date();
    const currentTime = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;

    $("#class-date-dashboard").value = formatDateKey(today);
    $("#class-date-dashboard").min = formatDateKey(today);
    $("#class-time-dashboard").value = currentTime;

    state.selectedDate = formatDateKey(today);
    state.selectedTime = currentTime;
    state.currentWeekStart = getWeekStart(today);

    // Wire up UI immediately so the app is interactive while Firebase loads
    addEventListeners();
    populateGuestList();
    renderSelectedGuests();
    updateConnectionStatus();
    updateDashboardStatus();
    updateRecordsPill();
    refreshAll();

    // Start Firebase auth listener ‚Äî Firestore listeners start on sign-in
    setupAuthListener();
  }
  function updateCurrentDateTime() {
    const now = new Date();
    $("#currentDateTime").textContent = now.toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }
  updateCurrentDateTime();
  setInterval(updateCurrentDateTime, 60000);
  
  // --- Toast Notification System ---
  function showToast(message, type = 'info', duration = 3000) {
    let container = $('#toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    
    const removeToast = () => {
        toast.style.animation = 'slideOutRight 0.3s ease forwards';
        toast.addEventListener('animationend', () => toast.remove());
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 500);
    };
    
    const timer = setTimeout(removeToast, duration);
    
    toast.addEventListener('click', () => {
        clearTimeout(timer);
        removeToast();
    });
  }
  
  // Add CSS for slide out animation
  const styleSheet = document.createElement("style");
  styleSheet.type = "text/css";
  styleSheet.innerText = `@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
  document.head.appendChild(styleSheet);
  
  function updateConnectionStatus() {
    const statusEl = $("#connection-status");
    const dotEl = statusEl.querySelector('.status-dot');

    if (!state.firebaseUser) {
      statusEl.className = 'connection-status disconnected';
      dotEl.className = 'status-dot disconnected';
      statusEl.querySelector('span').textContent = 'Not signed in';
      $("#syncAllBtn").disabled = true;
    } else if (state.firestoreHasPendingWrites) {
      statusEl.className = 'connection-status connected';
      dotEl.className = 'status-dot connected';
      dotEl.style.background = 'var(--warning)';
      statusEl.querySelector('span').textContent = 'Syncing...';
      $("#syncAllBtn").disabled = false;
    } else if (state.firestoreConnected) {
      statusEl.className = 'connection-status connected';
      dotEl.className = 'status-dot connected';
      dotEl.style.background = '';
      statusEl.querySelector('span').textContent = 'Synced';
      $("#syncAllBtn").disabled = false;
    } else {
      statusEl.className = 'connection-status disconnected';
      dotEl.className = 'status-dot disconnected';
      dotEl.style.background = 'var(--warning)';
      statusEl.querySelector('span').textContent = 'Offline (cached)';
      $("#syncAllBtn").disabled = false;
    }
    updateDashboardStatus();
  }
  // --- Class Management ---
  function createClass(date, time, playlist = null, attendees = new Set(), notes = '', status = 'draft') {
    return {
      id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
      date: date,
      time: normalizeTime(time),
      playlist: playlist,
      attendees: new Set(attendees),
      status: status,
      notes: notes
    };
  }
  async function saveDraftClass() {
    if (state.attendees.size === 0) {
      showToast('Please select at least one attendee', 'error');
      return;
    }
    const metrics = computeMetrics();
    const bestPlaylist = metrics[0]?.playlist;

    if (!bestPlaylist) {
      showToast('No playlist recommendation available', 'error');
      return;
    }
    const dateTimeKey = createDateTimeKey(state.selectedDate, state.selectedTime);
    const classData = {
      date: state.selectedDate,
      time: state.selectedTime,
      playlist: bestPlaylist,
      attendees: new Set(state.attendees),
      status: 'draft',
      notes: ''
    };

    if (state.firebaseUser) {
      await saveClassToFirestore(dateTimeKey, classData);
      // onSnapshot listener will update local state
    } else {
      state.weeklyPlan.set(dateTimeKey, classData);
      updateDashboardStatus();
      saveStateToLocalStorage();
    }
    showToast('Draft saved!', 'success');
  }
  async function finalizeClass() {
    const dateTimeKey = createDateTimeKey(state.selectedDate, state.selectedTime);
    const draftClass = state.weeklyPlan.get(dateTimeKey);

    if (!draftClass || state.attendees.size === 0) {
      showToast('No valid draft found. Please select attendees and save a draft first.', 'error');
      return;
    }
    if (!setsEqual(draftClass.attendees, state.attendees)) {
      showToast('Attendee list changed since draft save. Save draft again before finalizing.', 'error');
      return;
    }
    if (draftClass.status === 'finalized') {
      showToast('This class has already been finalized.', 'info');
      return;
    }
    setLoading($("#finalizeBtn"), true);

    try {
      if (state.firebaseUser) {
        const uid = state.firebaseUser.uid;
        const batch = db.batch();
        // Update class status
        const classDocId = safeDocId(dateTimeKey);
        const classRef = db.collection('users').doc(uid).collection('classes').doc(classDocId);
        batch.set(classRef, {
          date: draftClass.date,
          time: draftClass.time,
          playlist: draftClass.playlist,
          attendees: Array.from(draftClass.attendees),
          status: 'finalized',
          notes: draftClass.notes || '',
          dateTimeKey
        });
        // Write attendance records
        const recordsRef = db.collection('users').doc(uid).collection('records');
        for (const guest of draftClass.attendees) {
          const recordKey = buildRecordKey({ date: draftClass.date, time: normalizeTime(draftClass.time), guest, playlist: draftClass.playlist });
          batch.set(recordsRef.doc(safeDocId(recordKey)), {
            date: draftClass.date, time: normalizeTime(draftClass.time), guest, playlist: draftClass.playlist, recordKey
          });
        }
        await batch.commit();
        showToast('Class finalized!', 'success');
      } else {
        showToast('Please sign in to finalize.', 'error');
      }
    } catch (error) {
      showToast('Finalize failed: ' + error.message, 'error');
    } finally {
      setLoading($("#finalizeBtn"), false);
    }
  }
  function updateDashboardStatus() {
    const dateTimeKey = createDateTimeKey(state.selectedDate, state.selectedTime);
    const currentClass = state.weeklyPlan.get(dateTimeKey);
    const draftStatusPill = $("#draftStatusPill");
    
    if (currentClass) {
      const rosterMatches = setsEqual(currentClass.attendees, state.attendees);
      let pillClass = 'status-draft';
      let pillText = 'Draft saved';
      if (currentClass.status === 'finalized') {
        pillClass = 'status-finalized';
        pillText = 'Finalized';
      } else if (!rosterMatches) {
        pillClass = 'status-info';
        pillText = 'Draft out of sync';
      }
      draftStatusPill.textContent = pillText;
      draftStatusPill.className = `pill ${pillClass}`;
      draftStatusPill.classList.remove('hidden');
      $("#finalizeBtn").disabled = currentClass.status === 'finalized' || !rosterMatches || !state.firebaseUser;
    } else {
      draftStatusPill.classList.add('hidden');
      // Finalize requires an existing draft at the selected date/time.
      $("#finalizeBtn").disabled = true;
    }
  }
  function updateRecordsPill() {
    $("#recordsCountPill").textContent = `${state.records.length} records`;
  }
  // --- Weekly Calendar ---
  function renderWeeklyCalendar() {
    const calendarGrid = $("#calendarGrid");
    const weekDays = getWeekDays(state.currentWeekStart);
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    calendarGrid.innerHTML = '';
    
    weekDays.forEach((day, index) => {
      const dayKey = formatDateKey(day);
      const isToday = dayKey === formatDateKey(new Date());
      
      const dayClasses = Array.from(state.weeklyPlan.entries())
        .filter(([key]) => key.startsWith(dayKey))
        .map(([key, cls]) => ({...cls, dateTimeKey: key}))
        .sort((a, b) => a.time.localeCompare(b.time));
      
      const dayCard = document.createElement('div');
      dayCard.className = `day-card ${dayClasses.length > 0 ? 'has-classes' : ''}`;
      
      let classesHTML = '';
      if (dayClasses.length > 0) {
        classesHTML = dayClasses.map(cls => `
          <div class="class-item" onclick="openClassModal('${cls.dateTimeKey}')">
            <div class="class-time">${formatTime(cls.time)}</div>
            <div class="class-info">
              Playlist #${cls.playlist} ‚Ä¢ ${cls.attendees.size} guests
            </div>
            ${renderPlaylistTags(cls.playlist, { compact: true })}
            <div class="pill ${cls.status === 'draft' ? 'status-draft' : 'status-finalized'} " style="margin-top: 4px; font-size: 11px; padding: 4px 8px;">
              ${cls.status}
            </div>
          </div>
        `).join('');
      } else {
        classesHTML = '<div class="empty-state" style="padding: 20px 0;"><p style="margin:0;">No classes scheduled</p></div>';
      }
      
      dayCard.innerHTML = `
        <div class="day-header">
          <div class="day-name">${dayNames[index]} ${isToday ? '‚Ä¢ Today' : ''}</div>
          <div class="day-date">${day.getMonth() + 1}/${day.getDate()}</div>
        </div>
        <div class="class-list">${classesHTML}</div>
        <div class="class-actions">
          <button class="btn btn-sm btn-primary" onclick="openNewClassModal('${dayKey}')">+ Add Class</button>
        </div>
      `;
      
      calendarGrid.appendChild(dayCard);
    });
    
    updateWeeklyStats();
  }
  function updateWeeklyStats() {
    const weekStart = state.currentWeekStart;
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999);
    
    $("#weekRangePill").textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
    
    let drafts = 0, finalized = 0;
    state.weeklyPlan.forEach(cls => {
        const clsDate = parseDateInput(cls.date);
        if (clsDate >= weekStart && clsDate <= weekEnd) {
            if (cls.status === 'draft') drafts++;
            else finalized++;
        }
    });
    
    $("#draftsCountPill").textContent = `${drafts} draft${drafts !== 1 ? 's' : ''}`;
    $("#finalizedCountPill").textContent = `${finalized} finalized`;
  }
  function navigateWeek(direction) {
    if (direction === 0) {
        state.currentWeekStart = getWeekStart(new Date());
    } else {
        const newStart = new Date(state.currentWeekStart);
        newStart.setDate(newStart.getDate() + (direction * 7));
        state.currentWeekStart = newStart;
    }
    renderWeeklyCalendar();
  }
  
  window.openNewClassModal = function(dateKey) {
    state.selectedClass = createClass(dateKey, '09:00');
    state.modalAttendees = new Set(); // Start with empty roster for new class
    
    $("#class-modal-title").textContent = 'Plan New Class';
    $("#modal-class-date").value = dateKey;
    $("#modal-class-time").value = '09:00';
    $("#modal-class-playlist").value = '';
    $("#modal-class-notes").value = '';
    
    populateModalPlaylistOptions();
    populateModalGuestList();
    renderModalSelectedGuests();
    
    $("#delete-class-modal").classList.add('hidden');
    $("#class-modal").classList.remove('hidden');
  };
  window.openClassModal = function(dateTimeKey) {
    const classData = state.weeklyPlan.get(dateTimeKey);
    if (!classData) return;
    
    state.selectedClass = classData;
    state.modalAttendees = new Set(classData.attendees); // Load roster from class

    $("#class-modal-title").textContent = 'Edit Class';
    $("#modal-class-date").value = classData.date;
    $("#modal-class-time").value = classData.time;
    $("#modal-class-notes").value = classData.notes || '';

    populateModalPlaylistOptions();
    $("#modal-class-playlist").value = classData.playlist || '';
    populateModalGuestList();
    renderModalSelectedGuests();
    
    $("#delete-class-modal").classList.remove('hidden');
    $("#class-modal").classList.remove('hidden');
  };
  function populateModalPlaylistOptions() {
    const select = $("#modal-class-playlist");
    select.innerHTML = '<option value="">Select playlist...</option>';
    state.playlists.forEach(pl => {
      const option = document.createElement('option');
      option.value = pl;
      const tags = state.playlistTags.get(pl) || [];
      const status = state.playlistStatus.get(pl);
      const statusSuffix = status ? ` [${status}]` : '';
      option.textContent = tags.length > 0
        ? `Playlist #${pl}${statusSuffix} (${tags.join(', ')})`
        : `Playlist #${pl}${statusSuffix}`;
      select.appendChild(option);
    });
  }
  // --- Guest Selection System ---
  function populateGuestList() {
    const guestList = $("#guest-list");
    guestList.innerHTML = "";
    const sortedGuests = Array.from(state.allGuests).sort();
    
    if (sortedGuests.length === 0) {
      guestList.innerHTML = '<div class="no-selection" style="padding: 20px;">No guests found. Import data to get started.</div>';
      return;
    }
    
    sortedGuests.forEach(guest => {
      const guestElement = document.createElement("div");
      guestElement.className = `guest-list-item ${state.attendees.has(guest) ? 'selected' : ''}`;
      guestElement.dataset.guest = guest;
      guestElement.textContent = guest;
      
      guestElement.addEventListener("click", () => toggleGuestSelection(guest, true));
      guestList.appendChild(guestElement);
    });
  }
  function populateModalGuestList() {
    const modalGuestList = $("#modal-guest-list");
    modalGuestList.innerHTML = "";
    
    Array.from(state.allGuests).sort().forEach(guest => {
      const guestElement = document.createElement("div");
      guestElement.className = `guest-list-item ${state.modalAttendees.has(guest) ? 'selected' : ''}`;
      guestElement.dataset.guest = guest;
      guestElement.textContent = guest;

      guestElement.addEventListener("click", () => {
        if (state.modalAttendees.has(guest)) {
          state.modalAttendees.delete(guest);
        } else {
          state.modalAttendees.add(guest);
        }
        renderModalSelectedGuests();
        updateModalGuestListSelection();
      });
      modalGuestList.appendChild(guestElement);
    });
  }
  function toggleGuestSelection(guest, refresh = true) {
    if (state.attendees.has(guest)) {
      state.attendees.delete(guest);
    } else {
      state.attendees.add(guest);
    }
    
    if (refresh) {
      renderSelectedGuests();
      updateGuestListSelection();
      refreshAll();
    }
  }
  function renderSelectedGuests() {
    const rosterChips = $("#rosterChips");
    const rosterCountPill = $("#rosterCountPill");
    
    rosterChips.innerHTML = "";
    
    if (state.attendees.size === 0) {
      rosterChips.innerHTML = `<div class="no-selection">No House Guests selected</div>`;
    } else {
      [...state.attendees].sort().forEach(name => {
        const guestChip = document.createElement("div");
        guestChip.className = "selected-guest-item";
        guestChip.innerHTML = `<span>${esc(name)}</span><span class="remove-guest" data-guest="${esc(name)}">‚úï</span>`;
        guestChip.querySelector(".remove-guest").addEventListener("click", (e) => {
          e.stopPropagation();
          state.attendees.delete(name);
          renderSelectedGuests();
          updateGuestListSelection();
          refreshAll();
        });
        rosterChips.appendChild(guestChip);
      });
    }
    
    rosterCountPill.textContent = `${state.attendees.size} attendee${state.attendees.size !== 1 ? 's' : ''}`;
    updateDashboardStatus();
  }
  function renderModalSelectedGuests() {
    const container = $("#modal-selected-guests");
    container.innerHTML = "";
    
    if (state.modalAttendees.size === 0) {
      container.innerHTML = `<div class="no-selection">No guests selected</div>`;
    } else {
      [...state.modalAttendees].sort().forEach(name => {
        const guestChip = document.createElement("div");
        guestChip.className = "selected-guest-item";
        guestChip.innerHTML = `<span>${esc(name)}</span><span class="remove-guest" data-guest="${esc(name)}">‚úï</span>`;
        guestChip.querySelector(".remove-guest").addEventListener("click", (e) => {
          e.stopPropagation();
          state.modalAttendees.delete(name);
          renderModalSelectedGuests();
          updateModalGuestListSelection();
        });
        container.appendChild(guestChip);
      });
    }
  }
  function updateGuestListSelection() {
    $$("#guest-list .guest-list-item").forEach(item => {
      item.classList.toggle("selected", state.attendees.has(item.dataset.guest));
    });
  }
  function updateModalGuestListSelection() {
    $$("#modal-guest-list .guest-list-item").forEach(item => {
      item.classList.toggle("selected", state.modalAttendees.has(item.dataset.guest));
    });
  }
  
  // --- Metrics Calculation ---
  function lastHeardMap(referenceDate) {
    const refDate = parseDateInput(referenceDate || formatDateKey(new Date())) || new Date();
    const map = new Map();
    state.records.forEach(r => {
      const recordDate = parseDateInput(r.date);
      if (!recordDate || recordDate > refDate) return;
      if (!map.has(r.guest)) map.set(r.guest, new Map());
      const pm = map.get(r.guest);
      const prev = pm.get(r.playlist);
      if (!prev || recordDate > parseDateInput(prev)) {
        pm.set(r.playlist, r.date);
      }
    });
    return map;
  }
  function computeMetrics() {
    const refDateISO = state.selectedDate || formatDateKey(new Date());
    const lm = lastHeardMap(refDateISO);
    const roster = [...state.attendees];
    const windowDays = state.selectedWindow;
    const byPlaylist = state.playlists.map(pl => {
      let never = 0;
      let deltas = [];
      let staleCount = 0;
      roster.forEach(g => {
        const last = lm.get(g)?.get(pl);
        if (!last) {
          never++;
        } else {
          const d = daysBetween(refDateISO, last);
          if (d < 0) {
            never++;
            return;
          }
          deltas.push(d);
          if (d >= windowDays) staleCount++;
        }
      });
      const medianDays = deltas.length ? median(deltas) : 0;
      const stalePct = roster.length ? Math.round((staleCount / roster.length) * 100) : 0;
      // Score: high stale %, high never-heard %, and high median days are all "good"
      const neverPct = roster.length ? Math.round((never / roster.length) * 100) : 0;
      const score = (stalePct * 2) + (neverPct * 3) + (medianDays * 0.1);

      return { playlist: pl, never, median: medianDays, stalePct, score };
    });
    // Sort by score descending
    byPlaylist.sort((a, b) => b.score - a.score);
    return byPlaylist;
  }
  // --- UI Refresh Functions ---
  function refreshAll() {
      const metrics = computeMetrics();
      refreshDashboard(metrics);
      refreshExplorer(metrics);
      updateDashboardStatus();
  }
  function refreshDashboard(metrics) {
    const best = metrics[0];
    
    if (!best || state.attendees.size === 0) {
      $("#bestSummary").innerHTML = '<div class="muted">Add attendees above to see the best recommendation.</div>';
      $("#bestNever").textContent = "‚Äî";
      $("#bestMedian").textContent = "‚Äî";
      $("#bestStale").textContent = "‚Äî";
      $("#runnerUps").innerHTML = '<div class="empty-state"><p>Select attendees to see alternatives</p></div>';
      $("#selectPlaylistBtn").disabled = true;
      return;
    }
     $("#selectPlaylistBtn").disabled = false;
    
    $("#bestSummary").innerHTML = `
      <div style="font-size:20px; font-weight:700; margin-top:10px;">
        Playlist <span style="color: var(--accent);">#${best.playlist}</span>${renderPlaylistTags(best.playlist)}
      </div>
      <div class="subtle" style="margin-top:4px;">Optimized for ${state.attendees.size} attendees ‚Ä¢ Stale threshold: ${state.selectedWindow} days</div>
    `;
    
    $("#bestNever").textContent = best.never;
    $("#bestMedian").textContent = best.median;
    $("#bestStale").textContent = best.stalePct + "%";
    
    const runners = metrics.slice(1, 4);
    const wrap = $("#runnerUps");
    wrap.innerHTML = "";
    
    if (runners.length === 0) {
      wrap.innerHTML = '<div class="empty-state"><p>No alternative playlists available</p></div>';
    } else {
      runners.forEach(r => {
        wrap.innerHTML += `
          <div class="card suggestion-card">
            <div class="title">Playlist #${r.playlist}${renderPlaylistTags(r.playlist, { compact: true })}</div>
            <div class="metric-row" style="margin-top:8px;">
              <div class="metric"><div class="value">${r.never}</div><div class="label">Never</div></div>
              <div class="metric"><div class="value">${r.median}</div><div class="label">Median</div></div>
              <div class="metric"><div class="value">${r.stalePct}%</div><div class="label">Stale</div></div>
            </div>
          </div>`;
      });
    }
  }
  function refreshExplorer(metrics) {
    const tbody = $("#explorerTbody");
    tbody.innerHTML = "";
    const { column, ascending } = state.explorerSortOrder;

    metrics.sort((a, b) => {
        if (a[column] < b[column]) return ascending ? -1 : 1;
        if (a[column] > b[column]) return ascending ? 1 : -1;
        return 0;
    });

    metrics.forEach(m => {
      const tr = document.createElement('tr');
      tr.className = 'explorer-row';
      tr.innerHTML = `
          <td><strong>Playlist #${m.playlist}</strong>${renderPlaylistTags(m.playlist)}</td>
          <td>${m.never}</td>
          <td>${m.median}</td>
          <td>${m.stalePct}%</td>
          <td><span class="pill status-info">${m.score.toFixed(1)}</span></td>`;
      tr.addEventListener('click', () => {
        if (state.expandedPlaylist === m.playlist) {
          state.expandedPlaylist = null;
        } else {
          state.expandedPlaylist = m.playlist;
        }
        refreshExplorer(computeMetrics());
      });
      tbody.appendChild(tr);

      if (state.expandedPlaylist === m.playlist) {
        const editorTr = document.createElement('tr');
        editorTr.className = 'tag-editor-row';
        editorTr.innerHTML = `<td colspan="5">${buildTagEditorHTML(m.playlist)}</td>`;
        editorTr.addEventListener('click', e => e.stopPropagation());
        tbody.appendChild(editorTr);
        wireTagEditor(m.playlist, editorTr);
      }
    });
  }
  function buildTagEditorHTML(playlistNum) {
    const tags = state.playlistTags.get(playlistNum) || [];
    const chips = tags.map(t =>
      `<span class="tag-chip-removable" data-tag="${esc(t)}"><span>${esc(t)}</span><span class="remove-tag">‚úï</span></span>`
    ).join('');
    return `<div class="tag-editor">
      <div style="font-weight:600; font-size:13px; color:rgba(255,255,255,.7);">Class Types for Playlist #${playlistNum}</div>
      <div class="tag-editor-chips">${chips || '<span style="color:rgba(255,255,255,.4); font-size:13px;">No tags yet</span>'}</div>
      <div class="tag-input-wrapper">
        <input type="text" class="tag-input" placeholder="Add class type..." autocomplete="off" />
        <div class="tag-autocomplete" style="display:none;"></div>
      </div>
    </div>`;
  }
  function wireTagEditor(playlistNum, editorTr) {
    const input = editorTr.querySelector('.tag-input');
    const dropdown = editorTr.querySelector('.tag-autocomplete');
    let activeIndex = -1;

    // Remove buttons
    editorTr.querySelectorAll('.remove-tag').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const tag = btn.closest('.tag-chip-removable').dataset.tag;
        removePlaylistTag(playlistNum, tag);
      });
    });

    function getSuggestions(query) {
      const currentTags = state.playlistTags.get(playlistNum) || [];
      const usedTags = getAllUsedTags();
      const all = [...new Set([...PREDEFINED_CLASS_TYPES, ...usedTags])];
      return all.filter(t =>
        !currentTags.includes(t) &&
        t.toLowerCase().includes(query.toLowerCase())
      );
    }

    function showDropdown() {
      const query = input.value.trim();
      const suggestions = getSuggestions(query);
      if (suggestions.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      activeIndex = -1;
      dropdown.innerHTML = suggestions.map(s =>
        `<div class="tag-autocomplete-item" data-value="${esc(s)}">${esc(s)}</div>`
      ).join('');
      dropdown.style.display = 'block';
      dropdown.querySelectorAll('.tag-autocomplete-item').forEach(item => {
        item.addEventListener('mousedown', (e) => {
          e.preventDefault();
          addPlaylistTag(playlistNum, item.dataset.value);
        });
      });
    }

    input.addEventListener('focus', showDropdown);
    input.addEventListener('input', showDropdown);

    input.addEventListener('keydown', (e) => {
      const items = dropdown.querySelectorAll('.tag-autocomplete-item');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = Math.min(activeIndex + 1, items.length - 1);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = Math.max(activeIndex - 1, 0);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeIndex >= 0 && items[activeIndex]) {
          addPlaylistTag(playlistNum, items[activeIndex].dataset.value);
        } else if (input.value.trim()) {
          addPlaylistTag(playlistNum, input.value.trim());
        }
      } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
        input.blur();
      }
    });

    input.addEventListener('blur', () => {
      setTimeout(() => { dropdown.style.display = 'none'; }, 150);
    });
  }
  function refreshHistory() {
    const tbody = $("#historyTbody");
    const searchTerm = $("#history-search").value.toLowerCase();
    
    const byClass = new Map();
    [...state.records, ...Array.from(state.weeklyPlan.values()).filter(c => c.status === 'finalized')]
    .forEach(r => {
        if (!r.playlist) return;
        const normalizedTime = normalizeTime(r.time, '00:00');
        const key = `${r.date}T${normalizedTime}::${r.playlist}`;
        if (!byClass.has(key)) {
            byClass.set(key, { date: r.date, time: normalizedTime, playlist: r.playlist, guests: new Set(), status: 'finalized' });
        }
        if (r.guest) {
            byClass.get(key).guests.add(r.guest);
        } else if (r.attendees) {
            r.attendees.forEach(g => byClass.get(key).guests.add(g));
        }
    });

    let rows = [...byClass.values()].filter(row => {
        if (!searchTerm) return true;
        const guestNames = [...row.guests].join(' ').toLowerCase();
        return row.date.includes(searchTerm) || row.playlist.toString().includes(searchTerm) || guestNames.includes(searchTerm);
    });
    
    const { column, ascending } = state.sortOrder;
    rows.sort((a, b) => {
        let aVal, bVal;
        if (column === 'datetime') {
            aVal = new Date(`${a.date}T${a.time}`);
            bVal = new Date(`${b.date}T${b.time}`);
        } else if (column === 'count') {
            aVal = a.guests.size;
            bVal = b.guests.size;
        } else {
            aVal = a[column];
            bVal = b[column];
        }
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
    });

    tbody.innerHTML = "";
    rows.forEach(row => {
      const guestArray = [...row.guests].sort();
      const tr = `
        <tr>
          <td>${formatDate(row.date)} ${formatTime(row.time)}</td>
          <td><strong>Playlist #${row.playlist}</strong>${renderPlaylistTags(row.playlist, { compact: true })}</td>
          <td><span class="pill">${guestArray.length}</span></td>
          <td>${guestArray.slice(0, 3).map(g => esc(g)).join(", ")}${guestArray.length > 3 ? ` +${guestArray.length - 3} more` : ""}</td>
          <td><span class="pill status-finalized">Completed</span></td>
        </tr>
      `;
      tbody.innerHTML += tr;
    });
  }
  function refreshGuests() {
    const container = $("#guests-grid");
    const searchTerm = $("#guest-search-filter").value.toLowerCase();
    
    if (state.allGuests.size === 0) {
      container.innerHTML = `<div class="empty-state"><h3>No guest data available</h3><p>Sign in and import data to see guest profiles</p></div>`;
      return;
    }
    const guestStats = Array.from(state.allGuests)
      .filter(guest => guest.toLowerCase().includes(searchTerm))
      .map(guest => {
        const guestRecords = state.records.filter(r => r.guest === guest);
        const todayKey = formatDateKey(new Date());
        const eligibleRecords = guestRecords.filter(r => r.date <= todayKey);
        const totalClasses = eligibleRecords.length;
        const playlistsHeard = new Set(eligibleRecords.map(r => r.playlist)).size;
        const lastClassDate = eligibleRecords.length > 0 ? eligibleRecords.reduce((latest, r) => r.date > latest ? r.date : latest, '') : null;
        const daysSince = lastClassDate ? daysBetween(formatDateKey(new Date()), lastClassDate) : null;
        return { name: guest, totalClasses, playlistsHeard, daysSince, records: guestRecords };
      })
      .sort((a, b) => (a.daysSince ?? 9999) - (b.daysSince ?? 9999)); // Sort by most recent first
    
    container.innerHTML = "";
    guestStats.forEach(guest => {
      const guestCard = document.createElement("div");
      guestCard.className = "guest-card";
      guestCard.dataset.guestName = guest.name;
      guestCard.innerHTML = `
        <div class="guest-card-header">
          <div class="guest-avatar">${esc(guest.name.split(' ').map(n => n[0]).join('').toUpperCase())}</div>
          <div class="guest-info">
            <h4>${esc(guest.name)}</h4>
            <p>${guest.daysSince !== null ? `Last seen: ${guest.daysSince} days ago` : 'No classes yet'}</p>
          </div>
        </div>
        <div class="guest-stats">
          <div class="guest-stat"><span class="value">${guest.totalClasses}</span><span class="label">Classes</span></div>
          <div class="guest-stat"><span class="value">${guest.playlistsHeard}</span><span class="label">Playlists</span></div>
        </div>`;
      guestCard.addEventListener('click', () => showGuestDetailModal(guest.name));
      container.appendChild(guestCard);
    });
  }
  function showGuestDetailModal(guestName) {
      const guestRecords = state.records
          .filter(r => r.guest === guestName)
          .sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));
      
      $('#guest-modal-title').textContent = `${guestName}'s Profile`;
      
      let contentHTML = `<div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Playlist</th></tr></thead><tbody>`;
      if (guestRecords.length > 0) {
          guestRecords.forEach(record => {
              contentHTML += `<tr><td>${formatDateTime(record.date, record.time)}</td><td>Playlist #${record.playlist}</td></tr>`;
          });
      } else {
          contentHTML += `<tr><td colspan="2" style="text-align:center;">No class history found.</td></tr>`;
      }
      contentHTML += `</tbody></table></div>`;
      
      $('#guest-modal-content').innerHTML = contentHTML;
      $('#guest-modal').classList.remove('hidden');
  }

  // --- EVENT LISTENERS ---
  function addEventListeners() {
      // Tab navigation
      $$('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
              const tab = btn.dataset.tab;
              $$('.tab-btn').forEach(b => b.setAttribute('aria-selected', 'false'));
              btn.setAttribute('aria-selected', 'true');
              $$('main > section').forEach(s => s.classList.add('hidden'));
              $(`#${tab}`).classList.remove('hidden');

              // Refresh content on tab switch
              if(tab === 'weekly') renderWeeklyCalendar();
              if(tab === 'history') refreshHistory();
              if(tab === 'guests') refreshGuests();
              if(tab === 'explorer') refreshAll();
          });
      });
      // Dashboard controls
      $('#class-date-dashboard').addEventListener('change', (e) => {
          state.selectedDate = e.target.value;
          refreshAll();
      });
      $('#class-time-dashboard').addEventListener('change', (e) => {
          state.selectedTime = normalizeTime(e.target.value);
          $('#class-time-dashboard').value = state.selectedTime;
          refreshAll();
      });
      $('#todayBtn').addEventListener('click', () => {
          const now = new Date();
          state.selectedDate = formatDateKey(now);
          state.selectedTime = normalizeTime(`${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`);
          $('#class-date-dashboard').value = state.selectedDate;
          $('#class-time-dashboard').value = state.selectedTime;
          refreshAll();
      });
      $('#playlistWindow').addEventListener('change', (e) => {
          state.selectedWindow = parseInt(e.target.value, 10);
          refreshAll();
      });
      $('#saveDraftBtn').addEventListener('click', saveDraftClass);
      $('#finalizeBtn').addEventListener('click', finalizeClass);
      
      $('#selectPlaylistBtn').addEventListener('click', () => {
        const metrics = computeMetrics();
        const bestPlaylist = metrics[0]?.playlist;
        if(bestPlaylist) {
          saveDraftClass(); // This will use the best playlist
        } else {
          showToast('Cannot select playlist, no recommendation available.', 'error');
        }
      });
      $('#previewRosterBtn').addEventListener('click', () => {
        const metrics = computeMetrics();
        const best = metrics[0];
        if (!best || state.attendees.size === 0) {
          showToast('Add attendees to see playlist details.', 'error');
          return;
        }
        const refDate = state.selectedDate || formatDateKey(new Date());
        const lm = lastHeardMap(refDate);
        const roster = [...state.attendees].sort();
        const windowDays = state.selectedWindow;
        const neverList = [];
        const staleList = [];
        const freshList = [];
        roster.forEach(g => {
          const last = lm.get(g)?.get(best.playlist);
          if (!last) {
            neverList.push(g);
          } else {
            const d = daysBetween(refDate, last);
            if (d < 0) {
              neverList.push(g);
            } else if (d >= windowDays) {
              staleList.push({ name: g, days: d });
            } else {
              freshList.push({ name: g, days: d });
            }
          }
        });
        staleList.sort((a, b) => b.days - a.days);
        freshList.sort((a, b) => a.days - b.days);
        let html = `<h4 style="margin-bottom:12px;">Playlist #${best.playlist} ‚Äî Roster Breakdown</h4>`;
        html += `<p class="muted" style="margin-bottom:12px;">${roster.length} attendees ‚Ä¢ Stale threshold: ${windowDays} days</p>`;
        if (neverList.length > 0) {
          html += `<div style="margin-bottom:12px;"><strong>Never Heard (${neverList.length})</strong><div style="margin-top:4px;">${neverList.map(g => `<span class="pill">${esc(g)}</span>`).join(' ')}</div></div>`;
        }
        if (staleList.length > 0) {
          html += `<div style="margin-bottom:12px;"><strong>Stale (${staleList.length})</strong><div style="margin-top:4px;">${staleList.map(g => `<span class="pill status-draft">${esc(g.name)} ‚Äî ${g.days}d ago</span>`).join(' ')}</div></div>`;
        }
        if (freshList.length > 0) {
          html += `<div style="margin-bottom:12px;"><strong>Fresh (${freshList.length})</strong><div style="margin-top:4px;">${freshList.map(g => `<span class="pill status-finalized">${esc(g.name)} ‚Äî ${g.days}d ago</span>`).join(' ')}</div></div>`;
        }
        $('#guest-modal-title').textContent = 'Playlist Detail';
        $('#guest-modal-content').innerHTML = html;
        $('#guest-modal').classList.remove('hidden');
      });
      
      // Guest search
      $('#guest-search').addEventListener("input", (e) => {
          const term = e.target.value.toLowerCase();
          $$("#guest-list .guest-list-item").forEach(item => {
              item.style.display = item.dataset.guest.toLowerCase().includes(term) ? '' : 'none';
          });
      });
      $('#guest-search-filter').addEventListener('input', refreshGuests);
      $('#modal-guest-search').addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          $$("#modal-guest-list .guest-list-item").forEach(item => {
              item.style.display = item.dataset.guest.toLowerCase().includes(term) ? '' : 'none';
          });
      });
      $('#history-search').addEventListener('input', refreshHistory);

      // Sorting table headers
      $$('#history-table .sortable, #explorer thead .sortable').forEach(header => {
          header.addEventListener('click', () => {
              const sortKey = header.dataset.sort;
              const isExplorer = header.closest('#explorer');
              const sortState = isExplorer ? state.explorerSortOrder : state.sortOrder;

              if (sortState.column === sortKey) {
                  sortState.ascending = !sortState.ascending;
              } else {
                  sortState.column = sortKey;
                  sortState.ascending = false;
              }
              
              header.closest('table').querySelectorAll('.sortable').forEach(h => h.classList.remove('asc', 'desc'));
              header.classList.add(sortState.ascending ? 'asc' : 'desc');
              
              if (isExplorer) refreshExplorer(computeMetrics()); else refreshHistory();
          });
      });

      // Sync All Finalized
      // Finalize All Drafts
      $('#syncAllBtn').addEventListener('click', async () => {
        if (!state.firebaseUser) {
          showToast('Please sign in first.', 'error');
          return;
        }
        const drafts = [];
        const weekStart = state.currentWeekStart;
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
        state.weeklyPlan.forEach((cls, key) => {
          const clsDate = parseDateInput(cls.date);
          if (clsDate >= weekStart && clsDate <= weekEnd && cls.status === 'draft') {
            drafts.push({ key, cls });
          }
        });
        if (drafts.length === 0) {
          showToast('No drafts to finalize this week.', 'info');
          return;
        }
        setLoading($('#syncAllBtn'), true);
        try {
          const uid = state.firebaseUser.uid;
          for (const { key, cls } of drafts) {
            if (!cls.playlist || cls.attendees.size === 0) continue;
            const batch = db.batch();
            const classRef = db.collection('users').doc(uid).collection('classes').doc(safeDocId(key));
            batch.set(classRef, {
              date: cls.date, time: cls.time, playlist: cls.playlist,
              attendees: Array.from(cls.attendees), status: 'finalized',
              notes: cls.notes || '', dateTimeKey: key
            });
            const recordsRef = db.collection('users').doc(uid).collection('records');
            for (const guest of cls.attendees) {
              const recordKey = buildRecordKey({ date: cls.date, time: normalizeTime(cls.time), guest, playlist: cls.playlist });
              batch.set(recordsRef.doc(safeDocId(recordKey)), {
                date: cls.date, time: normalizeTime(cls.time), guest, playlist: cls.playlist, recordKey
              });
            }
            await batch.commit();
          }
          showToast(`Finalized ${drafts.length} class${drafts.length !== 1 ? 'es' : ''}!`, 'success');
        } catch (error) {
          showToast('Finalize failed: ' + error.message, 'error');
        } finally {
          setLoading($('#syncAllBtn'), false);
        }
      });

      // Weekly Planner Navigation
      $('#prevWeekBtn').addEventListener('click', () => navigateWeek(-1));
      $('#currentWeekBtn').addEventListener('click', () => navigateWeek(0));
      $('#nextWeekBtn').addEventListener('click', () => navigateWeek(1));

      // Auth Buttons
      const signInHandler = async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
        } catch (err) {
          if (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-browser') {
            auth.signInWithRedirect(provider);
          } else {
            showToast('Sign in failed: ' + err.message, 'error');
          }
        }
      };
      $('#signInBtn').addEventListener('click', signInHandler);
      $('#settingsSignInBtn').addEventListener('click', signInHandler);
      $('#signOutBtn').addEventListener('click', () => auth.signOut());
      $('#settingsSignOutBtn').addEventListener('click', () => auth.signOut());

      // Settings Buttons
      $('#clearDataBtn').addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
              try {
                if (state.firebaseUser) await clearAllFirestoreData();
              } catch (e) {
                console.error('Firestore clear error:', e);
              }
              localStorage.removeItem('hiloPlaylistData');
              state.records = [];
              state.allGuests.clear();
              state.weeklyPlan.clear();
              state.playlistTags = new Map();
              state.playlistStatus = new Map();
              window.location.reload();
          }
      });
      $('#importCsvBtn').addEventListener('click', () => $('#fileInput').click());
      $('#exportCsvBtn').addEventListener('click', exportToCsv);
      $('#fileInput').addEventListener('change', handleCsvImport);

      // Modals
      $$('#close-class-modal, #cancel-modal').forEach(btn => btn.addEventListener('click', () => $('#class-modal').classList.add('hidden')));
      $('#close-guest-modal').addEventListener('click', () => $('#guest-modal').classList.add('hidden'));
      $('#save-draft-modal').addEventListener('click', handleModalSave);
      $('#finalize-modal').addEventListener('click', handleModalFinalize);
      $('#delete-class-modal').addEventListener('click', handleModalDelete);
  }

  // --- Modal Handlers ---
  async function handleModalSave() {
      const cls = state.selectedClass;
      if (!cls) return;
      if (state.modalAttendees.size === 0) {
          showToast('Please select at least one guest.', 'error');
          return;
      }
      const newPlaylist = $('#modal-class-playlist').value;
      if (!newPlaylist) {
          showToast('Please select a playlist.', 'error');
          return;
      }

      const oldKey = createDateTimeKey(cls.date, cls.time);
      const newDate = $('#modal-class-date').value;
      const newTime = normalizeTime($('#modal-class-time').value);
      const newKey = createDateTimeKey(newDate, newTime);
      const collision = state.weeklyPlan.get(newKey);
      if (oldKey !== newKey && collision && collision !== cls) {
          showToast('A class already exists at that date and time.', 'error');
          return;
      }

      const classData = {
        date: newDate,
        time: newTime,
        playlist: normalizePlaylistId(newPlaylist),
        attendees: new Set(state.modalAttendees),
        status: 'draft',
        notes: $('#modal-class-notes').value || ''
      };
      if (!classData.playlist) {
        showToast('Playlist format is invalid.', 'error');
        return;
      }

      if (state.firebaseUser) {
        const uid = state.firebaseUser.uid;
        if (oldKey !== newKey) {
          const batch = db.batch();
          batch.delete(db.collection('users').doc(uid).collection('classes').doc(safeDocId(oldKey)));
          batch.set(db.collection('users').doc(uid).collection('classes').doc(safeDocId(newKey)), {
            ...classData, attendees: Array.from(classData.attendees), dateTimeKey: newKey
          });
          await batch.commit();
        } else {
          await saveClassToFirestore(newKey, classData);
        }
      } else {
        if (oldKey !== newKey) state.weeklyPlan.delete(oldKey);
        state.weeklyPlan.set(newKey, classData);
        saveStateToLocalStorage();
        renderWeeklyCalendar();
      }
      showToast('Draft saved!', 'success');
      $('#class-modal').classList.add('hidden');
  }

  async function handleModalFinalize() {
      const cls = state.selectedClass;
      if (!cls || state.modalAttendees.size === 0 || !$('#modal-class-playlist').value) {
          showToast('Please select attendees and a playlist.', 'error');
          return;
      }
      if (!state.firebaseUser) {
          showToast('Please sign in to finalize.', 'error');
          return;
      }
      if (cls.status === 'finalized') {
          showToast('This class is already finalized.', 'info');
          return;
      }
      setLoading($('#finalize-modal'), true);

      const oldKey = createDateTimeKey(cls.date, cls.time);
      const targetDate = $('#modal-class-date').value;
      const targetTime = normalizeTime($('#modal-class-time').value);
      const newKey = createDateTimeKey(targetDate, targetTime);
      const collision = state.weeklyPlan.get(newKey);
      if (oldKey !== newKey && collision && collision !== cls) {
          setLoading($('#finalize-modal'), false);
          showToast('A class already exists at that date and time.', 'error');
          return;
      }

      try {
        const uid = state.firebaseUser.uid;
        const batch = db.batch();
        const classesRef = db.collection('users').doc(uid).collection('classes');
        const recordsRef = db.collection('users').doc(uid).collection('records');
        const playlist = normalizePlaylistId($('#modal-class-playlist').value);
        if (!playlist) {
          showToast('Playlist format is invalid.', 'error');
          return;
        }
        const attendees = new Set(state.modalAttendees);
        const notes = $('#modal-class-notes').value || '';

        // Delete old class doc if date/time changed
        if (oldKey !== newKey) {
          batch.delete(classesRef.doc(safeDocId(oldKey)));
        }
        // Write finalized class
        batch.set(classesRef.doc(safeDocId(newKey)), {
          date: targetDate, time: targetTime, playlist,
          attendees: Array.from(attendees), status: 'finalized',
          notes, dateTimeKey: newKey
        });
        // Write attendance records
        for (const guest of attendees) {
          const recordKey = buildRecordKey({ date: targetDate, time: normalizeTime(targetTime), guest, playlist });
          batch.set(recordsRef.doc(safeDocId(recordKey)), {
            date: targetDate, time: normalizeTime(targetTime), guest, playlist, recordKey
          });
        }
        await batch.commit();
        showToast('Class finalized!', 'success');
        $('#class-modal').classList.add('hidden');
      } catch (error) {
        showToast('Finalize failed: ' + error.message, 'error');
      } finally {
        setLoading($('#finalize-modal'), false);
      }
  }
  async function handleModalDelete() {
    const cls = state.selectedClass;
    if (!cls) return;
    if (confirm('Are you sure you want to delete this class?')) {
        const key = createDateTimeKey(cls.date, cls.time);
        if (state.firebaseUser) {
          await deleteClassFromFirestore(key);
          // onSnapshot listener will update local state
        } else {
          state.weeklyPlan.delete(key);
          saveStateToLocalStorage();
          renderWeeklyCalendar();
        }
        showToast('Class deleted.', 'info');
        $('#class-modal').classList.add('hidden');
    }
  }
  // --- CSV Import/Export ---
  function exportToCsv() {
      if (state.records.length === 0) {
          showToast('No data to export.', 'info');
          return;
      }
      const headers = ['Date', 'Time', 'Guest', 'Playlist'];
      const csvRows = [headers.join(',')];
      state.records.forEach(r => {
          csvRows.push([r.date, r.time, `"${r.guest.replace(/"/g, '""')}"`, r.playlist].join(','));
      });
      const csvString = csvRows.join('\r\n');
      const blob = new Blob([csvString], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hilo_playlist_export_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV export complete.', 'success');
  }

  function parseCsvRow(row) {
      const fields = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < row.length; i++) {
          const ch = row[i];
          if (inQuotes) {
              if (ch === '"' && row[i + 1] === '"') {
                  current += '"';
                  i++; // skip escaped quote
              } else if (ch === '"') {
                  inQuotes = false;
              } else {
                  current += ch;
              }
          } else {
              if (ch === '"') {
                  inQuotes = true;
              } else if (ch === ',') {
                  fields.push(current);
                  current = '';
              } else {
                  current += ch;
              }
          }
      }
      fields.push(current);
      return fields;
  }
  function normalizeCsvHeader(header) {
      return (header || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
  }
  function buildCsvHeaderLookup(headers) {
      const map = new Map();
      headers.forEach((header, index) => {
          const normalized = normalizeCsvHeader(header);
          if (normalized && !map.has(normalized)) map.set(normalized, index);
      });
      return map;
  }
  function getCsvValue(cols, headerLookup, aliases, fallbackIndex = -1) {
      for (const alias of aliases) {
          const idx = headerLookup.get(alias);
          if (idx !== undefined && idx < cols.length) return (cols[idx] || '').trim();
      }
      if (fallbackIndex >= 0 && fallbackIndex < cols.length) return (cols[fallbackIndex] || '').trim();
      return '';
  }
  function normalizeImportedDate(rawDate) {
      const parsed = parseDateInput((rawDate || '').toString().trim());
      return parsed ? formatDateKey(parsed) : '';
  }

  function handleCsvImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
          const text = (e.target.result || '').toString();
          const rows = text.split(/\r?\n/).filter(row => row.trim().length > 0);
          if (rows.length === 0) {
              showToast('CSV appears empty.', 'error');
              return;
          }

          const headerCols = parseCsvRow(rows[0]);
          const headerLookup = buildCsvHeaderLookup(headerCols);
          const knownHeaders = new Set([
            'date', 'time', 'guest', 'playlist',
            'date of class', 'class time', 'guest name', 'playlist number', 'class type',
            'status', 'playlist status'
          ]);
          const hasKnownHeaders = headerCols.some(h => knownHeaders.has(normalizeCsvHeader(h)));
          const dataRows = hasKnownHeaders ? rows.slice(1) : rows;

          let importedCount = 0;
          const importedRecords = [];
          const taggedPlaylists = new Set();
          const statusPlaylists = new Set();
          dataRows.forEach(row => {
              if (!row.trim()) return;
              const cols = parseCsvRow(row);
              const playlistId = normalizePlaylistId(getCsvValue(cols, headerLookup, ['playlist', 'playlist number', 'playlist id'], 3));
              const playlistStatus = normalizePlaylistStatus(getCsvValue(cols, headerLookup, ['status', 'playlist status']));
              if (playlistId && playlistStatus) {
                if (state.playlistStatus.get(playlistId) !== playlistStatus) {
                  state.playlistStatus.set(playlistId, playlistStatus);
                }
                statusPlaylists.add(playlistId);
                ensurePlaylistInState(playlistId);
              }
              const date = normalizeImportedDate(getCsvValue(cols, headerLookup, ['date', 'date of class', 'class date'], 0));
              const time = normalizeTime(getCsvValue(cols, headerLookup, ['time', 'class time'], 1), '09:00');
              const guest = getCsvValue(cols, headerLookup, ['guest', 'guest name', 'name'], 2);
              const classType = getCsvValue(cols, headerLookup, ['class type', 'type'], 5).replace(/\s+/g, ' ').trim();
              const normalized = normalizeRecord({ date, time, guest, playlist: playlistId });
              if (!normalized) return;
              if (addRecordIfNew(normalized)) {
                  importedCount++;
                  importedRecords.push(normalized);
              }
              state.allGuests.add(normalized.guest);
              if (classType) {
                  const existingTags = state.playlistTags.get(normalized.playlist) || [];
                  if (!existingTags.includes(classType)) {
                    state.playlistTags.set(normalized.playlist, [...existingTags, classType]);
                    taggedPlaylists.add(normalized.playlist);
                  }
              }
          });
          rebuildPlaylistsFromData();
          populateModalPlaylistOptions();
          saveStateToLocalStorage();
          populateGuestList();
          updateRecordsPill();
          refreshAll();

          // Push to Firestore in chunked batches
          if (state.firebaseUser && (importedRecords.length > 0 || taggedPlaylists.size > 0 || statusPlaylists.size > 0)) {
            const uid = state.firebaseUser.uid;
            try {
              if (importedRecords.length > 0) {
                const recordsRef = db.collection('users').doc(uid).collection('records');
                const chunks = [];
                for (let i = 0; i < importedRecords.length; i += 500) {
                  chunks.push(importedRecords.slice(i, i + 500));
                }
                for (const chunk of chunks) {
                  const batch = db.batch();
                  chunk.forEach(r => {
                    const key = buildRecordKey(r);
                    batch.set(recordsRef.doc(safeDocId(key)), { ...r, recordKey: key });
                  });
                  await batch.commit();
                }
              }
              const playlistDocUpdates = new Set([...taggedPlaylists, ...statusPlaylists]);
              for (const playlistId of playlistDocUpdates) {
                const payload = {};
                if (taggedPlaylists.has(playlistId)) payload.classTypes = state.playlistTags.get(playlistId) || [];
                if (statusPlaylists.has(playlistId)) payload.status = state.playlistStatus.get(playlistId) || '';
                if (Object.keys(payload).length === 0) continue;
                await db.collection('users').doc(uid).collection('playlists').doc(playlistId).set(payload, { merge: true });
              }
              const details = [];
              if (taggedPlaylists.size > 0) details.push(`${taggedPlaylists.size} class-type tag set${taggedPlaylists.size !== 1 ? 's' : ''}`);
              if (statusPlaylists.size > 0) details.push(`${statusPlaylists.size} playlist status${statusPlaylists.size !== 1 ? 'es' : ''}`);
              const detailMsg = details.length > 0 ? ` and synced ${details.join(' and ')}` : '';
              showToast(`Imported ${importedCount} records${detailMsg} to Firebase`, 'success');
            } catch (err) {
              showToast(`Imported locally but Firebase sync failed: ${err.message}`, 'error');
            }
          } else {
            const details = [];
            if (taggedPlaylists.size > 0) details.push(`${taggedPlaylists.size} class-type tag set${taggedPlaylists.size !== 1 ? 's' : ''}`);
            if (statusPlaylists.size > 0) details.push(`${statusPlaylists.size} playlist status${statusPlaylists.size !== 1 ? 'es' : ''}`);
            const detailMsg = details.length > 0 ? ` and ${details.join(' and ')}` : '';
            showToast(`Imported ${importedCount} records${detailMsg}.`, 'success');
          }
      };
      reader.readAsText(file);
      $('#fileInput').value = ''; // Reset for next import
  }
  // --- Start the App ---
  document.addEventListener('DOMContentLoaded', initializeApp);
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(function(reg) {
      console.log('Service worker registered:', reg.scope);
    }).catch(function(err) {
      console.log('Service worker registration failed:', err);
    });
  }
</script>
</body>
</html>
