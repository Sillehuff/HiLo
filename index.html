<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Hilo Playlist ‚Äì Instructor Edition</title>
  <meta name="description" content="Professional class planning with playlist optimization and cloud sync" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><circle cx='24' cy='24' r='22' stroke='%236B5B8A' stroke-width='2' fill='none'/><path d='M14 30C16 20 20 16 24 16C28 16 32 20 34 30' stroke='%236B5B8A' stroke-width='3' stroke-linecap='round'/><path d='M12 36H36' stroke='%236B5B8A' stroke-width='2' stroke-linecap='round'/></svg>" />
  <meta name="theme-color" content="#F9F9FB" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

  <style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HILO PLAYLIST ‚Äî JONY IVE EDITION
       Precision minimalism. Warmth. Spatial perfection.
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    :root {
      /* Color System ‚Äî Refined Violet + Warm Neutrals */
      --violet-1: #FDFCFE;
      --violet-2: #F9F7FC;
      --violet-3: #F3EEFB;
      --violet-4: #EAE2F8;
      --violet-5: #DDD1F3;
      --violet-6: #CFBCEB;
      --violet-7: #BCA4DF;
      --violet-8: #A48ACF;
      --violet-9: #6E56CF;
      --violet-10: #634DBF;
      --violet-11: #5746AF;
      --violet-12: #20134B;

      --primary: var(--violet-9);
      --primary-hover: var(--violet-10);
      --primary-light: var(--violet-3);
      --primary-surface: var(--violet-2);

      /* Neutrals ‚Äî Warm Mauve undertone */
      --gray-1: #FDFCFD;
      --gray-2: #F9F8F9;
      --gray-3: #F3F1F3;
      --gray-4: #ECEAED;
      --gray-5: #E5E2E6;
      --gray-6: #DAD7DC;
      --gray-7: #CBC7D0;
      --gray-8: #B0ABB7;
      --gray-9: #8E8898;
      --gray-10: #837D8D;
      --gray-11: #65606D;
      --gray-12: #211F26;

      /* Semantic */
      --success: #30A46C;
      --success-light: #DDF3E4;
      --success-surface: #E9F9EE;
      --warning: #E5A220;
      --warning-light: #FFF1D0;
      --warning-surface: #FFF8E6;
      --danger: #E5484D;
      --danger-light: #FFE0E1;
      --danger-surface: #FFF0F0;
      --info: #3B82C9;
      --info-light: #D5EDFF;
      --info-surface: #EBF5FF;

      /* Layout */
      --page-bg: #F9F9FB;
      --surface: #FFFFFF;
      --surface-raised: #FFFFFF;
      --surface-sunken: #F4F3F6;
      --text-primary: var(--gray-12);
      --text-secondary: var(--gray-11);
      --text-tertiary: var(--gray-9);
      --text-quaternary: var(--gray-8);
      --border-subtle: rgba(0,0,0,0.04);
      --border-default: rgba(0,0,0,0.07);
      --border-strong: rgba(0,0,0,0.12);

      /* Elevation ‚Äî Apple-style layered shadows */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
      --shadow-lg: 0 8px 28px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      --shadow-xl: 0 20px 60px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06);
      --shadow-focus: 0 0 0 3px rgba(110,86,207,0.24);
      --shadow-primary: 0 2px 8px rgba(110,86,207,0.3);

      /* Radius ‚Äî Generous, Apple-like */
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 20px;
      --radius-xl: 24px;
      --radius-full: 999px;

      /* Spacing Scale */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-7: 32px;
      --space-8: 40px;
      --space-9: 48px;
      --space-10: 64px;

      /* Motion */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out: cubic-bezier(0.45, 0, 0.55, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --duration-fast: 0.15s;
      --duration-normal: 0.25s;
      --duration-slow: 0.4s;

      /* Safe Areas */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);

      /* Typography */
      --font-display: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --tracking-tight: -0.02em;
      --tracking-normal: -0.01em;
    }

    /* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      background: var(--page-bg);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 15px;
      line-height: 1.5;
      letter-spacing: var(--tracking-normal);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-text-size-adjust: 100%;
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    a { color: inherit; text-decoration: none; }
    ::selection { background: var(--violet-4); color: var(--violet-12); }

    /* ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ */
    .nav {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: calc(12px + var(--safe-top)) var(--space-6) 12px;
      min-height: 60px;
      background: rgba(249, 249, 251, 0.72);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 0.5px solid rgba(0,0,0,0.08);
    }

    .tabs {
      display: flex;
      gap: 2px;
      padding: 3px;
      background: var(--gray-3);
      border-radius: var(--radius-md);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }

    .tab-btn {
      padding: 8px 16px;
      border-radius: 11px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      font-family: var(--font-body);
      font-size: 13.5px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
      position: relative;
      letter-spacing: 0;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn .tab-icon { font-size: 15px; line-height: 1; }
    .tab-btn .tab-label { white-space: nowrap; }
    .tab-btn[aria-selected="true"] {
      background: var(--surface);
      color: var(--text-primary);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0.5px 1px rgba(0,0,0,0.08);
    }
    .tab-btn:hover:not([aria-selected="true"]) {
      color: var(--text-primary);
      background: rgba(255,255,255,0.5);
    }
    .tab-btn:active { transform: scale(0.97); }

    /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
    .container {
      max-width: 1200px;
      margin: var(--space-6) auto;
      padding: 0 var(--space-6);
      display: grid;
      gap: var(--space-6);
    }

    /* ‚îÄ‚îÄ Hero / Page Headers ‚îÄ‚îÄ */
    .hero {
      position: relative;
      border-radius: var(--radius-xl);
      padding: var(--space-7) var(--space-7);
      background: var(--surface);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--violet-8), var(--violet-9), var(--violet-7));
      opacity: 0.6;
    }
    .hero h1 {
      font-family: var(--font-display);
      font-size: clamp(24px, 3.5vw, 32px);
      font-weight: 700;
      letter-spacing: var(--tracking-tight);
      color: var(--text-primary);
      line-height: 1.2;
    }
    .subtle {
      color: var(--text-tertiary);
      font-weight: 400;
      font-size: 14px;
      margin-top: 4px;
    }
    .hero .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
    }

    /* ‚îÄ‚îÄ Pills / Badges ‚îÄ‚îÄ */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--surface-sunken);
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      border: none;
      transition: all var(--duration-fast) var(--ease-out);
    }

    /* ‚îÄ‚îÄ Class Type Tags ‚îÄ‚îÄ */
    .class-type-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--info-light);
      color: var(--info);
      border-radius: var(--radius-full);
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      letter-spacing: 0.01em;
    }
    .class-type-tag.compact {
      padding: 2px 7px;
      font-size: 11px;
    }
    .playlist-tags-inline {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-left: 6px;
      vertical-align: middle;
    }

    /* ‚îÄ‚îÄ Tag Editor ‚îÄ‚îÄ */
    .tag-editor-row td {
      background: var(--surface-sunken) !important;
      padding: 16px 20px !important;
    }
    .tag-editor { display: flex; flex-direction: column; gap: 10px; }
    .tag-editor-chips { display: flex; flex-wrap: wrap; gap: 6px; min-height: 28px; }
    .tag-chip-removable {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--info-light);
      color: var(--info);
      border-radius: var(--radius-full);
      padding: 5px 10px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      animation: fadeIn var(--duration-normal) var(--ease-out);
    }
    .remove-tag {
      cursor: pointer;
      opacity: 0.6;
      transition: all var(--duration-fast);
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      min-height: 24px;
      border-radius: 50%;
    }
    .remove-tag:hover { opacity: 1; background: rgba(0,0,0,0.06); }
    .tag-input-wrapper { position: relative; }
    .tag-input-wrapper input {
      width: 200px;
      padding: 8px 12px;
      background: var(--surface);
      border: 1.5px solid var(--gray-5);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      transition: all var(--duration-fast);
    }
    .tag-input-wrapper input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: var(--shadow-focus);
    }
    .tag-autocomplete {
      position: absolute;
      top: 100%;
      left: 0;
      width: 200px;
      max-height: 160px;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      margin-top: 4px;
      z-index: 50;
      box-shadow: var(--shadow-lg);
    }
    .tag-autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-primary);
      transition: background var(--duration-fast);
    }
    .tag-autocomplete-item:hover,
    .tag-autocomplete-item.active { background: var(--surface-sunken); }

    /* ‚îÄ‚îÄ Explorer / Playlist Manager ‚îÄ‚îÄ */
    .explorer-row { cursor: pointer; transition: background var(--duration-fast); }
    .explorer-row:hover { background: var(--gray-2) !important; }
    .explorer-row.retired-row { opacity: 0.5; }

    .add-playlist-form { margin-bottom: 0; }
    .add-playlist-form .input-field {
      padding: 10px 14px;
      background: var(--surface);
      border: 1.5px solid var(--gray-5);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      transition: all var(--duration-fast);
    }
    .add-playlist-form .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: var(--shadow-focus);
    }

    /* ‚îÄ‚îÄ Status Pills ‚îÄ‚îÄ */
    .status-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 14px;
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all var(--duration-normal) var(--ease-spring);
      user-select: none;
      letter-spacing: 0.02em;
    }
    .status-toggle.active {
      background: var(--success-light);
      color: var(--success);
    }
    .status-toggle.retired {
      background: var(--surface-sunken);
      color: var(--text-tertiary);
    }
    .status-toggle:hover { transform: scale(1.04); }
    .status-toggle:active { transform: scale(0.96); }

    .btn-remove-playlist {
      background: transparent;
      border: 1.5px solid var(--danger-light);
      color: var(--danger);
      border-radius: var(--radius-sm);
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast);
    }
    .btn-remove-playlist:hover {
      background: var(--danger-surface);
    }

    .btn-ghost {
      background: transparent;
      border: 1.5px solid var(--gray-5);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all var(--duration-fast);
    }
    .btn-ghost:hover { background: var(--surface-sunken); }

    .manager-tags-cell { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
    .manager-tags-cell .add-tag-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: var(--radius-full);
      background: transparent;
      border: 1.5px dashed var(--gray-6);
      color: var(--text-quaternary);
      cursor: pointer;
      font-size: 14px;
      transition: all var(--duration-fast);
    }
    .manager-tags-cell .add-tag-btn:hover {
      background: var(--primary-light);
      border-color: var(--violet-6);
      color: var(--primary);
    }

    /* ‚îÄ‚îÄ Status Indicators ‚îÄ‚îÄ */
    .status-connected { background: var(--success-light); color: var(--success); }
    .status-disconnected { background: var(--danger-light); color: var(--danger); }
    .status-draft { background: var(--warning-light); color: #9A6700; }
    .status-finalized { background: var(--success-light); color: var(--success); }
    .status-info { background: var(--info-light); color: var(--info); }

    /* ‚îÄ‚îÄ History Action Buttons ‚îÄ‚îÄ */
    .history-actions { display: flex; gap: 4px; align-items: center; }
    .history-edit-btn,
    .history-delete-btn {
      background: transparent;
      border: 1.5px solid var(--gray-5);
      border-radius: var(--radius-sm);
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all var(--duration-fast);
      color: var(--text-tertiary);
      touch-action: manipulation;
      min-height: 36px;
    }
    .history-edit-btn:hover { background: var(--surface-sunken); color: var(--text-primary); }
    .history-delete-btn:hover { background: var(--danger-surface); border-color: var(--danger-light); color: var(--danger); }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: var(--space-6);
    }
    .card {
      position: relative;
      border-radius: var(--radius-lg);
      background: var(--surface);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: all var(--duration-normal) var(--ease-out);
    }
    .card:hover { box-shadow: var(--shadow-md); }
    .card .body { padding: var(--space-6); }
    .card .title {
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 16px;
      letter-spacing: var(--tracking-tight);
      color: var(--text-primary);
    }
    .card .muted { color: var(--text-tertiary); font-size: 14px; margin-top: 2px; }

    .primary-card {
      border: none;
      border-left: none;
      background: var(--surface);
      position: relative;
    }
    .primary-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--violet-8), var(--violet-9));
      border-radius: 0 4px 4px 0;
    }
    .primary-card .title {
      font-size: 20px;
      font-weight: 700;
    }

    /* ‚îÄ‚îÄ Metrics ‚îÄ‚îÄ */
    .metric-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    .metric {
      background: var(--surface-sunken);
      border-radius: var(--radius-md);
      padding: 16px 12px;
      text-align: center;
      border: none;
      transition: all var(--duration-fast);
    }
    .metric:hover { background: var(--gray-3); }
    .metric .value {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 22px;
      color: var(--text-primary);
      letter-spacing: var(--tracking-tight);
    }
    .metric .label {
      color: var(--text-tertiary);
      font-size: 11px;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Tooltips ‚îÄ‚îÄ */
    .info-tip {
      position: relative;
      cursor: help;
      opacity: 0.4;
      font-size: 12px;
      font-style: normal;
      transition: opacity var(--duration-fast);
    }
    .info-tip:hover, .info-tip:focus { opacity: 0.8; }
    .info-tip .tip-text {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: 10px 14px;
      font-size: 12.5px;
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      white-space: normal;
      width: 220px;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--duration-fast);
      z-index: 100;
      box-shadow: var(--shadow-lg);
      color: var(--text-primary);
      line-height: 1.5;
    }
    .info-tip .tip-text::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--surface);
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.05));
    }
    .info-tip:hover .tip-text, .info-tip:focus .tip-text { opacity: 1; }

    .tooltip-wrapper { position: relative; display: inline-block; }
    .tooltip-wrapper .tooltip-text {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: 8px 14px;
      font-size: 12.5px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--duration-fast);
      z-index: 100;
      box-shadow: var(--shadow-lg);
      color: var(--text-primary);
    }
    .tooltip-wrapper .tooltip-text::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--surface);
    }
    .tooltip-wrapper:hover .tooltip-text { opacity: 1; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      background: var(--surface);
      border: 1.5px solid var(--gray-5);
      color: var(--text-primary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      font-family: var(--font-body);
      font-weight: 600;
      font-size: 14px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      letter-spacing: 0;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover { background: var(--gray-2); border-color: var(--gray-6); }
    .btn:focus-visible { box-shadow: var(--shadow-focus); }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn:disabled:hover { transform: none; background: var(--surface); }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }
    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      box-shadow: var(--shadow-primary);
    }
    .btn-success { background: var(--success); border-color: var(--success); color: #fff; }
    .btn-success:hover { background: #2B9762; box-shadow: 0 2px 8px rgba(48,164,108,0.3); }
    .btn-warning { background: var(--warning); border-color: var(--warning); color: #fff; }
    .btn-warning:hover { background: #D49520; }
    .btn-danger { background: var(--danger); border-color: var(--danger); color: #fff; }
    .btn-danger:hover { background: #D13B3F; }
    .btn-info { background: var(--info); border-color: var(--info); color: #fff; }
    .btn-info:hover { background: #3575B5; }

    .btn-sm {
      padding: 8px 14px;
      font-size: 13px;
      min-height: 36px;
      border-radius: var(--radius-sm);
    }
    .btn-xs {
      padding: 7px 12px;
      min-height: 36px;
      font-size: 13px;
      border-radius: var(--radius-sm);
      background: var(--surface-sunken);
      border: 1.5px solid var(--gray-5);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast);
      font-family: var(--font-body);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }
    .btn-xs:hover { background: var(--gray-3); color: var(--text-primary); }

    /* ‚îÄ‚îÄ Recommendation Cards ‚îÄ‚îÄ */
    .suggestions { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: var(--space-6); }
    .recommender-explain { margin-top: 10px; font-size: 13px; color: var(--text-tertiary); }

    .best-strength-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .rec-strength-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: var(--radius-full);
      padding: 5px 12px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.02em;
      border: none;
    }
    .rec-strength-pill.strong { background: var(--success-light); color: var(--success); }
    .rec-strength-pill.moderate { background: var(--warning-light); color: #9A6700; }
    .rec-strength-pill.close { background: var(--info-light); color: var(--info); }

    .best-summary-title {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      line-height: 1.2;
      margin-top: 8px;
      letter-spacing: var(--tracking-tight);
    }
    .best-summary-meta { margin-top: 6px; color: var(--text-tertiary); font-size: 13px; }
    .best-insight-list { margin-top: 12px; display: grid; gap: 8px; }
    .best-insight {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13.5px;
      color: var(--text-primary);
      background: var(--surface-sunken);
      border-radius: var(--radius-md);
      padding: 10px 14px;
      border: none;
    }
    .best-insight b {
      font-family: var(--font-display);
      color: var(--primary);
      min-width: 38px;
      text-align: right;
      font-size: 15px;
    }

    .rank-row-assigned td { background: rgba(48,164,108,0.04); }
    .rank-score {
      font-family: var(--font-display);
      font-weight: 700;
      color: var(--primary);
    }
    .dashboard-rankings-wrap { overflow-x: auto; }

    /* ‚îÄ‚îÄ Class Picker ‚îÄ‚îÄ */
    .class-picker-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--duration-fast);
      font-size: 13.5px;
    }
    .class-picker-item:hover { background: var(--gray-2); }
    .class-picker-item input[type="checkbox"] {
      accent-color: var(--primary);
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .class-picker-item.checked { background: var(--primary-light); }
    .class-picker-item .class-picker-label { flex: 1; line-height: 1.4; }

    /* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
    .search-container {
      position: relative;
      max-width: 300px;
    }
    .search-container input {
      width: 100%;
      padding: 11px 40px 11px 40px;
      border-radius: var(--radius-sm);
      background: var(--surface-sunken);
      border: 1.5px solid transparent;
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      transition: all var(--duration-fast);
    }
    .search-container input:focus {
      outline: none;
      background: var(--surface);
      border-color: var(--primary);
      box-shadow: var(--shadow-focus);
    }
    .search-container::before {
      content: 'üîç';
      position: absolute;
      left: 13px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
      pointer-events: none;
      font-size: 14px;
    }
    .search-container.no-icon::before { content: none; }
    .search-container.no-icon input { padding-left: 14px; }
    .search-clear {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--gray-4);
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 12px;
      transition: all var(--duration-fast);
      padding: 0;
    }
    .search-clear:hover { background: var(--gray-5); color: var(--text-primary); }
    .search-clear.visible { display: flex; }
    .search-result-count { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; min-height: 16px; }
    .search-wrap { display: flex; gap: 8px; flex-wrap: wrap; }
    .search {
      flex: 1;
      min-width: 240px;
      background: var(--surface-sunken);
      border: 1.5px solid transparent;
      padding: 11px 14px;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      transition: all var(--duration-fast);
    }
    .search:focus {
      outline: none;
      background: var(--surface);
      border-color: var(--primary);
      box-shadow: var(--shadow-focus);
    }
    .select {
      min-width: 160px;
      background: var(--surface-sunken);
      border: 1.5px solid transparent;
      padding: 11px 14px;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      cursor: pointer;
      transition: all var(--duration-fast);
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5' stroke='%238E8898' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }
    .select:focus {
      outline: none;
      background-color: var(--surface);
      border-color: var(--primary);
      box-shadow: var(--shadow-focus);
    }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .table-container {
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--surface);
    }
    .table-container.dashboard-rankings-wrap { overflow-x: auto; }
    .dashboard-rankings-wrap .data-table { min-width: 700px; }

    .data-table { width: 100%; border-collapse: collapse; background: transparent; }
    .data-table th, .data-table td {
      text-align: left;
      padding: 14px 20px;
      border-bottom: 0.5px solid var(--border-subtle);
    }
    .data-table th {
      color: var(--text-tertiary);
      font-weight: 600;
      background: var(--surface-sunken);
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .data-table tbody tr { transition: background var(--duration-fast); }
    .data-table tbody tr:hover { background: var(--gray-1); }
    .data-table tbody tr:last-child td { border-bottom: none; }

    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 28px !important;
    }
    .sortable:hover { color: var(--primary); }
    .sortable::after { content: '‚Üï'; position: absolute; right: 10px; opacity: 0.3; font-size: 11px; }
    .sortable.asc::after { content: '‚Üë'; opacity: 0.8; }
    .sortable.desc::after { content: '‚Üì'; opacity: 0.8; }

    /* ‚îÄ‚îÄ Section Headers ‚îÄ‚îÄ */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .section-header h2 {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: var(--tracking-tight);
    }

    /* ‚îÄ‚îÄ Weekly Nav ‚îÄ‚îÄ */
    .weekly-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 16px 20px 10px;
    }
    .week-nav-btn {
      width: 34px; height: 34px;
      border-radius: 50%;
      border: none;
      background: var(--surface);
      box-shadow: var(--shadow-xs);
      font-size: 18px;
      font-weight: 400;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .week-nav-btn:hover { background: var(--gray-3); color: var(--text-primary); }
    .week-nav-btn:active { transform: scale(0.92); }
    .week-nav-label {
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
      padding: 0 6px;
      letter-spacing: var(--tracking-tight);
      white-space: nowrap;
    }
    .week-nav-today-btn {
      margin-left: 4px;
      padding: 5px 12px;
      border-radius: var(--radius-full);
      border: 1.5px solid var(--primary);
      background: transparent;
      color: var(--primary);
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      flex-shrink: 0;
    }
    .week-nav-today-btn:hover { background: var(--primary); color: white; }

    /* ‚îÄ‚îÄ Week Strip (mobile only, hidden on desktop) ‚îÄ‚îÄ */
    .week-strip { display: none; }

    /* ‚îÄ‚îÄ Desktop Calendar Grid ‚îÄ‚îÄ */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 4px;
      padding: 0 4px;
    }

    /* ‚îÄ‚îÄ Day Card (desktop base) ‚îÄ‚îÄ */
    .day-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 14px;
      min-height: 120px;
      transition: all var(--duration-normal) var(--ease-out);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xs);
      border: 1.5px solid transparent;
      position: relative;
    }
    .day-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }

    /* Empty */
    .day-card.empty {
      min-height: unset;
      background: transparent;
      box-shadow: none;
      border: 1.5px dashed var(--gray-5);
      padding: 12px 14px;
      flex-direction: row;
      align-items: center;
      gap: 12px;
    }
    .day-card.empty:hover { border-color: var(--violet-6); background: var(--violet-2); box-shadow: none; transform: none; }
    .day-card.empty .day-header { margin-bottom: 0; flex-shrink: 0; }
    .day-card.empty .class-list { display: none; }
    .day-card.empty .class-actions { margin-top: 0; margin-left: auto; }

    /* Today */
    .day-card.today {
      background: var(--violet-2);
      border-color: var(--violet-6);
      box-shadow: var(--shadow-sm);
    }
    .day-card.today:hover { box-shadow: var(--shadow-md); }
    .day-card.today .day-badge { background: var(--primary); color: white; }
    .day-card.today .day-name-text { color: var(--primary); font-weight: 700; }
    .day-card.today.empty { border-style: solid; }

    /* Past */
    .day-card.day-past:not(.today) { opacity: 0.6; }
    .day-card.day-past:not(.today):hover { opacity: 0.9; }

    /* ‚îÄ‚îÄ Day Header (desktop: stacked centered) ‚îÄ‚îÄ */
    .day-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      margin-bottom: 10px;
    }
    .day-badge {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-3);
      color: var(--text-primary);
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
      transition: all var(--duration-fast) var(--ease-out);
    }
    .day-name-text {
      font-family: var(--font-display);
      font-weight: 500;
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .day-today-label {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 9px;
      color: white;
      background: var(--primary);
      padding: 1px 6px;
      border-radius: var(--radius-full);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .day-name { display: contents; }

    /* ‚îÄ‚îÄ Class Items ‚îÄ‚îÄ */
    .class-list { flex-grow: 1; }
    .class-item {
      background: var(--surface-sunken);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      margin-bottom: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      border-left: 3px solid var(--gray-6);
      border-top: none;
      border-right: none;
      border-bottom: none;
    }
    .class-item.status-draft-bar { border-left-color: var(--warning); }
    .class-item.status-finalized-bar { border-left-color: var(--success); }
    .class-item:hover { background: var(--gray-3); transform: translateX(2px); }
    .class-time {
      font-family: var(--font-display);
      font-weight: 600;
      color: var(--primary);
      font-size: 13px;
    }
    .class-info { color: var(--text-secondary); font-size: 12px; margin-top: 2px; }

    .class-actions { display: flex; gap: 8px; margin-top: 10px; }

    /* ‚îÄ‚îÄ Guest Grid ‚îÄ‚îÄ */
    .guests-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .guest-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 22px;
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-out);
      box-shadow: var(--shadow-xs);
      border: none;
    }
    .guest-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
    .guest-card-header { display: flex; gap: 14px; align-items: center; margin-bottom: 18px; }
    .guest-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--violet-8), var(--violet-9));
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 17px;
      color: #fff;
      flex-shrink: 0;
    }
    .guest-info h4 {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: var(--tracking-tight);
    }
    .guest-info p { font-size: 13px; color: var(--text-tertiary); margin-top: 2px; }
    .guest-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .guest-stat {
      text-align: center;
      padding: 10px;
      background: var(--surface-sunken);
      border-radius: var(--radius-sm);
    }
    .guest-stat .value {
      display: block;
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
    }
    .guest-stat .label {
      display: block;
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: modalFadeIn var(--duration-normal) var(--ease-out);
    }
    .modal__content {
      background: var(--surface);
      border-radius: var(--radius-xl);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
      animation: modalSlideUp var(--duration-slow) var(--ease-out);
      border: none;
    }
    .modal__drag-handle { display: none; }
    .modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-6);
      border-bottom: 0.5px solid var(--border-subtle);
      flex-shrink: 0;
    }
    .modal__header h3 {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: var(--tracking-tight);
    }
    .modal__close {
      background: var(--surface-sunken);
      border: none;
      font-size: 18px;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all var(--duration-fast);
    }
    .modal__close:hover { background: var(--gray-4); color: var(--text-primary); }
    .modal__body { padding: var(--space-6); overflow-y: auto; min-height: 0; }
    .modal__footer {
      padding: 16px var(--space-6);
      border-top: 0.5px solid var(--border-subtle);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Modal Recommendation ‚îÄ‚îÄ */
    .modal-recommendation {
      background: var(--primary-light);
      border-radius: var(--radius-lg);
      padding: 18px;
      margin-bottom: 16px;
      border: none;
    }
    .modal-rec-title {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 12px;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .modal-rec-best-name {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .modal-rec-best-name .accent { color: var(--primary); }
    .modal-rec-alt-pill {
      padding: 7px 14px;
      min-height: 36px;
      background: var(--surface);
      border: 1.5px solid var(--gray-5);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .modal-rec-alt-pill:hover {
      background: var(--primary-light);
      border-color: var(--violet-5);
      transform: translateY(-1px);
    }
    .modal-rec-use-btn {
      padding: 7px 18px;
      min-height: 36px;
      background: var(--primary);
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast);
    }
    .modal-rec-use-btn:hover { background: var(--primary-hover); box-shadow: var(--shadow-primary); }

    /* ‚îÄ‚îÄ Forms ‚îÄ‚îÄ */
    .form-group { margin-bottom: 20px; }
    .form-section-divider {
      border: none;
      border-top: 0.5px solid var(--border-subtle);
      margin: 4px 0 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
      font-family: var(--font-display);
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 11px 14px;
      background: var(--surface-sunken);
      border: 1.5px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      transition: all var(--duration-fast);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      background: var(--surface);
      border-color: var(--primary);
      box-shadow: var(--shadow-focus);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-row--always-inline { grid-template-columns: 1fr 1fr !important; }
    .form-group input[type="date"] { -webkit-appearance: none; appearance: none; }

    /* ‚îÄ‚îÄ Connection Status ‚îÄ‚îÄ */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-size: 13.5px;
      font-weight: 500;
      border: none;
    }
    .connection-status.connected { background: var(--success-light); color: var(--success); }
    .connection-status.disconnected { background: var(--danger-light); color: var(--danger); }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .status-dot.connected { background: var(--success); }
    .status-dot.disconnected { background: var(--danger); }

    /* ‚îÄ‚îÄ Empty States ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 64px 24px;
      color: var(--text-tertiary);
    }
    .empty-state-icon { font-size: 56px; line-height: 1; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .empty-state p { font-size: 14px; margin-top: 6px; }

    /* ‚îÄ‚îÄ Step Labels ‚îÄ‚îÄ */
    .step-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-family: var(--font-display);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--primary);
    }
    .step-label .step-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary-light);
      font-size: 12px;
      font-weight: 800;
      color: var(--primary);
    }

    /* ‚îÄ‚îÄ Guest Selector ‚îÄ‚îÄ */
    .guest-selector {
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: var(--surface-sunken);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: none;
    }
    .guest-selector-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .selected-guests-container {
      min-height: 50px;
      max-height: 300px;
      overflow-y: auto;
      padding: 12px;
      background: var(--surface);
      border-radius: var(--radius-md);
      border: none;
    }
    .selected-guests { display: flex; flex-wrap: wrap; gap: 8px; }
    .no-selection { color: var(--text-quaternary); font-style: italic; padding: 8px 4px; font-size: 14px; }
    .selected-guest-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--primary-light);
      border: none;
      border-radius: var(--radius-full);
      padding: 6px 14px;
      font-size: 14px;
      animation: fadeIn var(--duration-normal) var(--ease-out);
      cursor: grab;
      transition: all var(--duration-fast);
      user-select: none;
    }
    .selected-guest-item.dragging { opacity: 0.4; }
    .selected-guest-item.drag-over { box-shadow: inset 0 0 0 2px var(--primary); }
    .selected-guest-item.touch-clone {
      opacity: 0.85;
      box-shadow: var(--shadow-lg);
      transform: scale(1.05);
    }
    .drag-handle {
      cursor: grab;
      opacity: 0.4;
      font-size: 14px;
      touch-action: none;
      transition: opacity var(--duration-fast);
    }
    .drag-handle:hover, .selected-guest-item:hover .drag-handle { opacity: 0.8; }
    .remove-guest {
      cursor: pointer;
      opacity: 0.5;
      transition: all var(--duration-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      min-height: 24px;
      border-radius: 50%;
      font-size: 12px;
    }
    .remove-guest:hover { opacity: 1; background: rgba(0,0,0,0.06); }

    .guest-list-container {
      max-height: 225px;
      overflow-y: auto;
      background: var(--surface);
      border-radius: var(--radius-md);
      border: none;
    }
    .guest-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
      padding: 12px;
    }
    .guest-list-item {
      background: var(--surface-sunken);
      border: 1.5px solid transparent;
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      min-height: 44px;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    .guest-list-item:hover {
      background: var(--gray-3);
      transform: translateY(-1px);
    }
    .guest-list-item.selected {
      background: var(--primary-light);
      border-color: var(--violet-5);
      font-weight: 500;
    }

    /* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */
    .stats-bar {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      padding: 14px 22px;
      background: var(--surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xs);
      margin-bottom: 16px;
      border: none;
    }
    .stats-bar .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .stats-bar .stat-value {
      font-family: var(--font-display);
      font-weight: 700;
      color: var(--primary);
    }

    /* ‚îÄ‚îÄ Date/Time Selector ‚îÄ‚îÄ */
    .datetime-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      background: var(--surface-sunken);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: none;
      margin: 16px 0;
    }
    .datetime-selector label { font-weight: 600; color: var(--text-primary); font-size: 14px; }
    .datetime-selector input {
      padding: 10px 14px;
      background: var(--surface);
      border: 1.5px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
    }
    .datetime-selector input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: var(--shadow-focus);
    }

    /* ‚îÄ‚îÄ Toast Notifications ‚îÄ‚îÄ */
    #toast-container {
      position: fixed;
      bottom: calc(24px + var(--safe-bottom));
      right: calc(24px + var(--safe-right));
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      min-width: 280px;
      max-width: 420px;
      background: var(--surface);
      color: var(--text-primary);
      padding: 14px 20px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 500;
      line-height: 1.4;
      border: none;
      border-left: 3px solid var(--primary);
      animation: slideInRight var(--duration-normal) var(--ease-out);
      cursor: pointer;
    }
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.info { border-left-color: var(--info); }

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2.5px solid var(--gray-4);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.8s ease-in-out infinite;
    }

    /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modalSlideUp {
      from { transform: translateY(24px) scale(0.97); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes sectionEnter {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section-enter { animation: sectionEnter var(--duration-normal) var(--ease-out) both; }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    @media (hover: none) {
      .tab-btn:hover, .card:hover, .day-card:hover, .guest-card:hover, .btn:hover {
        transform: none !important;
        box-shadow: none;
      }
    }

    .hidden { display: none !important; }
    .fade-in { animation: fadeIn var(--duration-normal) var(--ease-out) both; }

    /* ‚îÄ‚îÄ Debug Panel ‚îÄ‚îÄ */
    .debug-panel {
      position: fixed; bottom: 10px; left: 10px;
      background: rgba(0,0,0,.92); color: #fff;
      padding: 12px; border-radius: var(--radius-sm);
      font-size: 11px; max-width: 300px; max-height: 200px;
      overflow-y: auto; display: none; z-index: 10000;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }
    .debug-panel.show { display: block; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       RESPONSIVE ‚Äî TABLET
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    @media (max-width: 1024px) {
      .calendar-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }
    }
    @media (max-width: 900px) {
      .calendar-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       RESPONSIVE ‚Äî MOBILE
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    @media (max-width: 768px) {
      body { padding-bottom: calc(80px + var(--safe-bottom)); }
      .container { margin: 12px auto; padding: 0 16px; }

      .nav {
        position: sticky;
        top: 0;
        padding: calc(6px + var(--safe-top)) 12px 6px;
        min-height: 44px;
        background: rgba(249, 249, 251, 0.96);
      }

      /* Mobile bottom tab bar */
      body > .tabs {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        z-index: 200;
        background: rgba(249, 249, 251, 0.96);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-top: 0.5px solid rgba(0,0,0,0.08);
        border-radius: 0;
        padding: 4px calc(4px + var(--safe-right)) calc(4px + var(--safe-bottom)) calc(4px + var(--safe-left));
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 0;
      }
      body > .tabs .tab-btn {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 2px;
        padding: 6px 2px 4px;
        border-radius: var(--radius-sm);
        font-size: 10px;
        min-width: 0;
        min-height: 50px;
        background: transparent;
      }
      body > .tabs .tab-btn .tab-icon { font-size: 22px; }
      body > .tabs .tab-btn .tab-label { display: none; }
      body > .tabs .tab-btn[aria-selected="true"] {
        background: transparent;
        box-shadow: none;
      }
      body > .tabs .tab-btn[aria-selected="true"] .tab-icon { color: var(--primary); }
      body > .tabs .tab-btn[aria-selected="true"]::after {
        content: '';
        display: block;
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: var(--primary);
        margin-top: 2px;
      }

      .search-container { max-width: 100%; width: 100%; }
      .btn-sm, .search-clear, .modal__close, .status-toggle, .manager-tags-cell .add-tag-btn, .btn-remove-playlist { min-height: 44px; }
      .search-clear, .modal__close { width: 40px; height: 40px; }
      .search-container input { padding-right: 52px; }
      .search-container input,
      .search, .select,
      .form-group input, .form-group select, .form-group textarea,
      .add-playlist-form .input-field,
      .datetime-selector input,
      .tag-input-wrapper input { font-size: 16px; }

      .calendar-grid { display: flex; flex-direction: column; gap: 0; margin-top: 0; padding: 0 16px; }

      .weekly-nav { padding: 12px 16px 4px; gap: 4px; }
      .week-nav-label { font-size: 15px; }
      .week-nav-btn { width: 30px; height: 30px; font-size: 16px; }
      .week-nav-today-btn { padding: 4px 10px; font-size: 11px; }

      /* ‚îÄ‚îÄ Week Strip ‚Äî horizontal date circles for instant orientation ‚îÄ‚îÄ */
      .week-strip {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 6px 20px 14px;
        gap: 2px;
        border-bottom: 1px solid var(--border-subtle);
        margin: 0 16px;
      }
      .week-strip-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        flex: 1;
        cursor: default;
        min-width: 0;
      }
      .week-strip-name {
        font-family: var(--font-display);
        font-size: 10px;
        font-weight: 600;
        color: var(--text-quaternary);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .week-strip-num {
        width: 34px; height: 34px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--font-display);
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
        transition: all var(--duration-fast) var(--ease-out);
      }
      .week-strip-indicator {
        height: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .week-strip-dot {
        width: 5px; height: 5px;
        border-radius: 50%;
        background: var(--primary);
      }
      .week-strip-dot.draft-dot { background: var(--warning); }
      .week-strip-dot.finalized-dot { background: var(--success); }

      /* Strip: today */
      .week-strip-day.is-today .week-strip-num {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 8px rgba(110, 86, 207, 0.35);
      }
      .week-strip-day.is-today .week-strip-name {
        color: var(--primary);
        font-weight: 700;
      }
      /* Strip: past */
      .week-strip-day.is-past .week-strip-num { color: var(--text-tertiary); }
      .week-strip-day.is-past .week-strip-dot { opacity: 0.5; }
      /* Strip: has-classes highlight */
      .week-strip-day.has-events .week-strip-num {
        background: var(--gray-3);
        font-weight: 700;
      }
      .week-strip-day.has-events.is-today .week-strip-num {
        background: var(--primary);
        color: white;
      }

      /* ‚îÄ‚îÄ Mobile Agenda Day Sections ‚îÄ‚îÄ */
      .day-card {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        border: none;
        border-bottom: 1px solid var(--border-subtle);
        padding: 0 0 16px 0;
        min-height: unset;
        display: flex;
        flex-direction: column;
      }
      .day-card:last-child { border-bottom: none; }
      .day-card:hover { box-shadow: none; transform: none; }

      /* Day section header ‚Äî horizontal row */
      .day-card .day-header {
        flex-direction: row;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        padding: 12px 0 0;
      }
      .day-card .day-name { display: flex; flex-direction: row; align-items: center; gap: 10px; }
      .day-card .day-badge {
        width: 36px; height: 36px;
        font-size: 15px;
        background: var(--gray-3);
        color: var(--text-primary);
      }
      .day-card .day-name-text {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: none;
        letter-spacing: normal;
      }
      .day-card .day-today-label {
        font-size: 9px;
        padding: 2px 7px;
      }

      /* Class items get card treatment on mobile */
      .day-card .class-item {
        background: var(--surface);
        box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
        border-radius: var(--radius-md);
        padding: 12px 14px;
        margin-bottom: 8px;
        margin-left: 0;
      }
      .day-card .class-item:hover { transform: none; }
      .day-card .class-actions { margin-top: 4px; }

      /* ‚îÄ‚îÄ Today ‚Äî hero section ‚îÄ‚îÄ */
      .day-card.today {
        padding-bottom: 20px;
        border-bottom: 2px solid var(--violet-4);
      }
      .day-card.today .day-header { padding-top: 16px; }
      .day-card.today .day-badge {
        background: var(--primary);
        color: white;
        width: 40px; height: 40px;
        font-size: 16px;
        box-shadow: 0 2px 10px rgba(110, 86, 207, 0.3);
      }
      .day-card.today .day-name-text {
        color: var(--primary);
        font-weight: 700;
        font-size: 15px;
      }
      .day-card.today .class-item {
        background: var(--violet-2);
        border-left-color: var(--primary);
        box-shadow: 0 1px 4px rgba(110, 86, 207, 0.1);
      }

      /* ‚îÄ‚îÄ Empty days ‚Äî visible, tappable rows ‚îÄ‚îÄ */
      .day-card.empty {
        padding: 4px 0 8px;
        flex-direction: row;
        align-items: center;
        gap: 10px;
      }
      .day-card.empty .day-header {
        margin-bottom: 0;
        padding: 6px 0;
        flex: 1;
      }
      .day-card.empty .day-badge {
        width: 32px; height: 32px;
        font-size: 13px;
        background: var(--gray-3);
        color: var(--text-secondary);
        font-weight: 600;
      }
      .day-card.empty .day-name-text {
        font-size: 13px;
        color: var(--text-tertiary);
        font-weight: 500;
      }
      .day-card.empty .class-actions { margin-top: 0; margin-left: auto; flex-shrink: 0; }
      .day-card.empty .class-actions .btn {
        font-size: 13px;
        padding: 6px 14px;
        min-height: 34px;
        border: 1.5px dashed var(--gray-5);
        background: transparent;
        color: var(--text-tertiary);
        border-radius: var(--radius-md);
        font-weight: 500;
      }
      .day-card.empty:active .class-actions .btn,
      .day-card.empty .class-actions .btn:active {
        background: var(--violet-2);
        border-color: var(--primary);
        color: var(--primary);
      }
      .day-card.today.empty {
        padding: 4px 0 8px;
      }
      .day-card.today.empty .day-badge {
        width: 36px; height: 36px;
        font-size: 14px;
        background: var(--primary);
        color: white;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(110, 86, 207, 0.3);
      }
      .day-card.today.empty .day-name-text {
        color: var(--primary);
        font-weight: 700;
        font-size: 14px;
      }
      .day-card.today.empty .class-actions .btn {
        border-color: var(--violet-5);
        color: var(--primary);
        font-weight: 600;
        border-style: dashed;
      }

      /* ‚îÄ‚îÄ Past days ‚Äî softly receded but still usable ‚îÄ‚îÄ */
      .day-card.day-past:not(.today) { opacity: 0.55; }
      .day-card.day-past:not(.today) .class-item { opacity: 0.8; }

      /* Extra spacing after days with classes or today */
      .day-card.has-classes { padding-bottom: 18px; }
      .day-card.today + .day-card .day-header { padding-top: 16px; }

      .metric-row { grid-template-columns: repeat(3, 1fr); }
      .best-summary-title { font-size: 20px; }
      .form-row { grid-template-columns: 1fr; }
      .datetime-selector { flex-direction: column; align-items: stretch; }

      .modal { padding: 0; align-items: flex-end; }
      .modal__content {
        width: 100%;
        max-width: none;
        max-height: calc(100dvh - var(--safe-top));
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      }
      .modal__drag-handle {
        display: flex;
        justify-content: center;
        padding: 10px 0 2px;
        flex-shrink: 0;
      }
      .modal__drag-handle::after {
        content: '';
        width: 40px;
        height: 4px;
        border-radius: 2px;
        background: var(--gray-5);
      }
      .modal__header { padding: 12px 16px; }
      .modal__body { padding: 16px; }
      .modal__footer {
        background: var(--surface);
        padding: 12px 16px calc(12px + var(--safe-bottom));
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .modal__footer .btn,
      .modal__footer .tooltip-wrapper,
      .modal__footer .tooltip-wrapper .btn { width: 100%; }
      #save-draft-modal { order: 1; }
      .modal__footer .tooltip-wrapper { order: 2; }
      #cancel-modal { order: 3; display: none; }
      #delete-class-modal {
        order: 4;
        margin-right: 0 !important;
        background: transparent;
        border-color: var(--danger-light);
        font-size: 13px;
      }
      .modal__footer .tooltip-text { display: none; }

      /* Card-style tables on mobile */
      #history .table-container,
      #explorer .table-container {
        background: transparent;
        border: none;
        overflow: visible;
        box-shadow: none;
      }
      #history-table,
      #playlist-manager-table { display: block; width: 100%; }
      #history-table thead,
      #playlist-manager-table thead { display: none; }
      #history-table tbody,
      #playlist-manager-table tbody { display: grid; gap: 10px; }
      #history-table tr,
      #playlist-manager-table tr {
        display: block;
        background: var(--surface);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-xs);
      }
      #history-table td,
      #playlist-manager-table td {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 10px 14px;
        border-bottom: 0.5px solid var(--border-subtle);
      }
      #history-table td::before,
      #playlist-manager-table td::before {
        content: attr(data-label);
        flex: 0 0 38%;
        color: var(--text-tertiary);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: 600;
        line-height: 1.3;
      }
      #history-table td:last-child,
      #playlist-manager-table td:last-child { border-bottom: none; }
      #history-table td[colspan],
      #playlist-manager-table td[colspan],
      #playlist-manager-table .tag-editor-row td { display: block; }
      #history-table td[colspan]::before,
      #playlist-manager-table td[colspan]::before,
      #playlist-manager-table .tag-editor-row td::before { content: none; }
      #history-table .guest-names-short,
      #history-table .guest-names-full { text-align: right; }
      .history-edit-btn, .history-delete-btn { min-height: 44px; min-width: 44px; }
      .history-actions { justify-content: flex-end; }

      #toast-container {
        bottom: calc(96px + var(--safe-bottom));
        right: 12px;
        left: 12px;
      }
      .toast { min-width: unset; max-width: unset; animation: slideUpToast var(--duration-normal) var(--ease-out); }
      @keyframes slideUpToast {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    }

    /* Compatibility aliases for production markup/JS-generated inline styles */
    :root {
      --cream: var(--text-primary);
      --ink: var(--text-primary);
      --ink-light: var(--text-secondary);
      --secondary-text: var(--text-tertiary);
      --surface-secondary: var(--surface-sunken);
      --surface-hover: var(--gray-2);
      --border: var(--border-default);
      --accent: var(--violet-8);
      --glass: rgba(110, 86, 207, 0.04);
      --radius: var(--radius-md);
      --shadow-rest: var(--shadow-sm);
      --shadow-raised: var(--shadow-md);
      --shadow-floating: var(--shadow-lg);
      --shadow: var(--shadow-sm);
      --inner-shadow: none;
      --blur: blur(12px);
      --gap: var(--space-7);
    }

  </style>
</head>
<body>
  <nav class="nav">
    <div class="tabs" role="tablist">
      <button class="tab-btn" role="tab" aria-selected="true" data-tab="weekly"><span class="tab-icon" aria-hidden="true">&#128197;</span><span class="tab-label" data-short="Planner">Weekly Planner</span></button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="dashboard"><span class="tab-icon" aria-hidden="true">&#9776;</span><span class="tab-label" data-short="Recs">Recommender</span></button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="explorer"><span class="tab-icon" aria-hidden="true">&#9835;</span><span class="tab-label" data-short="Playlists">Playlists</span></button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="history"><span class="tab-icon" aria-hidden="true">&#128214;</span><span class="tab-label" data-short="History">History</span></button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="guests"><span class="tab-icon" aria-hidden="true">&#128101;</span><span class="tab-label" data-short="Guests">Guests</span></button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="settings"><span class="tab-icon" aria-hidden="true">&#9881;</span><span class="tab-label" data-short="Settings">Settings</span></button>
    </div>
  </nav>
  <main class="container">
    <section id="dashboard" class="hidden fade-in">
      <div class="hero">
        <h1>Playlist Recommender</h1>
        <div class="subtle" id="currentDateTime"></div>
        <div id="connection-status" class="connection-status disconnected">
          <div class="status-dot disconnected"></div>
          <span>Not signed in</span>
        </div>
        <div class="step-label"><span class="step-num">1</span> Select Planned Classes</div>
        <div class="row" style="margin-top:0;">
          <div class="search-wrap" style="flex:1;">
            <select id="playlistWindow" class="select" title="Replay-ready window">
              <option value="45" selected>Replay-ready ‚â• 45 days</option>
              <option value="30">Replay-ready ‚â• 30 days</option>
              <option value="60">Replay-ready ‚â• 60 days</option>
              <option value="90">Replay-ready ‚â• 90 days</option>
            </select>
          </div>
        </div>
        <div class="class-picker-container" style="margin-top:8px;">
          <div class="class-picker-actions" style="display:flex; gap:8px; margin-bottom:6px;">
            <button type="button" class="btn-xs" id="selectAllDraftsBtn">Select All Drafts</button>
            <button type="button" class="btn-xs" id="clearAllClassesBtn">Clear All</button>
          </div>
          <div class="class-picker-list" id="plannedClassList" style="max-height:180px; overflow-y:auto; background:var(--surface); border-radius:var(--radius-md); padding:8px;"></div>
        </div>
        <div class="row" style="margin-top:10px;">
          <span class="pill" id="selectedClassPill">No classes selected</span>
          <span class="pill" id="selectedClassTypePill">Class type: --</span>
          <span class="pill" id="selectedPlaylistPill">Assigned playlist: --</span>
          <span class="pill" id="recordsCountPill">0 records</span>
        </div>
      </div>
      <div class="step-label" style="margin-top:18px;"><span class="step-num">2</span> Recommendation</div>
      <div class="cards">
        <div class="card primary-card" id="bestCard">
          <div class="body">
            <div class="title">Best Fit Playlist</div>
            <div class="muted">Based on the selected class roster, date, and class type</div>
            <div id="bestSummary" style="margin-top:10px;"></div>
            <div id="bestStrength" class="best-strength-row"></div>
            <div class="recommender-explain">Ranked by never-heard coverage, replay-ready coverage, and median days since last played.</div>
            <div class="metric-row">
              <div class="metric">
                <div class="value" id="bestNever">--</div>
                <div class="label">Never-heard <span class="info-tip" tabindex="0">&#9432;<span class="tip-text">% of attendees who have never heard this playlist ‚Äî higher means better novelty</span></span></div>
              </div>
              <div class="metric">
                <div class="value" id="bestMedian">--</div>
                <div class="label">Median days <span class="info-tip" tabindex="0">&#9432;<span class="tip-text">Typical days since attendees last heard this playlist ‚Äî higher means less recent repetition</span></span></div>
              </div>
              <div class="metric">
                <div class="value" id="bestReady">--</div>
                <div class="label">Replay-ready <span class="info-tip" tabindex="0">&#9432;<span class="tip-text">% of attendees who last heard this at or before the replay-ready window</span></span></div>
              </div>
            </div>
            <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" id="assignBestPlaylistBtn">Assign Best Playlist</button>
              <button class="btn" id="previewRosterBtn">View Details</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <div class="title">All Ranked Playlists</div>
            <div class="muted">Most recommended to least recommended for the selected class</div>
          </div>
          <div class="table-container dashboard-rankings-wrap" style="margin: 0 16px 16px;">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width:64px;">Rank</th>
                  <th>Playlist</th>
                  <th>Never-heard</th>
                  <th>Replay-ready</th>
                  <th>Median days</th>
                  <th>Recently heard</th>
                  <th>Score</th>
                  <th style="width:130px;">Action</th>
                </tr>
              </thead>
              <tbody id="runnerUps"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    <section id="weekly" class="fade-in">
      <div class="weekly-nav">
        <button id="prevWeekBtn" class="week-nav-btn">‚Äπ</button>
        <span class="week-nav-label" id="weekRangePill">Week of ...</span>
        <button id="nextWeekBtn" class="week-nav-btn">‚Ä∫</button>
        <button id="currentWeekBtn" class="week-nav-today-btn">Today</button>
      </div>
      <div class="week-strip" id="weekStrip"></div>
      <!-- Hidden but functional for JS -->
      <div style="display:none;">
        <span id="draftsCountPill">0 drafts</span>
        <span id="finalizedCountPill">0 finalized</span>
        <button id="syncAllBtn" disabled>Finalize All Drafts</button>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </section>
    <section id="explorer" class="hidden fade-in">
      <div class="hero">
        <h1>Playlist Manager</h1>
        <div class="subtle">Manage playlists, tags, and status</div>
        <button class="btn btn-primary" id="addPlaylistBtn" style="margin-top:14px;">+ Add Playlist</button>
      </div>
      <div id="addPlaylistForm" class="card add-playlist-form" style="display:none;">
        <div class="body">
          <div style="font-family:var(--font-display); font-weight:600; font-size:15px; margin-bottom:10px;">New Playlist</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <input type="text" id="newPlaylistId" placeholder="Playlist number (e.g. 13)" class="input-field" style="width:180px;" />
            <button class="btn btn-primary btn-sm" id="confirmAddPlaylist">Add</button>
            <button class="btn btn-sm btn-ghost" id="cancelAddPlaylist">Cancel</button>
          </div>
          <div id="addPlaylistError" style="color:var(--danger); font-size:13px; margin-top:6px; display:none;"></div>
        </div>
      </div>
      <div class="card">
        <div class="table-container">
          <table class="data-table" id="playlist-manager-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="playlist">Playlist</th>
                <th>Tags</th>
                <th class="sortable" data-sort="status">Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="explorerTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="history" class="hidden fade-in">
      <div class="section-header">
        <h2>Class History</h2>
        <div class="search-container">
          <input type="text" id="history-search" placeholder="Search classes...">
          <button type="button" class="search-clear" id="history-search-clear" aria-label="Clear search">‚úï</button>
        </div>
      </div>
      <div id="history-stats" class="stats-bar"></div>
      <div class="card">
        <div class="table-container">
          <table id="history-table" class="data-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="datetime">Date & Time</th>
                <th class="sortable" data-sort="classType">Class Type</th>
                <th class="sortable" data-sort="playlist">Playlist</th>
                <th class="sortable" data-sort="count">Attendees</th>
                <th>Guest Names</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="guests" class="hidden fade-in">
      <div class="section-header">
        <h2>Guest Profiles</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <div class="search-container">
            <input type="text" id="guest-search-filter" placeholder="Search guests...">
            <button type="button" class="search-clear" id="guest-filter-clear" aria-label="Clear search">‚úï</button>
          </div>
          <button type="button" class="btn btn-primary" id="add-guest-btn" style="white-space:nowrap;">+ Add Guest</button>
        </div>
      </div>
      <div id="guests-stats" class="stats-bar"></div>
      <div id="guests-grid" class="guests-grid">
        <div class="empty-state">
          <div class="empty-state-icon">&#128101;</div>
          <h3>Your guest list is waiting</h3>
          <p>Sign in and import attendance data to see guest profiles</p>
          <button class="btn btn-primary" onclick="$$('.tab-btn').find(b=>b.dataset.tab==='settings')?.click()">Import Data</button>
        </div>
      </div>
    </section>
    <section id="settings" class="hidden fade-in">
      <div class="hero">
        <h1>Settings</h1>
        <div class="subtle">Manage your account and app data</div>
      </div>
      <div class="cards">
        <div class="card">
          <div class="body">
            <div class="title">Account</div>
            <div class="muted">Sign in with Google to sync your data across devices</div>
            <div id="settings-auth-info" style="margin-top:16px; padding: 14px; background: var(--surface-sunken); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 14px;">
              Not signed in
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:16px;">
              <button id="settingsSignInBtn" class="btn btn-primary">Sign In with Google</button>
              <button id="settingsSignOutBtn" class="btn hidden">Sign Out</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <div class="title">Data Management</div>
            <div class="muted">Import/export your class data</div>
            <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="importCsvBtn" class="btn">&#128229; Import CSV</button>
              <button id="exportCsvBtn" class="btn">&#128228; Export CSV</button>
            </div>
            <div style="margin-top:16px; padding-top:16px; border-top:0.5px solid var(--border-subtle);">
              <button id="clearDataBtn" class="btn btn-danger">&#128465; Clear All Data</button>
              <p style="margin:8px 0 0; font-size:12px; color:var(--text-tertiary);">This permanently deletes all local and cloud data.</p>
            </div>
            <input id="fileInput" type="file" accept=".csv" class="hidden" />
          </div>
        </div>
      </div>
    </section>
    <div id="class-modal" class="modal hidden">
      <div class="modal__content">
        <div class="modal__drag-handle"></div>
        <div class="modal__header">
          <h3 id="class-modal-title">Plan Class</h3>
          <button id="close-class-modal" class="modal__close">&times;</button>
        </div>
        <div class="modal__body">
          <div class="form-row form-row--always-inline">
            <div class="form-group">
              <label for="modal-class-date">Date</label>
              <input type="date" id="modal-class-date">
            </div>
            <div class="form-group">
              <label for="modal-class-time">Time</label>
              <select id="modal-class-time" class="select"></select>
            </div>
          </div>
          <div class="form-group">
            <label for="modal-class-type">Class Type</label>
            <select id="modal-class-type">
              <option value="">All Types</option>
            </select>
          </div>
          <hr class="form-section-divider">
          <div class="form-group">
            <label>Attendees</label>
            <div class="guest-selector">
              <div class="guest-selector-header">
                <div class="search-container no-icon" style="max-width:100%; flex:1;">
                  <input type="text" id="modal-guest-search" placeholder="Search guests...">
                  <button type="button" class="search-clear" id="modal-guest-search-clear" aria-label="Clear search">‚úï</button>
                </div>
                <button type="button" class="btn-xs" id="modalClearAllBtn">Clear All</button>
              </div>
              <div class="guest-list-container" style="max-height: 225px;">
                <div class="guest-list" id="modal-guest-list"></div>
              </div>
              <div class="selected-guests-container">
                <div class="selected-guests" id="modal-selected-guests">
                  <div class="no-selection">No guests selected</div>
                </div>
              </div>
            </div>
          </div>
          <hr class="form-section-divider">
          <div class="form-group">
            <label>Playlist</label>
            <div id="modal-class-playlist-display" class="pill status-info" style="display:flex; width:100%; justify-content:flex-start;">No playlist assigned yet</div>
            <input id="modal-class-playlist" type="hidden" value="">
            <div class="subtle" style="font-size:12px; margin-top:8px;">Assign playlist from the Recommender tab.</div>
          </div>
          <div class="form-group">
            <label for="modal-class-notes">Notes (optional)</label>
            <textarea id="modal-class-notes" placeholder="Add any notes about this class..."></textarea>
          </div>
        </div>
        <div class="modal__footer">
          <button id="delete-class-modal" class="btn btn-danger" style="margin-right: auto;">üóëÔ∏è Delete</button>
          <button id="cancel-modal" class="btn">Cancel</button>
          <button id="save-draft-modal" class="btn btn-warning">üíæ Save as Draft</button>
        </div>
      </div>
    </div>
    <div id="guest-modal" class="modal hidden">
      <div class="modal__content">
        <div class="modal__drag-handle"></div>
        <div class="modal__header">
          <h3 id="guest-modal-title">Guest Profile</h3>
          <button id="close-guest-modal" class="modal__close">&times;</button>
        </div>
        <div class="modal__body" id="guest-modal-body">
          <div id="guest-modal-content"></div>
        </div>
      </div>
    </div>
  </main>
  <div id="debug-panel" class="debug-panel">
    <strong>Debug Info:</strong>
    <div id="debug-content"></div>
  </div>
<!-- Firebase SDK (compat for no-build-tool usage) -->
<script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore-compat.js"></script>
<script>
  // --- Firebase Configuration ---
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyA5wVOEPafDg27_Jc-Ixn_03jFb6t2IedM",
    authDomain: "hilo-playlist-app.firebaseapp.com",
    projectId: "hilo-playlist-app",
    storageBucket: "hilo-playlist-app.firebasestorage.app",
    messagingSenderId: "13713370156",
    appId: "1:13713370156:web:2380816951b9c48c4a7589"
  };

  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();
  db.enablePersistence({ synchronizeTabs: true }).catch(err => {
    if (err.code === 'failed-precondition') {
      console.warn('Firestore persistence unavailable: multiple tabs open');
    }
  });
  // --- Debug Mode ---
  const DEBUG_MODE = false; // Set to true to enable debug logging
  function debugLog(...args) {
    if (DEBUG_MODE) {
      console.log('[DEBUG]', ...args);
      const panel = document.getElementById('debug-panel');
      const content = document.getElementById('debug-content');
      if (panel && content) {
        panel.classList.add('show');
        const timestamp = new Date().toLocaleTimeString();
        content.innerHTML = `<div>${timestamp}: ${args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ')}</div>` + content.innerHTML;
        const messages = content.querySelectorAll('div');
        if (messages.length > 20) {
          messages[messages.length - 1].remove();
        }
      }
    }
  }
  // --- App State ---
  const DEFAULT_PLAYLISTS = Array.from({ length: 12 }, (_, i) => String(i + 1));
  const PREDEFINED_CLASS_TYPES = [];
  const state = {
    modalAttendees: [],
    playlists: [...DEFAULT_PLAYLISTS],
    records: [], // Historical records with date, time, guest, playlist
    selectedWindow: 45,
    allGuests: new Set(),
    sortOrder: { column: 'datetime', ascending: false },
    explorerSortOrder: { column: 'playlist', ascending: true },
    
    // Firebase integration
    firebaseUser: null,
    firestoreConnected: false,
    firestoreHasPendingWrites: false,
    unsubRecords: null,
    unsubClasses: null,
    unsubPlaylists: null,
    playlistTags: new Map(),
    playlistStatus: new Map(),
    expandedPlaylist: null,

    // Weekly planner state
    weeklyPlan: new Map(), // DateTime string -> class object
    currentWeekStart: null,
    selectedClass: null, // Holds the class being edited in the modal

    // Current selection for recommender
    selectedRecommendationClassKey: '',
    selectedRecommendationClassKeys: new Set()
  };
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  function normalizePlaylistId(value) {
    if (value === null || value === undefined) return '';
    let raw = typeof value === 'number'
      ? (Number.isFinite(value) ? String(value) : '')
      : String(value).trim();
    if (!raw) return '';
    raw = raw.replace(/^playlist\s*#?/i, '').trim();
    if (!raw) return '';
    if (!/^\d+(\.\d+)?$/.test(raw)) return '';
    if (raw.includes('.')) {
      raw = raw.replace(/(\.\d*?[1-9])0+$/, '$1').replace(/\.0+$/, '').replace(/\.$/, '');
    }
    return raw;
  }
  function comparePlaylistIds(a, b) {
    const aId = normalizePlaylistId(a);
    const bId = normalizePlaylistId(b);
    const aNum = aId && /^\d+(\.\d+)?$/.test(aId) ? Number(aId) : NaN;
    const bNum = bId && /^\d+(\.\d+)?$/.test(bId) ? Number(bId) : NaN;
    if (!Number.isNaN(aNum) && !Number.isNaN(bNum) && aNum !== bNum) return aNum - bNum;
    if (!Number.isNaN(aNum) && Number.isNaN(bNum)) return -1;
    if (Number.isNaN(aNum) && !Number.isNaN(bNum)) return 1;
    return aId.localeCompare(bId, undefined, { numeric: true, sensitivity: 'base' });
  }
  function normalizePlaylistStatus(value) {
    const raw = (value ?? '').toString().trim();
    if (!raw) return '';
    const lower = raw.toLowerCase();
    if (lower === 'active') return 'Active';
    if (lower === 'retired') return 'Retired';
    if (lower === 'removed') return 'Removed';
    return raw;
  }
  function ensurePlaylistInState(playlistId) {
    const normalized = normalizePlaylistId(playlistId);
    if (!normalized) return;
    if (!state.playlists.includes(normalized)) {
      state.playlists.push(normalized);
      state.playlists.sort(comparePlaylistIds);
    }
  }
  function rebuildPlaylistsFromData() {
    const found = new Set();
    const removed = new Set();
    state.playlistStatus.forEach((status, playlistId) => {
      const normalized = normalizePlaylistId(playlistId);
      if (!normalized) return;
      if (normalizePlaylistStatus(status) === 'Removed') {
        removed.add(normalized);
      }
    });
    const addIfVisible = (playlistId) => {
      const normalized = normalizePlaylistId(playlistId);
      if (!normalized || removed.has(normalized)) return;
      found.add(normalized);
    };
    state.records.forEach(r => {
      addIfVisible(r.playlist);
    });
    state.weeklyPlan.forEach(cls => {
      addIfVisible(cls.playlist);
    });
    state.playlistTags.forEach((_, playlistId) => {
      addIfVisible(playlistId);
    });
    state.playlistStatus.forEach((status, playlistId) => {
      const normalized = normalizePlaylistId(playlistId);
      if (!normalized) return;
      if (normalizePlaylistStatus(status) === 'Removed') return;
      found.add(normalized);
    });
    const fallbackPlaylists = [...DEFAULT_PLAYLISTS].filter(playlistId => !removed.has(playlistId));
    state.playlists = (found.size > 0 ? Array.from(found) : fallbackPlaylists).sort(comparePlaylistIds);
  }
  // HTML escape for safe innerHTML interpolation
  function esc(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  function renderPlaylistTags(playlistNum, opts = {}) {
    const playlistId = normalizePlaylistId(playlistNum);
    const tags = playlistId ? (state.playlistTags.get(playlistId) || []) : [];
    if (tags.length === 0) return '';
    const cls = opts.compact ? 'class-type-tag compact' : 'class-type-tag';
    return '<span class="playlist-tags-inline">' + tags.map(t => `<span class="${cls}">${esc(t)}</span>`).join('') + '</span>';
  }
  function getAllClassTypes() {
    const types = new Set(PREDEFINED_CLASS_TYPES);
    state.playlistTags.forEach(tags => tags.forEach(t => types.add(t)));
    state.records.forEach(r => { if (r.classType) types.add(r.classType); });
    state.weeklyPlan.forEach(cls => { if (cls.classType) types.add(cls.classType); });
    return Array.from(types).sort();
  }
  function populateClassTypeDropdown(selectEl, selectedValue) {
    const current = selectedValue || '';
    selectEl.innerHTML = '<option value="">All Types</option>';
    getAllClassTypes().forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      if (t === current) opt.selected = true;
      selectEl.appendChild(opt);
    });
  }
  function normalizeTime(timeStr, fallback = '09:00') {
    const raw = (timeStr ?? '').toString().trim();
    if (!raw) return fallback;
    const cleaned = raw.replace(/^\d{4}-\d{2}-\d{2}[T\s]+/, '').trim();
    const match = cleaned.match(/^(\d{1,2})(?::(\d{1,2}))?(?::\d{1,2})?\s*([AaPp][Mm])?$/);
    if (!match) return fallback;
    let hours = Number.parseInt(match[1], 10);
    const minutes = Number.parseInt(match[2] ?? '0', 10);
    if (Number.isNaN(hours) || Number.isNaN(minutes)) return fallback;
    const meridiem = (match[3] || '').toUpperCase();
    if (meridiem === 'PM' && hours < 12) hours += 12;
    if (meridiem === 'AM' && hours === 12) hours = 0;
    return `${String(Math.max(0, Math.min(23, hours))).padStart(2, '0')}:${String(Math.max(0, Math.min(59, minutes))).padStart(2, '0')}`;
  }
  function populateTimeSelect(selectEl, selectedTime) {
    selectEl.innerHTML = '';
    for (let h = 5; h <= 22; h++) {
      for (let m = 0; m < 60; m += 15) {
        const val = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        const hour12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        const ampm = h < 12 ? 'AM' : 'PM';
        const label = `${hour12}:${String(m).padStart(2, '0')} ${ampm}`;
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = label;
        selectEl.appendChild(opt);
      }
    }
    const nearest = snapToNearest15(selectedTime || '09:00');
    if (selectEl.querySelector(`option[value="${nearest}"]`)) {
      selectEl.value = nearest;
    } else {
      selectEl.value = '09:00';
    }
  }
  function snapToNearest15(timeStr) {
    const normalized = normalizeTime(timeStr);
    const [h, m] = normalized.split(':').map(Number);
    const snapped = Math.round(m / 15) * 15;
    const finalM = snapped === 60 ? 0 : snapped;
    const finalH = snapped === 60 ? Math.min(h + 1, 22) : h;
    return `${String(finalH).padStart(2, '0')}:${String(finalM).padStart(2, '0')}`;
  }
  function normalizeClassNumber(value) {
    return (value || '').toString().trim().replace(/\s+/g, ' ');
  }
  function parseImportedPlaylist(rawValue) {
    const raw = (rawValue || '').toString().trim();
    if (!raw) return { playlistId: '', inferredStatus: '' };
    const direct = normalizePlaylistId(raw);
    const inferredStatus = /\bretired\b/i.test(raw) ? 'Retired' : '';
    if (direct) return { playlistId: direct, inferredStatus };
    const match = raw.match(/\d+(\.\d+)?/);
    if (!match) return { playlistId: '', inferredStatus };
    return { playlistId: normalizePlaylistId(match[0]), inferredStatus };
  }
  function buildRecordKey(record) {
    const classNumber = normalizeClassNumber(record.classNumber);
    const base = `${record.date}|${normalizeTime(record.time)}|${(record.guest || '').trim()}|${record.playlist}`;
    return classNumber ? `${base}|${classNumber}` : base;
  }
  function normalizeRecord(record) {
    if (!record) return null;
    const guest = (record.guest || '').toString().trim();
    const playlist = normalizePlaylistId(record.playlist);
    if (!guest || !playlist) return null;
    let date = '';
    if (typeof record.date === 'string') {
      const rawDate = record.date.trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
        date = rawDate;
      } else if (/^\d{4}-\d{2}-\d{2}T/.test(rawDate)) {
        date = rawDate.slice(0, 10);
      } else {
        const parsedDate = new Date(rawDate);
        if (!Number.isNaN(parsedDate.getTime())) {
          date = formatDateKey(parsedDate);
        }
      }
    } else {
      const parsedDate = new Date(record.date);
      if (!Number.isNaN(parsedDate.getTime())) {
        date = formatDateKey(parsedDate);
      }
    }
    if (!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) return null;
    return {
      date,
      time: normalizeTime(record.time),
      guest,
      playlist,
      classType: (record.classType || '').toString().trim(),
      classNumber: normalizeClassNumber(record.classNumber || record.classNum)
    };
  }
  // Deduplicate records before pushing
  function addRecordIfNew(record) {
    const normalizedRecord = normalizeRecord(record);
    if (!normalizedRecord) return false;
    const key = buildRecordKey(normalizedRecord);
    const exists = state.records.some(r => buildRecordKey(r) === key);
    if (!exists) {
      state.records.push(normalizedRecord);
      ensurePlaylistInState(normalizedRecord.playlist);
      return true;
    }
    return false;
  }
  // --- Firestore Document ID Helper ---
  function safeDocId(recordKey) {
    let hash = 0x811c9dc5;
    for (let i = 0; i < recordKey.length; i++) {
      hash ^= recordKey.charCodeAt(i);
      hash = Math.imul(hash, 0x01000193);
    }
    const prefix = recordKey.slice(0, 40).replace(/[^a-zA-Z0-9_-]/g, '_');
    return prefix + '__' + (hash >>> 0).toString(36);
  }
  // --- Firebase Data Layer ---
   function setLoading(button, isLoading) {
    if (!button) return;
    if (isLoading) {
      button.disabled = true;
      button.dataset.originalContent = button.innerHTML;
      button.innerHTML = '<div class="loading-spinner"></div>';
    } else {
      button.disabled = false;
      if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
      }
    }
  }
  // --- Firestore Real-time Listeners ---
  function setupFirestoreListeners() {
    if (state.unsubRecords) state.unsubRecords();
    if (state.unsubClasses) state.unsubClasses();
    if (state.unsubPlaylists) state.unsubPlaylists();

    const uid = state.firebaseUser.uid;

    state.unsubRecords = db.collection('users').doc(uid).collection('records')
      .onSnapshot(snapshot => {
        state.firestoreConnected = !snapshot.metadata.fromCache;
        state.firestoreHasPendingWrites = snapshot.metadata.hasPendingWrites;
        updateConnectionStatus();

        state.records = [];
        state.allGuests = new Set();
        snapshot.forEach(doc => {
          const normalized = normalizeRecord(doc.data());
          if (!normalized) return;
          state.records.push(normalized);
          state.allGuests.add(normalized.guest);
        });
        state.weeklyPlan.forEach(cls => {
          (cls.attendees instanceof Set ? cls.attendees : []).forEach(g => state.allGuests.add(g));
        });
        rebuildPlaylistsFromData();
        updateRecordsPill();
        refreshAll();
        refreshHistory();
        refreshGuests();
        saveStateToLocalStorage();
      }, error => {
        console.error('Records listener error:', error);
        showToast('Data sync error: ' + error.message, 'error');
      });

    state.unsubClasses = db.collection('users').doc(uid).collection('classes')
      .onSnapshot(snapshot => {
        state.weeklyPlan = new Map();
        state.allGuests = new Set(state.records.map(r => r.guest).filter(Boolean));
        snapshot.forEach(doc => {
          const cls = doc.data();
          cls.id = doc.id;
          cls.playlist = normalizePlaylistId(cls.playlist);
          cls.attendees = new Set(cls.attendees || []);
          cls.classType = (cls.classType || '').toString().trim();
          const key = createDateTimeKey(cls.date, cls.time);
          state.weeklyPlan.set(key, cls);
          cls.attendees.forEach(g => state.allGuests.add(g));
        });
        rebuildPlaylistsFromData();
        renderWeeklyCalendar();
        refreshAll();
        refreshGuests();
        saveStateToLocalStorage();
      }, error => {
        console.error('Classes listener error:', error);
      });

    state.unsubPlaylists = db.collection('users').doc(uid).collection('playlists')
      .onSnapshot(snapshot => {
        state.playlistTags = new Map();
        state.playlistStatus = new Map();
        snapshot.forEach(doc => {
          const data = doc.data();
          const playlistId = normalizePlaylistId(doc.id);
          if (!playlistId) return;
          if (Array.isArray(data.classTypes)) {
            const tags = data.classTypes.map(t => (t ?? '').toString().trim()).filter(Boolean);
            if (tags.length > 0) state.playlistTags.set(playlistId, Array.from(new Set(tags)));
          }
          const status = normalizePlaylistStatus(data.status);
          if (status) state.playlistStatus.set(playlistId, status);
        });
        rebuildPlaylistsFromData();
        refreshAll();
        saveStateToLocalStorage();
      }, error => {
        console.error('Playlists listener error:', error);
      });
  }

  // --- Auth State Observer ---
  function setupAuthListener() {
    auth.onAuthStateChanged(user => {
      state.firebaseUser = user;
      if (user) {
        $('#settingsSignInBtn').classList.add('hidden');
        $('#settingsSignOutBtn').classList.remove('hidden');
        const infoEl = $('#settings-auth-info');
        if (infoEl) infoEl.textContent = `Signed in as ${user.displayName || user.email}`;
        updateConnectionStatus();
        setupFirestoreListeners();
      } else {
        if (state.unsubRecords) { state.unsubRecords(); state.unsubRecords = null; }
        if (state.unsubClasses) { state.unsubClasses(); state.unsubClasses = null; }
        if (state.unsubPlaylists) { state.unsubPlaylists(); state.unsubPlaylists = null; }
        state.playlistTags = new Map();
        state.playlistStatus = new Map();
        $('#settingsSignInBtn').classList.remove('hidden');
        $('#settingsSignOutBtn').classList.add('hidden');
        const infoEl = $('#settings-auth-info');
        if (infoEl) infoEl.textContent = 'Not signed in';
        state.firestoreConnected = false;
        rebuildPlaylistsFromData();
        updateConnectionStatus();
      }
    });
  }

  // --- Firestore Write Functions ---

  // Returns a Firestore collection ref under the current user's doc.
  // Requires state.firebaseUser to be set.
  function getUserCollectionRef(collectionName) {
    return db.collection('users').doc(state.firebaseUser.uid).collection(collectionName);
  }

  // Accepts an array of batch operations and commits them in chunks of 500.
  // Each op: { action: 'set'|'delete'|'update', ref: docRef, data?: object }
  async function runFirestoreBatch(ops) {
    const CHUNK_SIZE = 500;
    for (let i = 0; i < ops.length; i += CHUNK_SIZE) {
      const chunk = ops.slice(i, i + CHUNK_SIZE);
      const batch = db.batch();
      for (const op of chunk) {
        if (op.action === 'set') batch.set(op.ref, op.data);
        else if (op.action === 'delete') batch.delete(op.ref);
        else if (op.action === 'update') batch.update(op.ref, op.data);
      }
      await batch.commit();
    }
  }

  async function writeRecordsToFirestore(classData) {
    if (!state.firebaseUser) {
      showToast('Please sign in first.', 'error');
      return false;
    }
    const recordsRef = getUserCollectionRef('records');
    const ops = [...classData.attendees].map(guest => {
      const recordKey = buildRecordKey({
        date: classData.date,
        time: normalizeTime(classData.time),
        guest,
        playlist: classData.playlist
      });
      return {
        action: 'set',
        ref: recordsRef.doc(safeDocId(recordKey)),
        data: { date: classData.date, time: normalizeTime(classData.time), guest, playlist: classData.playlist, recordKey }
      };
    });

    try {
      await runFirestoreBatch(ops);
      showToast(`Synced ${classData.attendees.size} records`, 'success');
      return true;
    } catch (error) {
      showToast('Sync failed: ' + error.message, 'error');
      return false;
    }
  }

  async function saveClassToFirestore(dateTimeKey, classData) {
    if (!state.firebaseUser) {
      showToast('Please sign in first.', 'error');
      return false;
    }
    try {
      await getUserCollectionRef('classes').doc(safeDocId(dateTimeKey)).set({
        date: classData.date,
        time: classData.time,
        playlist: classData.playlist,
        attendees: Array.from(classData.attendees),
        status: classData.status || 'draft',
        notes: classData.notes || '',
        classType: classData.classType || '',
        dateTimeKey
      });
      return true;
    } catch (error) {
      showToast('Save failed: ' + error.message, 'error');
      return false;
    }
  }

  async function deleteClassFromFirestore(dateTimeKey) {
    if (!state.firebaseUser) return;
    await getUserCollectionRef('classes').doc(safeDocId(dateTimeKey)).delete();
  }

  async function clearAllFirestoreData() {
    if (!state.firebaseUser) return;
    const uid = state.firebaseUser.uid;
    const collections = ['records', 'classes', 'playlists'];
    for (const col of collections) {
      let snapshot;
      do {
        snapshot = await db.collection('users').doc(uid).collection(col).limit(500).get();
        if (snapshot.empty) break;
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
      } while (!snapshot.empty);
    }
  }
  async function upsertPlaylistMetadata(playlistId, payload) {
    if (!state.firebaseUser || !playlistId) return;
    const keys = Object.keys(payload || {});
    if (keys.length === 0) return;
    await db.collection('users').doc(state.firebaseUser.uid)
      .collection('playlists').doc(playlistId)
      .set(payload, { merge: true });
  }
  async function updatePlaylistMetadata(playlistNum, changes) {
    const playlistId = normalizePlaylistId(playlistNum);
    if (!playlistId) return;
    const payload = {};

    if (changes.status !== undefined) {
      const normalizedStatus = normalizePlaylistStatus(changes.status);
      if (!normalizedStatus) return;
      state.playlistStatus.set(playlistId, normalizedStatus);
      payload.status = normalizedStatus;
    }

    if (changes.addTag !== undefined) {
      const trimmed = changes.addTag.trim();
      if (!trimmed) return;
      const current = state.playlistTags.get(playlistId) || [];
      if (current.includes(trimmed)) return;
      const updated = [...current, trimmed];
      state.playlistTags.set(playlistId, updated);
      payload.classTypes = updated;
    }

    if (changes.removeTag !== undefined) {
      const current = state.playlistTags.get(playlistId) || [];
      const updated = current.filter(t => t !== changes.removeTag);
      if (updated.length > 0) {
        state.playlistTags.set(playlistId, updated);
      } else {
        state.playlistTags.delete(playlistId);
      }
      payload.classTypes = updated;
    }

    if (changes.removeTag !== undefined) {
      rebuildPlaylistsFromData();
    } else {
      ensurePlaylistInState(playlistId);
    }

    saveStateToLocalStorage();
    refreshAll();

    if (state.firebaseUser && Object.keys(payload).length > 0) {
      try {
        await upsertPlaylistMetadata(playlistId, payload);
      } catch (err) {
        showToast('Playlist save failed: ' + err.message, 'error');
      }
    }
  }
  async function addNewPlaylist(rawId) {
    const playlistId = normalizePlaylistId(rawId);
    if (!playlistId) return { ok: false, error: 'Invalid playlist number. Use a numeric value (e.g. 13 or 2.5).' };
    if (state.playlists.includes(playlistId)) return { ok: false, error: `Playlist #${playlistId} already exists.` };
    state.playlists.push(playlistId);
    state.playlists.sort(comparePlaylistIds);
    state.playlistStatus.set(playlistId, 'Active');
    saveStateToLocalStorage();
    refreshAll();
    if (state.firebaseUser) {
      try {
        await upsertPlaylistMetadata(playlistId, { status: 'Active', classTypes: [] });
      } catch (err) {
        showToast('Playlist save failed: ' + err.message, 'error');
      }
    }
    showToast(`Playlist #${playlistId} added`, 'success');
    return { ok: true };
  }
  async function removePlaylist(playlistNum) {
    const playlistId = normalizePlaylistId(playlistNum);
    if (!playlistId) return;
    // Check for upcoming classes using this playlist
    const upcoming = Array.from(state.weeklyPlan.values()).filter(
      c => normalizePlaylistId(c.playlist) === playlistId && c.status !== 'finalized'
    );
    if (upcoming.length > 0) {
      if (!confirm(`Playlist #${playlistId} is assigned to ${upcoming.length} upcoming class(es). Remove anyway?`)) return;
    } else {
      if (!confirm(`Remove Playlist #${playlistId}? Historical records will be kept.`)) return;
    }
    state.playlists = state.playlists.filter(p => p !== playlistId);
    state.playlistTags.delete(playlistId);
    state.playlistStatus.set(playlistId, 'Removed');
    if (state.expandedPlaylist === playlistId) state.expandedPlaylist = null;
    rebuildPlaylistsFromData();
    saveStateToLocalStorage();
    refreshAll();
    if (state.firebaseUser) {
      try {
        await upsertPlaylistMetadata(playlistId, { status: 'Removed', classTypes: [] });
      } catch (err) {
        showToast('Playlist delete failed: ' + err.message, 'error');
      }
    }
    showToast(`Playlist #${playlistId} removed`, 'success');
  }
  // --- Local Storage Persistence ---
  function saveStateToLocalStorage() {
      try {
          // Convert weeklyPlan entries: attendees Set -> Array so JSON.stringify works
          const weeklyPlanSerialized = Array.from(state.weeklyPlan.entries()).map(([key, cls]) => [
              key,
              { ...cls, attendees: Array.from(cls.attendees || []) }
          ]);
          const dataToSave = {
              records: state.records,
              weeklyPlan: weeklyPlanSerialized,
              allGuests: Array.from(state.allGuests),
              playlistTags: Array.from(state.playlistTags.entries()),
              playlistStatus: Array.from(state.playlistStatus.entries())
          };
          localStorage.setItem('hiloPlaylistData', JSON.stringify(dataToSave));
          debugLog('State saved to localStorage');
      } catch (e) {
          console.error("Failed to save state to localStorage", e);
      }
  }
  function loadStateFromLocalStorage() {
      try {
          const savedData = localStorage.getItem('hiloPlaylistData');
          if (savedData) {
              const parsedData = JSON.parse(savedData);
              state.records = [];
              (parsedData.records || []).forEach(r => addRecordIfNew(r));
              const normalizedWeeklyPlan = new Map();
              new Map(parsedData.weeklyPlan || []).forEach((cls, key) => {
                  const parsedKey = parseDateTimeKey(key);
                  cls.date = cls.date || parsedKey.date;
                  cls.time = normalizeTime(cls.time || parsedKey.time || '09:00');
                  cls.playlist = normalizePlaylistId(cls.playlist);
                  cls.id = cls.id || `${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;
                  if (Array.isArray(cls.attendees)) {
                      cls.attendees = new Set(cls.attendees);
                  } else if (!(cls.attendees instanceof Set)) {
                      cls.attendees = new Set();
                  }
                  const normalizedKey = createDateTimeKey(cls.date, cls.time);
                  if (!normalizedWeeklyPlan.has(normalizedKey)) {
                      normalizedWeeklyPlan.set(normalizedKey, cls);
                  }
              });
              state.weeklyPlan = normalizedWeeklyPlan;
              state.playlistTags = new Map();
              (parsedData.playlistTags || []).forEach(entry => {
                const [playlistId, tags] = entry;
                const normalizedId = normalizePlaylistId(playlistId);
                if (!normalizedId || !Array.isArray(tags)) return;
                const cleanedTags = tags.map(t => (t ?? '').toString().trim()).filter(Boolean);
                if (cleanedTags.length > 0) state.playlistTags.set(normalizedId, Array.from(new Set(cleanedTags)));
              });
              state.playlistStatus = new Map();
              (parsedData.playlistStatus || []).forEach(entry => {
                const [playlistId, status] = entry;
                const normalizedId = normalizePlaylistId(playlistId);
                const normalizedStatus = normalizePlaylistStatus(status);
                if (!normalizedId || !normalizedStatus) return;
                state.playlistStatus.set(normalizedId, normalizedStatus);
              });
              state.allGuests = new Set(parsedData.allGuests || []);
              // Rebuild allGuests from records in case saved guest list was incomplete
              state.records.forEach(r => { if (r.guest) state.allGuests.add(r.guest); });
              state.weeklyPlan.forEach(cls => cls.attendees.forEach(guest => state.allGuests.add(guest)));
              rebuildPlaylistsFromData();
              debugLog('State loaded from localStorage');
          }
      } catch (e) {
          console.error("Failed to load state from localStorage", e);
      }
  }
  // --- Utility Functions ---
  const parseDateInput = (d) => {
    if (!d) return null;
    if (typeof d === 'number' || (typeof d === 'string' && /^\d+(\.\d+)?$/.test(d.trim()))) {
      const serial = Number(d);
      if (Number.isFinite(serial) && serial > 59) {
        const wholeDays = Math.trunc(serial);
        const dayFraction = serial - wholeDays;
        const utcMs = Date.UTC(1899, 11, 30) + (wholeDays * 86400 * 1000) + Math.round(dayFraction * 86400 * 1000);
        const excelDate = new Date(utcMs);
        if (!Number.isNaN(excelDate.getTime())) {
          return new Date(
            excelDate.getUTCFullYear(),
            excelDate.getUTCMonth(),
            excelDate.getUTCDate(),
            excelDate.getUTCHours(),
            excelDate.getUTCMinutes(),
            excelDate.getUTCSeconds(),
            excelDate.getUTCMilliseconds()
          );
        }
      }
    }
    const parsed = (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d))
      ? new Date(d + 'T00:00:00')
      : new Date(d);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  };
  const formatDate = (d) => {
    if (!d) return '';
    const date = parseDateInput(d);
    if (!date) return '';
    return date.toLocaleDateString('en-US', {
      weekday: 'short',
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };
  const formatTime = (timeStr) => {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours, 10);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${String(minutes).padStart(2, '0')} ${ampm}`;
  };
  const formatDateTime = (date, time) => {
    return `${formatDate(date)} at ${formatTime(time)}`;
  };
  const createDateTimeKey = (date, time) => {
    return `${date}T${normalizeTime(time)}`;
  };
  const parseDateTimeKey = (key) => {
    const [date, time] = key.split('T');
    return { date, time: normalizeTime(time) };
  };
  const daysBetween = (referenceDate, comparedDate) => {
    const date1 = parseDateInput(referenceDate);
    const date2 = parseDateInput(comparedDate);
    if (!date1 || !date2) return 0;
    const diffTime = date1.getTime() - date2.getTime();
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  };
  const median = (arr) => {
    if (!arr.length) return 0;
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 ? sorted[mid] : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
  };
  const getWeekStart = (date) => {
    const d = parseDateInput(date) || new Date();
    d.setHours(0, 0, 0, 0);
    const day = d.getDay();
    const diff = d.getDate() - day; // Sunday = 0
    return new Date(d.setDate(diff));
  };
  const getWeekDays = (weekStart) => {
    const days = [];
    for (let i = 0; i < 7; i++) {
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + i);
      days.push(day);
    }
    return days;
  };
  const formatDateKey = (date) => {
    // Use local date components instead of UTC-based toISOString()
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  };
  // --- Initialize App ---
  async function initializeApp() {
    debugLog('Initializing app...');

    // Move tabs out of .nav on mobile so position:fixed works correctly.
    // WebKit treats sticky/backdrop-filter parents as containing blocks for fixed children.
    (function() {
      const tabs = document.querySelector('.tabs');
      const nav = document.querySelector('.nav');
      const mq = window.matchMedia('(max-width: 768px)');
      function place(e) {
        if (e.matches) document.body.appendChild(tabs);
        else nav.appendChild(tabs);
      }
      mq.addEventListener('change', place);
      place(mq);
    })();

    loadStateFromLocalStorage();

    const today = new Date();
    state.currentWeekStart = getWeekStart(today);

    // Wire up UI immediately so the app is interactive while Firebase loads
    addEventListeners();
    updateConnectionStatus();
    updateDashboardStatus();
    updateRecordsPill();
    refreshAll();
    renderWeeklyCalendar();

    // Start Firebase auth listener ‚Äî Firestore listeners start on sign-in
    setupAuthListener();
  }
  function updateCurrentDateTime() {
    const now = new Date();
    $("#currentDateTime").textContent = now.toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }
  updateCurrentDateTime();
  setInterval(updateCurrentDateTime, 60000);
  
  // --- Toast Notification System ---
  function showToast(message, type = 'info', duration = 3000) {
    let container = $('#toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    
    const removeToast = () => {
        toast.style.animation = 'slideOutRight 0.3s ease forwards';
        toast.addEventListener('animationend', () => toast.remove());
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 500);
    };
    
    const timer = setTimeout(removeToast, duration);
    
    toast.addEventListener('click', () => {
        clearTimeout(timer);
        removeToast();
    });
  }
  
  // Add CSS for slide out animation
  const styleSheet = document.createElement("style");
  styleSheet.type = "text/css";
  styleSheet.innerText = `@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
  document.head.appendChild(styleSheet);
  
  function updateConnectionStatus() {
    const statusEl = $("#connection-status");
    const dotEl = statusEl.querySelector('.status-dot');

    if (!state.firebaseUser) {
      statusEl.className = 'connection-status disconnected';
      dotEl.className = 'status-dot disconnected';
      statusEl.querySelector('span').textContent = 'Not signed in';
      $("#syncAllBtn").disabled = true;
    } else if (state.firestoreHasPendingWrites) {
      statusEl.className = 'connection-status connected';
      dotEl.className = 'status-dot connected';
      dotEl.style.background = 'var(--warning)';
      statusEl.querySelector('span').textContent = 'Syncing...';
      $("#syncAllBtn").disabled = false;
    } else if (state.firestoreConnected) {
      statusEl.className = 'connection-status connected';
      dotEl.className = 'status-dot connected';
      dotEl.style.background = '';
      statusEl.querySelector('span').textContent = 'Synced';
      $("#syncAllBtn").disabled = false;
    } else {
      statusEl.className = 'connection-status disconnected';
      dotEl.className = 'status-dot disconnected';
      dotEl.style.background = 'var(--warning)';
      statusEl.querySelector('span').textContent = 'Offline (cached)';
      $("#syncAllBtn").disabled = false;
    }
    updateDashboardStatus();
  }
  // --- Class Management ---
  function createClass(date, time, playlist = null, attendees = new Set(), notes = '', status = 'draft', classType = '') {
    return {
      id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
      date: date,
      time: normalizeTime(time),
      playlist: playlist,
      attendees: new Set(attendees),
      status: status,
      notes: notes,
      classType: classType || ''
    };
  }
  function getRecommenderClassEntries() {
    return Array.from(state.weeklyPlan.entries())
      .map(([key, cls]) => ({ key, cls }))
      .filter(({ cls }) => cls.status !== 'finalized')
      .sort((a, b) => a.key.localeCompare(b.key));
  }
  function getSelectedRecommenderClassEntries() {
    const entries = getRecommenderClassEntries();
    if (entries.length === 0) {
      state.selectedRecommendationClassKeys.clear();
      return [];
    }
    // If no explicit selection, auto-select the next upcoming draft
    if (state.selectedRecommendationClassKeys.size === 0) {
      const now = new Date();
      const nowKey = createDateTimeKey(
        formatDateKey(now),
        normalizeTime(`${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`)
      );
      const nextDraft = entries.find(entry => entry.cls.status !== 'finalized' && entry.key >= nowKey)
        || entries.find(entry => entry.cls.status !== 'finalized');
      if (nextDraft) {
        state.selectedRecommendationClassKeys.add(nextDraft.key);
      }
    }
    // Remove keys that no longer exist in the plan
    const validKeys = new Set(entries.map(e => e.key));
    for (const key of state.selectedRecommendationClassKeys) {
      if (!validKeys.has(key)) state.selectedRecommendationClassKeys.delete(key);
    }
    return entries.filter(e => state.selectedRecommendationClassKeys.has(e.key));
  }
  // Backward-compat shim: returns first selected entry (used by previewRosterBtn etc.)
  function getSelectedRecommenderClassEntry() {
    const selected = getSelectedRecommenderClassEntries();
    return selected.length > 0 ? selected[0] : null;
  }
  function formatRecommenderClassOption(entry) {
    const cls = entry.cls || {};
    const attendeeCount = cls.attendees instanceof Set ? cls.attendees.size : (cls.attendees || []).length;
    const classType = (cls.classType || '').trim() || 'All Types';
    return `${formatDate(cls.date)} ${formatTime(cls.time)} \u2022 ${classType} \u2022 ${attendeeCount} guest${attendeeCount !== 1 ? 's' : ''}`;
  }
  function populatePlannedClassList() {
    const container = $('#plannedClassList');
    if (!container) return;
    const entries = getRecommenderClassEntries();
    container.innerHTML = '';
    if (entries.length === 0) {
      container.innerHTML = '<div style="padding:16px; color:var(--secondary-text); font-size:13px; text-align:center;"><div style="font-size:28px; opacity:.4; margin-bottom:6px;">&#128197;</div>No planned classes yet. <a href="#" onclick="event.preventDefault();$$(\'.tab-btn\').find(b=>b.dataset.tab===\'weekly\')?.click()" style="color:var(--primary); text-decoration:underline;">Add classes in Weekly Planner</a></div>';
      return;
    }
    entries.forEach(entry => {
      const isChecked = state.selectedRecommendationClassKeys.has(entry.key);
      const item = document.createElement('label');
      item.className = `class-picker-item${isChecked ? ' checked' : ''}`;
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = isChecked;
      checkbox.value = entry.key;
      const label = document.createElement('span');
      label.className = 'class-picker-label';
      label.textContent = formatRecommenderClassOption(entry);
      item.appendChild(checkbox);
      item.appendChild(label);
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          state.selectedRecommendationClassKeys.add(entry.key);
        } else {
          state.selectedRecommendationClassKeys.delete(entry.key);
        }
        item.classList.toggle('checked', checkbox.checked);
        refreshRecommenderFromSelection();
      });
      container.appendChild(item);
    });
  }
  function refreshRecommenderFromSelection() {
    const selectedEntries = getSelectedRecommenderClassEntries();
    const metrics = getMetricsForSelectedClasses(selectedEntries);
    refreshDashboard(metrics, selectedEntries);
    updateDashboardStatus(selectedEntries);
  }
  function getMetricsForSelectedClasses(selectedEntries) {
    if (!selectedEntries || selectedEntries.length === 0) return [];
    // Merge attendees from all selected classes
    const mergedAttendees = new Set();
    selectedEntries.forEach(entry => {
      const cls = entry.cls || {};
      const att = cls.attendees instanceof Set ? cls.attendees : new Set(cls.attendees || []);
      att.forEach(g => mergedAttendees.add(g));
    });
    if (mergedAttendees.size === 0) return [];
    // Determine class type filter: use shared type if all match, else no filter
    const classTypes = selectedEntries.map(e => (e.cls.classType || '').trim()).filter(Boolean);
    const uniqueTypes = new Set(classTypes.map(t => t.toLowerCase()));
    const classType = uniqueTypes.size === 1 ? classTypes[0] : '';
    // Use earliest date as reference
    const dates = selectedEntries.map(e => e.cls.date).filter(Boolean).sort();
    const refDate = dates[0] || formatDateKey(new Date());
    return computeMetrics({
      attendees: mergedAttendees,
      classType,
      window: state.selectedWindow,
      date: refDate
    });
  }
  async function assignPlaylistToSelectedClasses(playlistId) {
    const selectedEntries = getSelectedRecommenderClassEntries();
    if (selectedEntries.length === 0) {
      showToast('Select at least one planned class first.', 'error');
      return;
    }
    const normalizedPlaylist = normalizePlaylistId(playlistId);
    if (!normalizedPlaylist) {
      showToast('Playlist format is invalid.', 'error');
      return;
    }
    const draftEntries = selectedEntries.filter(e => e.cls.status !== 'finalized');
    if (draftEntries.length === 0) {
      showToast('All selected classes are finalized.', 'info');
      return;
    }
    let savedCount = 0;
    for (const { key, cls } of draftEntries) {
      const updatedClass = {
        ...cls,
        playlist: normalizedPlaylist,
        attendees: cls.attendees instanceof Set ? new Set(cls.attendees) : new Set(cls.attendees || [])
      };
      if (state.firebaseUser) {
        const saved = await saveClassToFirestore(key, updatedClass);
        if (saved) {
          state.weeklyPlan.set(key, updatedClass);
          savedCount++;
        }
      } else {
        state.weeklyPlan.set(key, updatedClass);
        savedCount++;
      }
      // Sync modal if open on this class
      if (state.selectedClass && createDateTimeKey(state.selectedClass.date, state.selectedClass.time) === key) {
        state.selectedClass = updatedClass;
        const modalPlaylistInput = $('#modal-class-playlist');
        if (modalPlaylistInput) modalPlaylistInput.value = normalizedPlaylist;
        updateModalPlaylistDisplay(normalizedPlaylist);
      }
    }
    if (!state.firebaseUser) saveStateToLocalStorage();
    renderWeeklyCalendar();
    const label = savedCount === 1 ? '1 class' : `${savedCount} classes`;
    showToast(`Playlist #${normalizedPlaylist} assigned to ${label}`, 'success');
    refreshAll();
  }
  function updateDashboardStatus(selectedEntries = getSelectedRecommenderClassEntries()) {
    const selectedClassPill = $("#selectedClassPill");
    const selectedClassTypePill = $("#selectedClassTypePill");
    const selectedPlaylistPill = $("#selectedPlaylistPill");
    if (!selectedClassPill || !selectedClassTypePill || !selectedPlaylistPill) return;
    if (!selectedEntries || selectedEntries.length === 0) {
      selectedClassPill.textContent = 'No classes selected';
      selectedClassTypePill.textContent = 'Class type: --';
      selectedPlaylistPill.textContent = 'Assigned playlist: --';
      return;
    }
    // Aggregate info
    const mergedAttendees = new Set();
    const playlists = new Set();
    const classTypes = new Set();
    let allFinalized = true;
    selectedEntries.forEach(entry => {
      const cls = entry.cls || {};
      const att = cls.attendees instanceof Set ? cls.attendees : new Set(cls.attendees || []);
      att.forEach(g => mergedAttendees.add(g));
      if (cls.playlist) playlists.add(cls.playlist);
      if ((cls.classType || '').trim()) classTypes.add((cls.classType || '').trim());
      if (cls.status !== 'finalized') allFinalized = false;
    });
    const count = selectedEntries.length;
    const guestCount = mergedAttendees.size;
    if (count === 1) {
      const cls = selectedEntries[0].cls || {};
      selectedClassPill.textContent = `${formatDate(cls.date)} ${formatTime(cls.time)} \u2022 ${guestCount} guest${guestCount !== 1 ? 's' : ''} \u2022 ${cls.status || 'draft'}`;
    } else {
      selectedClassPill.textContent = `${count} classes selected \u2022 ${guestCount} unique guest${guestCount !== 1 ? 's' : ''}`;
    }
    selectedClassTypePill.textContent = classTypes.size === 1 ? `Class type: ${[...classTypes][0]}` : classTypes.size > 1 ? `Class types: ${[...classTypes].join(', ')}` : 'Class type: All Types';
    selectedPlaylistPill.textContent = playlists.size === 1 ? `Assigned playlist: #${[...playlists][0]}` : playlists.size > 1 ? `Assigned playlists: ${[...playlists].map(p => '#' + p).join(', ')}` : 'Assigned playlist: --';
  }
  function updateRecordsPill() {
    $("#recordsCountPill").textContent = `${state.records.length} records`;
  }
  // --- Weekly Calendar ---
  function renderWeeklyCalendar() {
    const calendarGrid = $("#calendarGrid"), weekStrip = $("#weekStrip");
    const weekDays = getWeekDays(state.currentWeekStart);
    const dayNamesFull = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dayNamesShort = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const dayLetters = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    const todayKey = formatDateKey(new Date());
    const isMobile = window.innerWidth <= 768;

    if (weekStrip) {
      weekStrip.innerHTML = '';
      weekDays.forEach((day, index) => {
        const dayKey = formatDateKey(day);
        const isToday = dayKey === todayKey;
        const isPast = dayKey < todayKey;
        const dayClasses = Array.from(state.weeklyPlan.entries()).filter(([key]) => key.startsWith(dayKey));
        const hasEvents = dayClasses.length > 0;
        const hasDraft = dayClasses.some(([, cls]) => cls.status === 'draft');

        const classes = ['week-strip-day'];
        if (isToday) classes.push('is-today');
        if (isPast && !isToday) classes.push('is-past');
        if (hasEvents) classes.push('has-events');

        const dotClass = hasEvents ? (hasDraft ? 'week-strip-dot draft-dot' : 'week-strip-dot finalized-dot') : '';
        const dotHTML = hasEvents ? `<span class="${dotClass}"></span>` : '';

        const el = document.createElement('div');
        el.className = classes.join(' ');
        el.innerHTML = `<span class="week-strip-name">${dayLetters[index]}</span><span class="week-strip-num">${day.getDate()}</span><div class="week-strip-indicator">${dotHTML}</div>`;
        weekStrip.appendChild(el);
      });
    }

    calendarGrid.innerHTML = '';
    weekDays.forEach((day, index) => {
      const dayKey = formatDateKey(day);
      const isToday = dayKey === todayKey;
      const isPast = dayKey < todayKey && !isToday;
      const dayClasses = Array.from(state.weeklyPlan.entries())
        .filter(([key]) => key.startsWith(dayKey))
        .map(([key, cls]) => ({ ...cls, dateTimeKey: key }))
        .sort((a, b) => a.time.localeCompare(b.time));

      const dayCard = document.createElement('div');
      const classes = ['day-card'];
      if (isToday) classes.push('today');
      if (isPast) classes.push('day-past');
      classes.push(dayClasses.length > 0 ? 'has-classes' : 'empty');
      dayCard.className = classes.join(' ');

      const classesHTML = dayClasses.length > 0
        ? dayClasses.map(cls => `
          <div class="class-item ${cls.status === 'draft' ? 'status-draft-bar' : 'status-finalized-bar'}" onclick="openClassModal('${cls.dateTimeKey}')">
            <div class="class-time">${formatTime(cls.time)}</div>
            <div class="class-info">${cls.classType ? esc(cls.classType) + ' ‚Ä¢ ' : ''}${cls.playlist ? 'Playlist #' + esc(cls.playlist) : 'No playlist'} ‚Ä¢ ${cls.attendees.size} guests</div>
            ${cls.playlist ? renderPlaylistTags(cls.playlist, { compact: true }) : ''}
            <div class="pill ${cls.status === 'draft' ? 'status-draft' : 'status-finalized'}" style="margin-top:4px; font-size:11px; padding:3px 8px;">${cls.status}</div>
          </div>
        `).join('')
        : '';

      const draftCount = dayClasses.filter(c => c.status === 'draft').length;
      const finalizeBtn = draftCount > 0
        ? `<button class="btn btn-sm btn-success" onclick="finalizeDayDrafts('${dayKey}')">‚úî Finalize ${draftCount}</button>`
        : '';
      const todayLabel = isToday ? '<span class="day-today-label">Today</span>' : '';
      const dayLabel = isMobile ? dayNamesFull[index] : dayNamesShort[index];

      dayCard.innerHTML = `
        <div class="day-header">
          <div class="day-name"><span class="day-badge">${day.getDate()}</span><span class="day-name-text">${dayLabel}</span>${todayLabel}</div>
        </div>
        <div class="class-list">${classesHTML}</div>
        <div class="class-actions">
          <button class="btn btn-sm btn-primary" onclick="openNewClassModal('${dayKey}')">+ Add</button>
          ${finalizeBtn}
        </div>
      `;

      calendarGrid.appendChild(dayCard);
    });
    updateWeeklyStats();
  }
  function updateWeeklyStats() {
    const weekStart = state.currentWeekStart;
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999);

    const fmt = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    $("#weekRangePill").textContent = `${fmt(weekStart)} ‚Äì ${fmt(weekEnd)}`;

    let drafts = 0, finalized = 0;
    state.weeklyPlan.forEach(cls => {
      const clsDate = parseDateInput(cls.date);
      if (clsDate >= weekStart && clsDate <= weekEnd) {
        if (cls.status === 'draft') drafts++;
        else finalized++;
      }
    });

    $("#draftsCountPill").textContent = `${drafts} draft${drafts !== 1 ? 's' : ''}`;
    $("#finalizedCountPill").textContent = `${finalized} finalized`;
  }
  function navigateWeek(direction) {
    if (direction === 0) {
        state.currentWeekStart = getWeekStart(new Date());
    } else {
        const newStart = new Date(state.currentWeekStart);
        newStart.setDate(newStart.getDate() + (direction * 7));
        state.currentWeekStart = newStart;
    }
    renderWeeklyCalendar();
  }
  
  window.openNewClassModal = function(dateKey) {
    state.selectedClass = createClass(dateKey, '09:00');
    state.modalAttendees = [];

    $("#class-modal-title").textContent = 'Plan New Class';
    $("#modal-class-date").value = dateKey;
    populateTimeSelect($("#modal-class-time"), '09:00');
    populateClassTypeDropdown($("#modal-class-type"), '');
    $("#modal-class-playlist").value = '';
    updateModalPlaylistDisplay('');
    $("#modal-class-notes").value = '';

    populateModalGuestList();
    renderModalSelectedGuests();

    $("#delete-class-modal").classList.add('hidden');
    $("#class-modal").classList.remove('hidden');
  };
  window.openClassModal = function(dateTimeKey) {
    const classData = state.weeklyPlan.get(dateTimeKey);
    if (!classData) return;

    state.selectedClass = classData;
    state.modalAttendees = [...(classData.attendees || [])];

    $("#class-modal-title").textContent = 'Edit Class';
    $("#modal-class-date").value = classData.date;
    populateTimeSelect($("#modal-class-time"), classData.time || '09:00');
    populateClassTypeDropdown($("#modal-class-type"), classData.classType || '');
    $("#modal-class-notes").value = classData.notes || '';
    $("#modal-class-playlist").value = classData.playlist || '';
    updateModalPlaylistDisplay(classData.playlist || '');
    populateModalGuestList();
    renderModalSelectedGuests();

    $("#delete-class-modal").classList.remove('hidden');
    $("#class-modal").classList.remove('hidden');
  };
  function openHistoryClassModal(date, time, playlist) {
    const normalizedTime = normalizeTime(time, '00:00');
    const dateTimeKey = createDateTimeKey(date, normalizedTime);

    // If the class exists in weeklyPlan, open directly
    const existingClass = state.weeklyPlan.get(dateTimeKey);
    if (existingClass) {
      openClassModal(dateTimeKey);
      return;
    }

    // Records-only entry ‚Äî build a synthetic class from matching records
    const normalizedPlaylist = normalizePlaylistId(playlist);
    const matchingRecords = state.records.filter(r =>
      r.date === date &&
      normalizeTime(r.time) === normalizedTime &&
      normalizePlaylistId(r.playlist) === normalizedPlaylist
    );

    if (matchingRecords.length === 0) {
      showToast('Could not find class data.', 'error');
      return;
    }

    const attendees = new Set(matchingRecords.map(r => r.guest).filter(Boolean));
    const classType = (matchingRecords.find(r => r.classType) || {}).classType || '';

    const syntheticClass = createClass(date, normalizedTime, normalizedPlaylist, attendees, '', 'finalized', classType);
    state.weeklyPlan.set(dateTimeKey, syntheticClass);

    // Persist the synthetic class so the modal can save/finalize against it
    if (state.firebaseUser) {
      saveClassToFirestore(dateTimeKey, syntheticClass).catch(err =>
        console.error('Failed to persist synthetic class:', err)
      );
    }

    openClassModal(dateTimeKey);
  }
  function updateModalPlaylistDisplay(playlistId) {
    const display = $('#modal-class-playlist-display');
    if (!display) return;
    const normalized = normalizePlaylistId(playlistId);
    display.textContent = normalized ? `Playlist #${normalized}` : 'No playlist assigned yet';
  }
  // --- Guest Selection System ---
  function populateModalGuestList() {
    const modalGuestList = $("#modal-guest-list");
    modalGuestList.innerHTML = "";

    // Compute last-seen days for each guest
    const todayKey = formatDateKey(new Date());
    const guestLastSeen = new Map();
    state.records.forEach(r => {
      if (r.date && r.date <= todayKey) {
        const prev = guestLastSeen.get(r.guest);
        if (!prev || r.date > prev) guestLastSeen.set(r.guest, r.date);
      }
    });

    Array.from(state.allGuests).sort().forEach(guest => {
      const guestElement = document.createElement("div");
      guestElement.className = `guest-list-item ${state.modalAttendees.includes(guest) ? 'selected' : ''}`;
      guestElement.dataset.guest = guest;
      guestElement.textContent = guest;

      const lastDate = guestLastSeen.get(guest);
      if (lastDate) {
        guestElement.dataset.lastSeenDays = String(daysBetween(todayKey, lastDate));
      } else {
        guestElement.dataset.lastSeenDays = 'never';
      }

      guestElement.addEventListener("click", () => {
        if (state.modalAttendees.includes(guest)) {
          state.modalAttendees = state.modalAttendees.filter(g => g !== guest);
        } else {
          state.modalAttendees.push(guest);
        }
        renderModalSelectedGuests();
        updateModalGuestListSelection();
        // Clear search and apply default filter (don't refocus to avoid keyboard popup on tap)
        const searchInput = $('#modal-guest-search');
        const clearBtn = $('#modal-guest-search-clear');
        searchInput.value = '';
        if (clearBtn) clearBtn.classList.remove('visible');
        filterModalGuestVisibility();
      });
      modalGuestList.appendChild(guestElement);
    });
    filterModalGuestVisibility();
  }
  function filterModalGuestVisibility() {
    const term = ($('#modal-guest-search').value || '').toLowerCase();
    $$("#modal-guest-list .guest-list-item").forEach(item => {
      const guest = item.dataset.guest.toLowerCase();
      if (term) {
        // When searching, show all matching guests
        item.style.display = guest.includes(term) ? '' : 'none';
      } else {
        // When not searching, only show recent guests (last 90 days) or already-selected guests
        const days = item.dataset.lastSeenDays;
        const isRecent = days !== 'never' && parseInt(days, 10) <= 90;
        const isSelected = state.modalAttendees.includes(item.dataset.guest);
        item.style.display = (isRecent || isSelected) ? '' : 'none';
      }
    });
  }
  function setupDragReorder(container, itemSelector, handleSelector, onReorder) {
    const items = container.querySelectorAll(itemSelector);

    items.forEach(function(item) {
      const idx = parseInt(item.dataset.index, 10);

      // Desktop drag-and-drop
      item.addEventListener("dragstart", function(e) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", String(idx));
        requestAnimationFrame(() => item.classList.add("dragging"));
      });
      item.addEventListener("dragend", function() {
        item.classList.remove("dragging");
        container.querySelectorAll(itemSelector).forEach(el => el.classList.remove("drag-over"));
      });
      item.addEventListener("dragover", function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        container.querySelectorAll(itemSelector).forEach(el => el.classList.remove("drag-over"));
        item.classList.add("drag-over");
      });
      item.addEventListener("dragleave", function() {
        item.classList.remove("drag-over");
      });
      item.addEventListener("drop", function(e) {
        e.preventDefault();
        item.classList.remove("drag-over");
        const fromIdx = parseInt(e.dataTransfer.getData("text/plain"), 10);
        if (fromIdx !== idx) onReorder(fromIdx, idx);
      });

      // Touch drag-and-drop
      let touchClone = null;
      let touchStarted = false;
      let holdTimer = null;

      const handle = item.querySelector(handleSelector);
      if (!handle) return;

      handle.addEventListener("touchstart", function(e) {
        holdTimer = setTimeout(function() {
          touchStarted = true;
          item.classList.add("dragging");
          const touch = e.touches[0];
          touchClone = item.cloneNode(true);
          touchClone.classList.add("touch-clone");
          touchClone.style.position = "fixed";
          touchClone.style.left = (touch.clientX - 40) + "px";
          touchClone.style.top = (touch.clientY - 20) + "px";
          touchClone.style.zIndex = "9999";
          touchClone.style.pointerEvents = "none";
          document.body.appendChild(touchClone);
        }, 150);
      }, { passive: true });

      handle.addEventListener("touchmove", function(e) {
        if (!touchStarted) { clearTimeout(holdTimer); return; }
        e.preventDefault();
        const touch = e.touches[0];
        if (touchClone) {
          touchClone.style.left = (touch.clientX - 40) + "px";
          touchClone.style.top = (touch.clientY - 20) + "px";
        }
        container.querySelectorAll(itemSelector).forEach(el => el.classList.remove("drag-over"));
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (target) {
          const hit = target.closest(itemSelector);
          if (hit && hit !== item) hit.classList.add("drag-over");
        }
      }, { passive: false });

      function touchEnd() {
        clearTimeout(holdTimer);
        if (!touchStarted) return;
        touchStarted = false;
        item.classList.remove("dragging");
        if (touchClone) { touchClone.remove(); touchClone = null; }
        const overEl = container.querySelector(itemSelector + ".drag-over");
        if (overEl) {
          const toIdx = parseInt(overEl.dataset.index, 10);
          overEl.classList.remove("drag-over");
          if (idx !== toIdx) onReorder(idx, toIdx);
        }
        container.querySelectorAll(itemSelector).forEach(el => el.classList.remove("drag-over"));
      }
      handle.addEventListener("touchend", touchEnd);
      handle.addEventListener("touchcancel", touchEnd);
    });
  }

  function renderModalSelectedGuests() {
    const container = $("#modal-selected-guests");
    container.innerHTML = "";

    if (state.modalAttendees.length === 0) {
      container.innerHTML = `<div class="no-selection">No guests selected</div>`;
      return;
    }

    state.modalAttendees.forEach(function(name, idx) {
      const chip = document.createElement("div");
      chip.className = "selected-guest-item";
      chip.draggable = true;
      chip.dataset.index = idx;
      chip.dataset.guest = name;
      chip.innerHTML = `<span class="drag-handle" aria-label="Drag to reorder">‚†ø</span><span>${esc(name)}</span><span class="remove-guest" data-guest="${esc(name)}">‚úï</span>`;

      chip.querySelector(".remove-guest").addEventListener("click", function(e) {
        e.stopPropagation();
        state.modalAttendees = state.modalAttendees.filter(g => g !== name);
        renderModalSelectedGuests();
        updateModalGuestListSelection();
      });

      container.appendChild(chip);
    });

    setupDragReorder(container, ".selected-guest-item", ".drag-handle", function(fromIdx, toIdx) {
      const moved = state.modalAttendees.splice(fromIdx, 1)[0];
      state.modalAttendees.splice(toIdx, 0, moved);
      renderModalSelectedGuests();
    });
  }
  function updateModalGuestListSelection() {
    $$("#modal-guest-list .guest-list-item").forEach(item => {
      item.classList.toggle("selected", state.modalAttendees.includes(item.dataset.guest));
    });
  }
  
  // --- Metrics Calculation ---
  function lastHeardMap(referenceDate) {
    const refDate = parseDateInput(referenceDate || formatDateKey(new Date())) || new Date();
    const map = new Map();
    state.records.forEach(r => {
      const recordDate = parseDateInput(r.date);
      if (!recordDate || recordDate > refDate) return;
      if (!map.has(r.guest)) map.set(r.guest, new Map());
      const pm = map.get(r.guest);
      const prev = pm.get(r.playlist);
      if (!prev || recordDate > parseDateInput(prev)) {
        pm.set(r.playlist, r.date);
      }
    });
    return map;
  }
  function computeMetrics(opts = {}) {
    const refDateISO = opts.date || formatDateKey(new Date());
    const lm = lastHeardMap(refDateISO);
    const rosterSource = opts.attendees instanceof Set ? Array.from(opts.attendees) : Array.from(opts.attendees || []);
    const roster = rosterSource.filter(Boolean);
    if (roster.length === 0) return [];
    const windowDays = Number.isFinite(opts.window) ? opts.window : state.selectedWindow;
    const classTypeFilter = opts.classType !== undefined ? opts.classType : '';
    const classTypeFilterLower = classTypeFilter.toLowerCase();
    const filteredPlaylists = state.playlists.filter(pl => {
      const status = normalizePlaylistStatus(state.playlistStatus.get(pl) || 'Active');
      if (status === 'Retired' || status === 'Removed') return false;
      if (classTypeFilterLower) {
        const tags = state.playlistTags.get(pl) || [];
        return tags.some(t => t.toLowerCase() === classTypeFilterLower);
      }
      return true;
    });
    const byPlaylist = filteredPlaylists.map(pl => {
      let never = 0;
      let deltas = [];
      let dueCount = 0;
      let recentCount = 0;
      roster.forEach(g => {
        const last = lm.get(g)?.get(pl);
        if (!last) {
          never++;
          return;
        } else {
          const d = daysBetween(refDateISO, last);
          if (d < 0) {
            never++;
            return;
          }
          deltas.push(d);
          if (d >= windowDays) {
            dueCount++;
          } else {
            recentCount++;
          }
        }
      });
      const medianDays = deltas.length ? median(deltas) : 0;
      const rosterSize = roster.length;
      const neverPct = rosterSize ? Math.round((never / rosterSize) * 100) : 0;
      const duePct = rosterSize ? Math.round((dueCount / rosterSize) * 100) : 0;
      const recentPct = rosterSize ? Math.round((recentCount / rosterSize) * 100) : 0;
      // Favor never-heard and replay-ready coverage while penalizing recently-heard overlap.
      const score = (neverPct * 3.4) + (duePct * 2.2) + (medianDays * 0.12) - (recentPct * 2.6);

      return {
        playlist: pl,
        never,
        dueCount,
        recentCount,
        heardCount: deltas.length,
        median: medianDays,
        stalePct: duePct, // Backward compatible alias
        readyPct: duePct,
        neverPct,
        recentPct,
        rosterSize,
        score
      };
    });
    byPlaylist.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      if (b.neverPct !== a.neverPct) return b.neverPct - a.neverPct;
      if (b.readyPct !== a.readyPct) return b.readyPct - a.readyPct;
      if (b.median !== a.median) return b.median - a.median;
      return comparePlaylistIds(a.playlist, b.playlist);
    });
    return byPlaylist;
  }
  function getRecommendationStrength(metrics) {
    const best = metrics[0];
    if (!best) return null;
    const second = metrics[1];
    if (!second) {
      return {
        tone: 'strong',
        label: 'High confidence',
        detail: 'Only one active playlist matches current filters.',
        gap: null
      };
    }
    const gap = Math.max(0, best.score - second.score);
    const roundedGap = Math.round(gap * 10) / 10;
    if (gap >= 18) {
      return {
        tone: 'strong',
        label: 'High confidence',
        detail: `${roundedGap} points ahead of #${second.playlist}.`,
        gap: roundedGap
      };
    }
    if (gap >= 8) {
      return {
        tone: 'moderate',
        label: 'Medium confidence',
        detail: `${roundedGap} points ahead of #${second.playlist}.`,
        gap: roundedGap
      };
    }
    return {
      tone: 'close',
      label: 'Close decision',
      detail: `${roundedGap} points ahead of #${second.playlist}. Check runner-ups.`,
      gap: roundedGap
    };
  }
  // --- UI Refresh Functions ---
  function refreshAll() {
      const selectedEntries = getSelectedRecommenderClassEntries();
      populatePlannedClassList();
      const metrics = getMetricsForSelectedClasses(selectedEntries);
      refreshDashboard(metrics, selectedEntries);
      refreshExplorer();
      updateDashboardStatus(selectedEntries);
  }
  function refreshDashboard(metrics, selectedEntries = getSelectedRecommenderClassEntries()) {
    const best = metrics[0];
    const bestSummary = $("#bestSummary");
    const bestStrength = $("#bestStrength");
    const rankingsBody = $("#runnerUps");
    if (!bestSummary || !bestStrength || !rankingsBody) return;
    const assignBestBtn = $("#assignBestPlaylistBtn");
    if (assignBestBtn) {
      assignBestBtn.disabled = true;
      assignBestBtn.dataset.playlist = '';
      assignBestBtn.textContent = 'Assign Best Playlist';
    }

    if (!selectedEntries || selectedEntries.length === 0) {
      bestSummary.innerHTML = '<div class="muted">Add a class in Weekly Planner, then select it here for recommendations.</div>';
      bestStrength.innerHTML = '';
      $("#bestNever").textContent = "--";
      $("#bestMedian").textContent = "--";
      $("#bestReady").textContent = "--";
      rankingsBody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--secondary-text);">No planned classes available.</td></tr>';
      return;
    }

    // Compute aggregate roster size
    const mergedAttendees = new Set();
    selectedEntries.forEach(entry => {
      const cls = entry.cls || {};
      const att = cls.attendees instanceof Set ? cls.attendees : new Set(cls.attendees || []);
      att.forEach(g => mergedAttendees.add(g));
    });
    const rosterSize = mergedAttendees.size;
    const classTypes = [...new Set(selectedEntries.map(e => (e.cls.classType || '').trim()).filter(Boolean))];
    const classType = classTypes.length === 1 ? classTypes[0] : '';
    const classCount = selectedEntries.length;
    const draftEntries = selectedEntries.filter(e => e.cls.status !== 'finalized');
    const allFinalized = draftEntries.length === 0;

    // Check if best playlist is already assigned to ALL selected draft classes
    const assignedPlaylists = new Set(selectedEntries.map(e => normalizePlaylistId(e.cls.playlist)).filter(Boolean));

    if (!best || rosterSize === 0) {
      bestSummary.innerHTML = rosterSize === 0
        ? '<div class="muted">Selected classes have no attendees yet. Add attendees in Weekly Planner.</div>'
        : (classType
          ? `<div class="muted">No playlists tagged for <strong>${esc(classType)}</strong>. Tag playlists in the Playlist Manager or update class type.</div>`
          : '<div class="muted">No active playlists are available for ranking.</div>');
      bestStrength.innerHTML = '';
      $("#bestNever").textContent = "--";
      $("#bestMedian").textContent = "--";
      $("#bestReady").textContent = "--";
      rankingsBody.innerHTML = rosterSize === 0
        ? '<tr><td colspan="8" style="text-align:center; color:var(--secondary-text);">No ranking yet ‚Äî selected classes have no attendees.</td></tr>'
        : '<tr><td colspan="8" style="text-align:center; color:var(--secondary-text);">No playlists match the selected class type.</td></tr>';
      return;
    }

    const strength = getRecommendationStrength(metrics);
    const selectionLabel = classCount === 1
      ? `Selected class: ${esc(formatDateTime(selectedEntries[0].cls.date, selectedEntries[0].cls.time))} \u2022 ${rosterSize} attendees`
      : `${classCount} classes selected \u2022 ${rosterSize} unique attendees`;
    const assignedText = assignedPlaylists.size === 1 ? `#${esc([...assignedPlaylists][0])}` : assignedPlaylists.size > 1 ? 'Mixed' : 'None';
    bestSummary.innerHTML = `
      <div class="best-summary-title">
        Playlist <span style="color: var(--primary);">#${best.playlist}</span>${renderPlaylistTags(best.playlist)}
      </div>
      <div class="best-summary-meta">${selectionLabel}</div>
      <div class="best-summary-meta">Replay-ready threshold: ${state.selectedWindow} days${classType ? ' \u2022 ' + esc(classType) : ''} \u2022 Current assignment: ${assignedText}</div>
      <div class="best-insight-list">
        <div class="best-insight"><b>${best.never}</b><span>attendees have never heard this playlist</span></div>
        <div class="best-insight"><b>${best.dueCount}</b><span>attendees are replay-ready (&ge; ${state.selectedWindow} days)</span></div>
        <div class="best-insight"><b>${best.recentCount}</b><span>attendees heard it recently (&lt; ${state.selectedWindow} days)</span></div>
      </div>
    `;
    bestStrength.innerHTML = strength
      ? `<span class="rec-strength-pill ${strength.tone}">${esc(strength.label)}</span><span class="subtle" style="font-size:13px;">${esc(strength.detail)}</span>`
      : '';

    $("#bestNever").textContent = `${best.never} (${best.neverPct}%)`;
    $("#bestMedian").textContent = `${best.median}d`;
    $("#bestReady").textContent = `${best.readyPct}%`;

    if (assignBestBtn) {
      assignBestBtn.dataset.playlist = best.playlist;
      const allAlreadyAssigned = draftEntries.length > 0 && draftEntries.every(e => normalizePlaylistId(e.cls.playlist) === best.playlist);
      assignBestBtn.disabled = allFinalized || allAlreadyAssigned;
      if (allFinalized) {
        assignBestBtn.textContent = classCount === 1 ? 'Class Finalized' : 'All Classes Finalized';
      } else if (allAlreadyAssigned) {
        assignBestBtn.textContent = `Best Already Assigned (#${best.playlist})`;
      } else {
        const assignLabel = classCount === 1 ? `Assign Best (#${best.playlist})` : `Assign Best (#${best.playlist}) to ${draftEntries.length} class${draftEntries.length !== 1 ? 'es' : ''}`;
        assignBestBtn.textContent = assignLabel;
      }
    }

    rankingsBody.innerHTML = metrics.map((row, index) => {
      const allRowAssigned = draftEntries.length > 0 && draftEntries.every(e => normalizePlaylistId(e.cls.playlist) === row.playlist);
      const scoreLabel = (Math.round(row.score * 10) / 10).toFixed(1);
      const actionHTML = allFinalized
        ? '<span class="pill status-finalized" style="font-size:11px; padding:4px 8px;">Finalized</span>'
        : `<button type="button" class="btn btn-sm"${allRowAssigned ? ' disabled' : ''} data-assign-playlist="${esc(row.playlist)}">${allRowAssigned ? 'Assigned' : 'Assign'}</button>`;
      return `
        <tr${allRowAssigned ? ' class="rank-row-assigned"' : ''}>
          <td>${index + 1}</td>
          <td><strong>#${esc(row.playlist)}</strong></td>
          <td>${row.never}/${row.rosterSize} (${row.neverPct}%)</td>
          <td>${row.dueCount}/${row.rosterSize} (${row.readyPct}%)</td>
          <td>${row.median}d</td>
          <td>${row.recentCount}/${row.rosterSize} (${row.recentPct}%)</td>
          <td><span class="rank-score">${scoreLabel}</span></td>
          <td>${actionHTML}</td>
        </tr>
      `;
    }).join('');
  }
  function createCell(label, content) {
    const td = document.createElement('td');
    td.dataset.label = label;
    if (typeof content === 'string') {
      td.innerHTML = content;
    } else {
      td.appendChild(content);
    }
    return td;
  }
  function refreshExplorer() {
    const tbody = $("#explorerTbody");
    tbody.innerHTML = "";
    const { column, ascending } = state.explorerSortOrder;
    const dir = ascending ? 1 : -1;

    const rows = state.playlists.map(pl => ({
      playlist: pl,
      status: state.playlistStatus.get(pl) || 'Active'
    }));

    rows.sort((a, b) => {
      if (column === 'playlist') return dir * comparePlaylistIds(a.playlist, b.playlist);
      if (column === 'status') return dir * a.status.localeCompare(b.status);
      return 0;
    });

    rows.forEach(row => {
      const pl = row.playlist;
      const isRetired = row.status === 'Retired';
      const tags = state.playlistTags.get(pl) || [];
      const tr = document.createElement('tr');
      tr.className = 'explorer-row' + (isRetired ? ' retired-row' : '');

      // Tags cell content
      const tagsDiv = document.createElement('div');
      tagsDiv.className = 'manager-tags-cell';
      tags.forEach(t => {
        const chip = document.createElement('span');
        chip.className = 'tag-chip-removable';
        chip.dataset.tag = t;
        chip.innerHTML = `<span>${esc(t)}</span><span class="remove-tag">\u2715</span>`;
        chip.querySelector('.remove-tag').addEventListener('click', e => {
          e.stopPropagation();
          updatePlaylistMetadata(pl, { removeTag: t });
        });
        tagsDiv.appendChild(chip);
      });
      const addTagBtn = document.createElement('span');
      addTagBtn.className = 'add-tag-btn';
      addTagBtn.textContent = '+';
      addTagBtn.title = 'Add tag';
      addTagBtn.addEventListener('click', e => {
        e.stopPropagation();
        state.expandedPlaylist = state.expandedPlaylist === pl ? null : pl;
        refreshExplorer();
      });
      tagsDiv.appendChild(addTagBtn);

      // Status cell content
      const statusPill = document.createElement('span');
      statusPill.className = 'status-toggle ' + (isRetired ? 'retired' : 'active');
      statusPill.textContent = row.status;
      statusPill.addEventListener('click', e => {
        e.stopPropagation();
        updatePlaylistMetadata(pl, { status: isRetired ? 'Active' : 'Retired' });
      });

      // Actions cell content
      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn-remove-playlist';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', e => {
        e.stopPropagation();
        removePlaylist(pl);
      });

      tr.appendChild(createCell('Playlist', `<strong>Playlist #${esc(pl)}</strong>`));
      tr.appendChild(createCell('Tags', tagsDiv));
      tr.appendChild(createCell('Status', statusPill));
      tr.appendChild(createCell('Actions', removeBtn));
      tbody.appendChild(tr);

      // Expanded tag editor row
      if (state.expandedPlaylist === pl) {
        const editorTr = document.createElement('tr');
        editorTr.className = 'tag-editor-row';
        editorTr.innerHTML = `<td colspan="4">${buildTagEditorHTML(pl)}</td>`;
        editorTr.addEventListener('click', e => e.stopPropagation());
        tbody.appendChild(editorTr);
        wireTagEditor(pl, editorTr);
      }
    });
  }
  function buildTagEditorHTML(playlistNum) {
    const tags = state.playlistTags.get(playlistNum) || [];
    const chips = tags.map(t =>
      `<span class="tag-chip-removable" data-tag="${esc(t)}"><span>${esc(t)}</span><span class="remove-tag">‚úï</span></span>`
    ).join('');
    const currentTags = new Set(tags.map(t => t.toLowerCase()));
    const available = getAllClassTypes().filter(t => !currentTags.has(t.toLowerCase()));
    const options = available.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');
    return `<div class="tag-editor">
      <div style="font-weight:600; font-size:13px; color:var(--ink-light);">Class Types for Playlist #${playlistNum}</div>
      <div class="tag-editor-chips">${chips || '<span style="color:var(--secondary-text); font-size:13px;">No tags yet</span>'}</div>
      <select class="tag-select select" style="margin-top:6px;">
        <option value="" disabled selected>Add class type...</option>
        ${options}
      </select>
    </div>`;
  }
  function wireTagEditor(playlistNum, editorTr) {
    // Remove buttons
    editorTr.querySelectorAll('.remove-tag').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const tag = btn.closest('.tag-chip-removable').dataset.tag;
        updatePlaylistMetadata(playlistNum, { removeTag: tag });
      });
    });

    // Dropdown select
    const select = editorTr.querySelector('.tag-select');
    if (select) {
      select.addEventListener('change', () => {
        const value = select.value;
        if (value) {
          updatePlaylistMetadata(playlistNum, { addTag: value });
        }
      });
    }
  }
  function buildHistoryRow(row) {
    const guestArray = [...row.guests].sort();
    const classTypeText = row.classType
      ? esc(row.classType)
      : '<span style="color:var(--secondary-text);">-</span>';
    const moreCount = guestArray.length - 3;
    const moreText = moreCount > 0
      ? ` <span class="history-expand-guests" style="color:var(--primary); cursor:pointer;">+${moreCount} more</span>`
      : '';
    const shortNames = guestArray.slice(0, 3).map(g => esc(g)).join(", ");
    const allNames = guestArray.map(g => esc(g)).join(", ");
    return `<tr data-date="${esc(row.date)}" data-time="${esc(row.time)}" data-playlist="${esc(row.playlist)}">
      <td data-label="Date & Time">${formatDate(row.date)} ${formatTime(row.time)}</td>
      <td data-label="Class Type">${classTypeText}</td>
      <td data-label="Playlist"><strong>Playlist #${row.playlist}</strong></td>
      <td data-label="Attendees"><span class="pill">${guestArray.length}</span></td>
      <td data-label="Guest Names"><span class="guest-names-short">${shortNames}${moreText}</span><span class="guest-names-full" style="display:none;">${allNames} <span class="history-collapse-guests" style="color:var(--primary); cursor:pointer;">show less</span></span></td>
      <td data-label="Status"><span class="pill status-finalized">Completed</span></td>
      <td data-label="Actions"><div class="history-actions"><button class="history-edit-btn" title="Edit class">&#9998;</button><button class="history-delete-btn" title="Delete class">&#128465;</button></div></td>
    </tr>`;
  }
  function getHistorySortValue(row, column) {
    if (column === 'datetime') return new Date(`${row.date}T${row.time}`);
    if (column === 'count') return row.guests.size;
    return row[column];
  }
  function refreshHistory() {
    const tbody = $("#historyTbody");
    const searchTerm = $("#history-search").value.toLowerCase();

    const byClass = new Map();
    const sources = [...state.records, ...Array.from(state.weeklyPlan.values()).filter(c => c.status === 'finalized')];
    sources.forEach(r => {
      if (!r.playlist) return;
      const normalizedTime = normalizeTime(r.time, '00:00');
      const classNumber = normalizeClassNumber(r.classNumber);
      const key = classNumber
        ? `${r.date}T${normalizedTime}::${r.playlist}::${classNumber}`
        : `${r.date}T${normalizedTime}::${r.playlist}`;
      if (!byClass.has(key)) {
        byClass.set(key, { date: r.date, time: normalizedTime, playlist: r.playlist, classType: r.classType || '', classNumber, guests: new Set(), status: 'finalized' });
      }
      const entry = byClass.get(key);
      if (!entry.classType && r.classType) entry.classType = r.classType;
      if (!entry.classNumber && classNumber) entry.classNumber = classNumber;
      if (r.guest) {
        entry.guests.add(r.guest);
      } else if (r.attendees) {
        r.attendees.forEach(g => entry.guests.add(g));
      }
    });

    let rows = [...byClass.values()];
    if (searchTerm) {
      rows = rows.filter(row => {
        const searchable = [
          row.date,
          row.playlist.toString(),
          row.classType || '',
          row.classNumber || '',
          [...row.guests].join(' ')
        ].join(' ').toLowerCase();
        return searchable.includes(searchTerm);
      });
    }

    const { column, ascending } = state.sortOrder;
    rows.sort((a, b) => {
      const aVal = getHistorySortValue(a, column);
      const bVal = getHistorySortValue(b, column);
      if (aVal < bVal) return ascending ? -1 : 1;
      if (aVal > bVal) return ascending ? 1 : -1;
      return 0;
    });

    const totalClasses = rows.length;
    const uniquePlaylists = new Set(rows.map(r => r.playlist)).size;
    const uniqueGuests = new Set(rows.flatMap(r => [...r.guests])).size;
    $("#history-stats").innerHTML = `
      <div class="stat-item"><span class="stat-value">${totalClasses}</span> classes</div>
      <div class="stat-item"><span class="stat-value">${uniquePlaylists}</span> playlists used</div>
      <div class="stat-item"><span class="stat-value">${uniqueGuests}</span> unique guests</div>
    `;

    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:48px 20px; color:var(--secondary-text);"><div style="font-size:48px; opacity:.4; margin-bottom:12px;">&#128214;</div><div style="font-size:16px; color:var(--ink-light); margin-bottom:6px;">No class history yet</div><div style="font-size:13px;">Finalize classes from the Weekly Planner to build your history.</div></td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(buildHistoryRow).join('');

    // Event delegation for all history table interactions
    tbody.onclick = function(e) {
      const target = e.target;
      const td = target.closest('td');
      const tr = target.closest('tr');
      if (target.closest('.history-expand-guests')) {
        td.querySelector('.guest-names-short').style.display = 'none';
        td.querySelector('.guest-names-full').style.display = '';
      } else if (target.closest('.history-collapse-guests')) {
        td.querySelector('.guest-names-short').style.display = '';
        td.querySelector('.guest-names-full').style.display = 'none';
      } else if (target.closest('.history-edit-btn')) {
        e.stopPropagation();
        openHistoryClassModal(tr.dataset.date, tr.dataset.time, tr.dataset.playlist);
      } else if (target.closest('.history-delete-btn')) {
        e.stopPropagation();
        deleteHistoryEntry(tr.dataset.date, tr.dataset.time, tr.dataset.playlist);
      }
    };
  }
  function refreshGuests() {
    const container = $("#guests-grid");
    const searchTerm = $("#guest-search-filter").value.toLowerCase();
    
    const guestsStatsBar = $("#guests-stats");
    if (state.allGuests.size === 0) {
      guestsStatsBar.innerHTML = '';
      container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#128101;</div><h3>Your guest list is waiting</h3><p>Sign in and import attendance data to see guest profiles</p><button class="btn btn-primary" onclick="$$('.tab-btn').find(b=>b.dataset.tab==='settings')?.click()">Import Data</button></div>`;
      return;
    }
    const guestStats = Array.from(state.allGuests)
      .filter(guest => guest.toLowerCase().includes(searchTerm))
      .map(guest => {
        const guestRecords = state.records.filter(r => r.guest === guest);
        const todayKey = formatDateKey(new Date());
        const eligibleRecords = guestRecords.filter(r => r.date <= todayKey);
        const totalClasses = eligibleRecords.length;
        const playlistsHeard = new Set(eligibleRecords.map(r => r.playlist)).size;
        const lastClassDate = eligibleRecords.length > 0 ? eligibleRecords.reduce((latest, r) => r.date > latest ? r.date : latest, '') : null;
        const daysSince = lastClassDate ? daysBetween(formatDateKey(new Date()), lastClassDate) : null;
        return { name: guest, totalClasses, playlistsHeard, daysSince, records: guestRecords };
      })
      .sort((a, b) => (a.daysSince ?? 9999) - (b.daysSince ?? 9999)); // Sort by most recent first
    
    // Update guest summary stats
    const activeGuests = guestStats.filter(g => g.daysSince !== null && g.daysSince <= 90).length;
    guestsStatsBar.innerHTML = `
      <div class="stat-item"><span class="stat-value">${guestStats.length}</span> total guests</div>
      <div class="stat-item"><span class="stat-value">${activeGuests}</span> active (last 90 days)</div>
    `;

    container.innerHTML = "";
    guestStats.forEach(guest => {
      const guestCard = document.createElement("div");
      guestCard.className = "guest-card";
      guestCard.dataset.guestName = guest.name;
      guestCard.innerHTML = `
        <div class="guest-card-header">
          <div class="guest-avatar">${esc(guest.name.split(' ').map(n => n[0]).join('').toUpperCase())}</div>
          <div class="guest-info">
            <h4>${esc(guest.name)}</h4>
            <p>${guest.daysSince !== null ? `Last seen: ${guest.daysSince} days ago` : 'No classes yet'}</p>
          </div>
        </div>
        <div class="guest-stats">
          <div class="guest-stat"><span class="value">${guest.totalClasses}</span><span class="label">Classes</span></div>
          <div class="guest-stat"><span class="value">${guest.playlistsHeard}</span><span class="label">Playlists</span></div>
        </div>`;
      guestCard.addEventListener('click', () => showGuestDetailModal(guest.name));
      container.appendChild(guestCard);
    });
  }
  function showGuestDetailModal(guestName) {
      const guestRecords = state.records
          .filter(r => r.guest === guestName)
          .sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));

      $('#guest-modal-title').textContent = `${guestName}'s Profile`;

      let contentHTML = `<div style="display:flex;gap:8px;margin-bottom:16px;">
        <button type="button" class="btn btn-xs" id="guest-modal-edit" style="flex:1;">&#9998; Rename</button>
        <button type="button" class="btn btn-xs btn-danger" id="guest-modal-delete" style="flex:1;">&#128465; Delete</button>
      </div>`;
      contentHTML += `<div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Playlist</th></tr></thead><tbody>`;
      if (guestRecords.length > 0) {
          guestRecords.forEach(record => {
              contentHTML += `<tr><td>${formatDateTime(record.date, record.time)}</td><td>Playlist #${record.playlist}</td></tr>`;
          });
      } else {
          contentHTML += `<tr><td colspan="2" style="text-align:center;">No class history found.</td></tr>`;
      }
      contentHTML += `</tbody></table></div>`;

      $('#guest-modal-content').innerHTML = contentHTML;
      $('#guest-modal').classList.remove('hidden');

      // Wire up edit button
      $('#guest-modal-edit').addEventListener('click', () => {
        const newName = prompt('Rename guest:', guestName);
        if (newName !== null && newName.trim() !== '' && newName.trim() !== guestName) {
          renameGuest(guestName, newName.trim());
        }
      });
      // Wire up delete button
      $('#guest-modal-delete').addEventListener('click', () => {
        const recordCount = guestRecords.length;
        const msg = recordCount > 0
          ? `Delete "${guestName}" and their ${recordCount} attendance record(s)? This cannot be undone.`
          : `Delete "${guestName}"? This cannot be undone.`;
        if (confirm(msg)) {
          deleteGuest(guestName);
        }
      });
  }

  function showAddGuestPrompt() {
    // Remove any existing add-guest modal
    const existing = $('#add-guest-modal');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'add-guest-modal';
    overlay.className = 'modal';
    overlay.innerHTML = `
      <div class="modal__content" style="max-width:400px;">
        <div class="modal__header">
          <h3>Add New Guest</h3>
          <button class="modal__close" data-action="close">&times;</button>
        </div>
        <div class="modal__body">
          <div class="form-group" style="margin-bottom:0;">
            <label for="add-guest-input">Guest Name</label>
            <input type="text" id="add-guest-input" placeholder="Enter guest name" autocomplete="off">
          </div>
        </div>
        <div class="modal__footer" style="justify-content:flex-end;gap:8px;">
          <button class="btn" data-action="close">Cancel</button>
          <button class="btn btn-primary" data-action="add">Add Guest</button>
        </div>
      </div>`;

    document.body.appendChild(overlay);

    const input = overlay.querySelector('#add-guest-input');
    const addBtn = overlay.querySelector('[data-action="add"]');

    function close() {
      overlay.remove();
    }

    function addGuest() {
      const trimmed = input.value.trim();
      if (!trimmed) {
        showToast('Guest name cannot be empty.', 'error');
        input.focus();
        return;
      }
      if (state.allGuests.has(trimmed)) {
        showToast(`"${esc(trimmed)}" already exists.`, 'error');
        input.focus();
        return;
      }
      state.allGuests.add(trimmed);
      saveStateToLocalStorage();
      refreshGuests();
      showToast(`"${esc(trimmed)}" added.`, 'success');
      close();
    }

    // Close on overlay backdrop click or close/cancel buttons
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay || e.target.dataset.action === 'close') close();
    });
    addBtn.addEventListener('click', addGuest);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addGuest();
      if (e.key === 'Escape') close();
    });

    input.focus();
  }

  async function renameGuest(oldName, newName) {
    if (state.allGuests.has(newName)) {
      showToast(`"${newName}" already exists. Choose a different name.`, 'error');
      return;
    }

    // Update state.allGuests
    state.allGuests.delete(oldName);
    state.allGuests.add(newName);

    // Update local records
    state.records.forEach(r => {
      if (r.guest === oldName) r.guest = newName;
    });

    // Update weeklyPlan attendees
    state.weeklyPlan.forEach(cls => {
      if (cls.attendees instanceof Set) {
        if (cls.attendees.has(oldName)) {
          cls.attendees.delete(oldName);
          cls.attendees.add(newName);
        }
      }
    });

    // Persist to Firestore
    if (state.firebaseUser) {
      try {
        const uid = state.firebaseUser.uid;
        const recordsRef = db.collection('users').doc(uid).collection('records');
        const classesRef = db.collection('users').doc(uid).collection('classes');

        // Update records in batches
        const recordSnap = await recordsRef.get();
        const recordDocs = recordSnap.docs.filter(doc => doc.data().guest === oldName);
        for (let i = 0; i < recordDocs.length; i += 500) {
          const batch = db.batch();
          recordDocs.slice(i, i + 500).forEach(doc => {
            const data = doc.data();
            // Delete old doc, create new one with updated guest + recordKey
            batch.delete(doc.ref);
            const updatedRecord = { ...data, guest: newName };
            updatedRecord.recordKey = buildRecordKey(updatedRecord);
            batch.set(recordsRef.doc(safeDocId(updatedRecord.recordKey)), updatedRecord);
          });
          await batch.commit();
        }

        // Update class attendees
        const classSnap = await classesRef.get();
        const classDocs = classSnap.docs.filter(doc => {
          const attendees = doc.data().attendees || [];
          return attendees.includes(oldName);
        });
        if (classDocs.length > 0) {
          for (let i = 0; i < classDocs.length; i += 500) {
            const batch = db.batch();
            classDocs.slice(i, i + 500).forEach(doc => {
              const data = doc.data();
              const updated = (data.attendees || []).map(g => g === oldName ? newName : g);
              batch.update(doc.ref, { attendees: updated });
            });
            await batch.commit();
          }
        }
      } catch (err) {
        showToast('Rename sync error: ' + err.message, 'error');
        console.error('Rename Firestore error:', err);
      }
    }

    saveStateToLocalStorage();
    refreshGuests();
    refreshAll();
    $('#guest-modal').classList.add('hidden');
    showToast(`Renamed to "${newName}".`, 'success');
  }

  async function deleteGuest(guestName) {
    // Remove from state
    state.allGuests.delete(guestName);
    const removedRecords = state.records.filter(r => r.guest === guestName);
    state.records = state.records.filter(r => r.guest !== guestName);

    // Remove from weeklyPlan attendees
    state.weeklyPlan.forEach(cls => {
      if (cls.attendees instanceof Set) {
        cls.attendees.delete(guestName);
      }
    });

    // Persist to Firestore
    if (state.firebaseUser) {
      try {
        const uid = state.firebaseUser.uid;
        const recordsRef = db.collection('users').doc(uid).collection('records');
        const classesRef = db.collection('users').doc(uid).collection('classes');

        // Delete records in batches
        if (removedRecords.length > 0) {
          for (let i = 0; i < removedRecords.length; i += 500) {
            const batch = db.batch();
            removedRecords.slice(i, i + 500).forEach(r => {
              const recordKey = buildRecordKey(r);
              batch.delete(recordsRef.doc(safeDocId(recordKey)));
            });
            await batch.commit();
          }
        }

        // Update class attendees (remove guest from arrays)
        const classSnap = await classesRef.get();
        const classDocs = classSnap.docs.filter(doc => {
          const attendees = doc.data().attendees || [];
          return attendees.includes(guestName);
        });
        if (classDocs.length > 0) {
          for (let i = 0; i < classDocs.length; i += 500) {
            const batch = db.batch();
            classDocs.slice(i, i + 500).forEach(doc => {
              const data = doc.data();
              const updated = (data.attendees || []).filter(g => g !== guestName);
              batch.update(doc.ref, { attendees: updated });
            });
            await batch.commit();
          }
        }
      } catch (err) {
        showToast('Delete sync error: ' + err.message, 'error');
        console.error('Delete Firestore error:', err);
      }
    }

    saveStateToLocalStorage();
    refreshGuests();
    refreshAll();
    refreshHistory();
    $('#guest-modal').classList.add('hidden');
    showToast(`"${guestName}" deleted.`, 'success');
  }

  // --- EVENT LISTENERS ---

  function wireNavEvents() {
      $$('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
              const tab = btn.dataset.tab;
              $$('.tab-btn').forEach(b => b.setAttribute('aria-selected', 'false'));
              btn.setAttribute('aria-selected', 'true');
              $$('main > section').forEach(s => { s.classList.add('hidden'); s.classList.remove('section-enter'); });
              const section = $(`#${tab}`);
              section.classList.remove('hidden');
              section.classList.add('section-enter');

              if(tab === 'weekly') renderWeeklyCalendar();
              if(tab === 'dashboard') refreshAll();
              if(tab === 'history') refreshHistory();
              if(tab === 'guests') refreshGuests();
              if(tab === 'explorer') refreshAll();
          });
      });
  }

  function wireDashboardEvents() {
      const selectAllDraftsBtn = $('#selectAllDraftsBtn');
      if (selectAllDraftsBtn) {
        selectAllDraftsBtn.addEventListener('click', () => {
          const entries = getRecommenderClassEntries();
          entries.forEach(e => {
            if (e.cls.status !== 'finalized') state.selectedRecommendationClassKeys.add(e.key);
          });
          refreshAll();
        });
      }
      const clearAllClassesBtn = $('#clearAllClassesBtn');
      if (clearAllClassesBtn) {
        clearAllClassesBtn.addEventListener('click', () => {
          state.selectedRecommendationClassKeys.clear();
          refreshAll();
        });
      }
      const playlistWindow = $('#playlistWindow');
      if (playlistWindow) {
        playlistWindow.addEventListener('change', (e) => {
          state.selectedWindow = parseInt(e.target.value, 10);
          refreshAll();
        });
      }
      const assignBestBtn = $('#assignBestPlaylistBtn');
      if (assignBestBtn) {
        assignBestBtn.addEventListener('click', async () => {
          const playlistId = assignBestBtn.dataset.playlist || '';
          if (!playlistId) {
            showToast('No recommendation available to assign.', 'error');
            return;
          }
          await assignPlaylistToSelectedClasses(playlistId);
        });
      }
      const rankingsBody = $('#runnerUps');
      if (rankingsBody) {
        rankingsBody.addEventListener('click', async (e) => {
          const btn = e.target.closest('[data-assign-playlist]');
          if (!btn || btn.disabled) return;
          await assignPlaylistToSelectedClasses(btn.dataset.assignPlaylist || '');
        });
      }
      const previewRosterBtn = $('#previewRosterBtn');
      if (previewRosterBtn) {
        previewRosterBtn.addEventListener('click', () => {
        const selectedEntries = getSelectedRecommenderClassEntries();
        const metrics = getMetricsForSelectedClasses(selectedEntries);
        const best = metrics[0];
        if (selectedEntries.length === 0 || !best) {
          showToast('Select planned classes with attendees to view details.', 'error');
          return;
        }
        const mergedAttendees = new Set();
        selectedEntries.forEach(entry => {
          const cls = entry.cls || {};
          const att = cls.attendees instanceof Set ? cls.attendees : new Set(cls.attendees || []);
          att.forEach(g => mergedAttendees.add(g));
        });
        const roster = [...mergedAttendees].sort();
        if (roster.length === 0) {
          showToast('Add attendees to selected classes first.', 'error');
          return;
        }
        const dates = selectedEntries.map(e => e.cls.date).filter(Boolean).sort();
        const refDate = dates[0] || formatDateKey(new Date());
        const lm = lastHeardMap(refDate);
        const windowDays = state.selectedWindow;
        const neverList = [];
        const readyList = [];
        const recentList = [];
        roster.forEach(g => {
          const last = lm.get(g)?.get(best.playlist);
          if (!last) {
            neverList.push(g);
          } else {
            const d = daysBetween(refDate, last);
            if (d < 0) {
              neverList.push(g);
            } else if (d >= windowDays) {
              readyList.push({ name: g, days: d });
            } else {
              recentList.push({ name: g, days: d });
            }
          }
        });
        readyList.sort((a, b) => b.days - a.days);
        recentList.sort((a, b) => a.days - b.days);
        const classCount = selectedEntries.length;
        const classLabel = classCount === 1
          ? esc(formatDateTime(selectedEntries[0].cls.date, selectedEntries[0].cls.time))
          : `${classCount} classes selected`;
        let html = `<h4 style="margin-bottom:12px;">Playlist #${best.playlist} ‚Äî Roster Breakdown</h4>`;
        html += `<p class="muted" style="margin-bottom:12px;">${classLabel} ‚Ä¢ ${roster.length} attendees ‚Ä¢ Replay-ready threshold: ${windowDays} days</p>`;
        if (neverList.length > 0) {
          html += `<div style="margin-bottom:12px;"><strong>Never Heard (${neverList.length})</strong><div style="margin-top:4px;">${neverList.map(g => `<span class="pill">${esc(g)}</span>`).join(' ')}</div></div>`;
        }
        if (readyList.length > 0) {
          html += `<div style="margin-bottom:12px;"><strong>Replay-ready (${readyList.length})</strong><div style="margin-top:4px;">${readyList.map(g => `<span class="pill status-draft">${esc(g.name)} ‚Äî ${g.days}d ago</span>`).join(' ')}</div></div>`;
        }
        if (recentList.length > 0) {
          html += `<div style="margin-bottom:12px;"><strong>Recently heard (${recentList.length})</strong><div style="margin-top:4px;">${recentList.map(g => `<span class="pill status-finalized">${esc(g.name)} ‚Äî ${g.days}d ago</span>`).join(' ')}</div></div>`;
        }
        $('#guest-modal-title').textContent = 'Playlist Detail';
        $('#guest-modal-content').innerHTML = html;
        $('#guest-modal').classList.remove('hidden');
        });
      }
  }

  function wireSearchEvents() {
      function setupSearchClear(inputId, clearId, onClear) {
        const input = $(inputId);
        const btn = $(clearId);
        if (!input || !btn) return;
        function syncBtn() { btn.classList.toggle('visible', input.value.length > 0); }
        input.addEventListener('input', syncBtn);
        btn.addEventListener('click', () => { input.value = ''; syncBtn(); if (onClear) onClear(); });
      }

      // Guests tab search & add
      $('#guest-search-filter').addEventListener('input', refreshGuests);
      setupSearchClear('#guest-search-filter', '#guest-filter-clear', refreshGuests);
      $('#add-guest-btn').addEventListener('click', showAddGuestPrompt);

      // Modal guest search
      $('#modal-guest-search').addEventListener('input', () => {
          filterModalGuestVisibility();
      });
      $('#modal-guest-search').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const visible = $$("#modal-guest-list .guest-list-item").filter(item => item.style.display !== 'none');
          if (visible.length === 1) {
            visible[0].click();
          }
        }
      });
      setupSearchClear('#modal-guest-search', '#modal-guest-search-clear', () => {
        filterModalGuestVisibility();
      });

      // History search
      $('#history-search').addEventListener('input', refreshHistory);
      setupSearchClear('#history-search', '#history-search-clear', refreshHistory);
  }

  function wireExplorerEvents() {
      $('#addPlaylistBtn').addEventListener('click', () => {
        const form = $('#addPlaylistForm');
        form.style.display = form.style.display === 'none' ? '' : 'none';
        if (form.style.display !== 'none') {
          $('#newPlaylistId').value = '';
          $('#addPlaylistError').style.display = 'none';
          $('#newPlaylistId').focus();
        }
      });
      $('#cancelAddPlaylist').addEventListener('click', () => {
        $('#addPlaylistForm').style.display = 'none';
      });
      $('#confirmAddPlaylist').addEventListener('click', async () => {
        const input = $('#newPlaylistId');
        const result = await addNewPlaylist(input.value);
        if (!result.ok) {
          const errEl = $('#addPlaylistError');
          errEl.textContent = result.error;
          errEl.style.display = '';
        } else {
          $('#addPlaylistForm').style.display = 'none';
        }
      });
      $('#newPlaylistId').addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          $('#confirmAddPlaylist').click();
        } else if (e.key === 'Escape') {
          $('#addPlaylistForm').style.display = 'none';
        }
      });
  }

  function wireSortEvents() {
      $$('#history-table .sortable, #explorer thead .sortable').forEach(header => {
          header.addEventListener('click', () => {
              const sortKey = header.dataset.sort;
              const isExplorer = header.closest('#explorer');
              const sortState = isExplorer ? state.explorerSortOrder : state.sortOrder;

              if (sortState.column === sortKey) {
                  sortState.ascending = !sortState.ascending;
              } else {
                  sortState.column = sortKey;
                  sortState.ascending = false;
              }

              header.closest('table').querySelectorAll('.sortable').forEach(h => h.classList.remove('asc', 'desc'));
              header.classList.add(sortState.ascending ? 'asc' : 'desc');

              if (isExplorer) refreshExplorer(); else refreshHistory();
          });
      });
  }

  function wirePlannerEvents() {
      // Finalize All Drafts
      $('#syncAllBtn').addEventListener('click', async () => {
        if (!state.firebaseUser) {
          showToast('Please sign in first.', 'error');
          return;
        }
        const drafts = [];
        const weekStart = state.currentWeekStart;
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
        state.weeklyPlan.forEach((cls, key) => {
          const clsDate = parseDateInput(cls.date);
          if (clsDate >= weekStart && clsDate <= weekEnd && cls.status === 'draft') {
            drafts.push({ key, cls });
          }
        });
        if (drafts.length === 0) {
          showToast('No drafts to finalize this week.', 'info');
          return;
        }
        setLoading($('#syncAllBtn'), true);
        try {
          const uid = state.firebaseUser.uid;
          let finalizedCount = 0;
          let skippedCount = 0;
          for (const { key, cls } of drafts) {
            if (!cls.playlist || cls.attendees.size === 0) {
              skippedCount++;
              continue;
            }
            const batch = db.batch();
            const classRef = db.collection('users').doc(uid).collection('classes').doc(safeDocId(key));
            batch.set(classRef, {
              date: cls.date, time: cls.time, playlist: cls.playlist,
              attendees: Array.from(cls.attendees), status: 'finalized',
              notes: cls.notes || '', classType: cls.classType || '', dateTimeKey: key
            });
            const recordsRef = db.collection('users').doc(uid).collection('records');
            for (const guest of cls.attendees) {
              const recordKey = buildRecordKey({ date: cls.date, time: normalizeTime(cls.time), guest, playlist: cls.playlist });
              batch.set(recordsRef.doc(safeDocId(recordKey)), {
                date: cls.date, time: normalizeTime(cls.time), guest, playlist: cls.playlist, classType: cls.classType || '', recordKey
              });
            }
            await batch.commit();
            finalizedCount++;
          }
          if (finalizedCount === 0) {
            showToast('No drafts were ready to finalize. Assign playlists and attendees first.', 'info');
          } else {
            const skippedMsg = skippedCount > 0 ? ` (${skippedCount} skipped)` : '';
            showToast(`Finalized ${finalizedCount} class${finalizedCount !== 1 ? 'es' : ''}!${skippedMsg}`, 'success');
          }
        } catch (error) {
          showToast('Finalize failed: ' + error.message, 'error');
        } finally {
          setLoading($('#syncAllBtn'), false);
        }
      });

      // Week navigation
      $('#prevWeekBtn').addEventListener('click', () => navigateWeek(-1));
      $('#currentWeekBtn').addEventListener('click', () => navigateWeek(0));
      $('#nextWeekBtn').addEventListener('click', () => navigateWeek(1));
  }

  function wireSettingsEvents() {
      // Auth
      const signInHandler = async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
        } catch (err) {
          if (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-browser') {
            auth.signInWithRedirect(provider);
          } else {
            showToast('Sign in failed: ' + err.message, 'error');
          }
        }
      };
      $('#settingsSignInBtn').addEventListener('click', signInHandler);
      $('#settingsSignOutBtn').addEventListener('click', () => auth.signOut());

      // Data management
      $('#clearDataBtn').addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
              try {
                if (state.firebaseUser) await clearAllFirestoreData();
              } catch (e) {
                console.error('Firestore clear error:', e);
              }
              localStorage.removeItem('hiloPlaylistData');
              state.records = [];
              state.allGuests.clear();
              state.weeklyPlan.clear();
              state.playlistTags = new Map();
              state.playlistStatus = new Map();
              window.location.reload();
          }
      });
      $('#importCsvBtn').addEventListener('click', () => $('#fileInput').click());
      $('#exportCsvBtn').addEventListener('click', exportToCsv);
      $('#fileInput').addEventListener('change', handleCsvImport);
  }

  function wireModalEvents() {
      $$('#close-class-modal, #cancel-modal').forEach(btn => btn.addEventListener('click', () => $('#class-modal').classList.add('hidden')));
      $('#close-guest-modal').addEventListener('click', () => $('#guest-modal').classList.add('hidden'));
      $('#save-draft-modal').addEventListener('click', handleModalSave);
      $('#delete-class-modal').addEventListener('click', handleModalDelete);
      $('#modalClearAllBtn').addEventListener('click', () => {
        state.modalAttendees = [];
        renderModalSelectedGuests();
        updateModalGuestListSelection();
      });
  }

  function addEventListeners() {
      wireNavEvents();
      wireDashboardEvents();
      wireSearchEvents();
      wireExplorerEvents();
      wireSortEvents();
      wirePlannerEvents();
      wireSettingsEvents();
      wireModalEvents();
  }

  // --- Modal Handlers ---
  async function handleModalSave() {
      const cls = state.selectedClass;
      if (!cls) return;
      if (cls.status === 'finalized') {
          showToast('This class is finalized. Use Finalize to apply changes.', 'info');
          return;
      }
      const preservedPlaylist = normalizePlaylistId($('#modal-class-playlist').value || cls.playlist);

      const oldKey = createDateTimeKey(cls.date, cls.time);
      const newDate = ($('#modal-class-date').value || '').trim();
      const rawTime = ($('#modal-class-time').value || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
          showToast('Please choose a valid class date.', 'error');
          return;
      }
      const newTime = normalizeTime(rawTime, '');
      if (!newTime) {
          showToast('Please choose a valid class time.', 'error');
          return;
      }
      const newKey = createDateTimeKey(newDate, newTime);
      const collision = state.weeklyPlan.get(newKey);
      if (oldKey !== newKey && collision && collision !== cls) {
          showToast('A class already exists at that date and time.', 'error');
          return;
      }

      const classData = {
        date: newDate,
        time: newTime,
        playlist: preservedPlaylist,
        attendees: [...state.modalAttendees],
        status: 'draft',
        notes: $('#modal-class-notes').value || '',
        classType: $('#modal-class-type').value || ''
      };
      if (state.selectedRecommendationClassKeys.has(oldKey)) {
        state.selectedRecommendationClassKeys.delete(oldKey);
        state.selectedRecommendationClassKeys.add(newKey);
      }

      try {
        if (state.firebaseUser) {
          if (oldKey !== newKey) {
            const classesRef = getUserCollectionRef('classes');
            await runFirestoreBatch([
              { action: 'delete', ref: classesRef.doc(safeDocId(oldKey)) },
              { action: 'set', ref: classesRef.doc(safeDocId(newKey)), data: { ...classData, attendees: Array.from(classData.attendees), dateTimeKey: newKey } }
            ]);
          } else {
            const saved = await saveClassToFirestore(newKey, classData);
            if (!saved) return;
          }
        } else {
          if (oldKey !== newKey) state.weeklyPlan.delete(oldKey);
          state.weeklyPlan.set(newKey, classData);
          saveStateToLocalStorage();
          renderWeeklyCalendar();
        }
        refreshAll();
        showToast('Draft saved!', 'success');
        $('#class-modal').classList.add('hidden');
      } catch (error) {
        showToast('Save failed: ' + error.message, 'error');
      }
  }

  async function handleModalFinalize() {
      const cls = state.selectedClass;
      if (!cls || state.modalAttendees.length === 0) {
          showToast('Please select attendees.', 'error');
          return;
      }
      if (!state.firebaseUser) {
          showToast('Please sign in to finalize.', 'error');
          return;
      }
      setLoading($('#finalize-modal'), true);

      const oldKey = createDateTimeKey(cls.date, cls.time);
      const targetDate = ($('#modal-class-date').value || '').trim();
      const rawTargetTime = ($('#modal-class-time').value || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(targetDate)) {
          setLoading($('#finalize-modal'), false);
          showToast('Please choose a valid class date.', 'error');
          return;
      }
      const targetTime = normalizeTime(rawTargetTime, '');
      if (!targetTime) {
          setLoading($('#finalize-modal'), false);
          showToast('Please choose a valid class time.', 'error');
          return;
      }
      const newKey = createDateTimeKey(targetDate, targetTime);
      const collision = state.weeklyPlan.get(newKey);
      if (oldKey !== newKey && collision && collision !== cls) {
          setLoading($('#finalize-modal'), false);
          showToast('A class already exists at that date and time.', 'error');
          return;
      }

      try {
        const batch = db.batch();
        const classesRef = getUserCollectionRef('classes');
        const recordsRef = getUserCollectionRef('records');
        const latestClass = state.weeklyPlan.get(oldKey) || cls;
        const playlist = normalizePlaylistId($('#modal-class-playlist').value || latestClass.playlist || cls.playlist);
        if (!playlist) {
          showToast('Assign a playlist in Recommender before finalizing.', 'error');
          return;
        }
        const attendees = [...state.modalAttendees];
        const notes = $('#modal-class-notes').value || '';
        const classType = $('#modal-class-type').value || '';
        const wasFinalized = cls.status === 'finalized';
        if (state.selectedRecommendationClassKeys.has(oldKey)) {
          state.selectedRecommendationClassKeys.delete(oldKey);
          state.selectedRecommendationClassKeys.add(newKey);
        }

        // Delete old class doc if date/time changed
        if (oldKey !== newKey) {
          batch.delete(classesRef.doc(safeDocId(oldKey)));
        }
        // Remove old finalized attendance records that no longer match the edited class
        if (wasFinalized) {
          const oldPlaylist = normalizePlaylistId(cls.playlist);
          if (oldPlaylist) {
            const oldAttendees = cls.attendees instanceof Set ? cls.attendees : new Set(cls.attendees || []);
            const oldTime = normalizeTime(cls.time);
            oldAttendees.forEach(guest => {
              const oldRecordKey = buildRecordKey({
                date: cls.date,
                time: oldTime,
                guest,
                playlist: oldPlaylist
              });
              const stillPresent = attendees.includes(guest) &&
                oldKey === newKey &&
                oldPlaylist === playlist &&
                oldTime === targetTime;
              if (!stillPresent) {
                batch.delete(recordsRef.doc(safeDocId(oldRecordKey)));
              }
            });
          }
        }
        // Write finalized class
        batch.set(classesRef.doc(safeDocId(newKey)), {
          date: targetDate, time: targetTime, playlist,
          attendees: Array.from(attendees), status: 'finalized',
          notes, classType, dateTimeKey: newKey
        });
        // Write attendance records
        for (const guest of attendees) {
          const recordKey = buildRecordKey({ date: targetDate, time: normalizeTime(targetTime), guest, playlist });
          batch.set(recordsRef.doc(safeDocId(recordKey)), {
            date: targetDate, time: normalizeTime(targetTime), guest, playlist, classType, recordKey
          });
        }
        await batch.commit();
        showToast(wasFinalized ? 'Finalized class updated!' : 'Class finalized!', 'success');
        refreshAll();
        renderWeeklyCalendar();
        $('#class-modal').classList.add('hidden');
      } catch (error) {
        showToast('Finalize failed: ' + error.message, 'error');
      } finally {
        setLoading($('#finalize-modal'), false);
      }
  }
  async function finalizeDayDrafts(dayKey) {
    if (!state.firebaseUser) {
      showToast('Please sign in to finalize.', 'error');
      return;
    }
    const drafts = Array.from(state.weeklyPlan.entries())
      .filter(([key, cls]) => key.startsWith(dayKey) && cls.status === 'draft');
    if (drafts.length === 0) return;

    const missing = drafts.filter(([, cls]) => !normalizePlaylistId(cls.playlist) || cls.attendees.size === 0);
    if (missing.length > 0) {
      const reasons = missing.map(([, cls]) => {
        const problems = [];
        if (!normalizePlaylistId(cls.playlist)) problems.push('no playlist');
        if (cls.attendees.size === 0) problems.push('no attendees');
        return `${formatTime(cls.time)}: ${problems.join(', ')}`;
      });
      showToast('Cannot finalize ‚Äî ' + reasons.join('; '), 'error');
      return;
    }
    if (!confirm(`Finalize ${drafts.length} draft${drafts.length !== 1 ? 's' : ''} for this day?`)) return;

    try {
      const classesRef = getUserCollectionRef('classes');
      const recordsRef = getUserCollectionRef('records');
      const ops = [];

      for (const [key, cls] of drafts) {
        const playlist = normalizePlaylistId(cls.playlist);
        const attendees = cls.attendees instanceof Set ? [...cls.attendees] : [...(cls.attendees || [])];
        ops.push({
          action: 'set',
          ref: classesRef.doc(safeDocId(key)),
          data: {
            date: cls.date, time: cls.time, playlist,
            attendees, status: 'finalized',
            notes: cls.notes || '', classType: cls.classType || '', dateTimeKey: key
          }
        });
        for (const guest of attendees) {
          const recordKey = buildRecordKey({ date: cls.date, time: normalizeTime(cls.time), guest, playlist });
          ops.push({
            action: 'set',
            ref: recordsRef.doc(safeDocId(recordKey)),
            data: { date: cls.date, time: normalizeTime(cls.time), guest, playlist, classType: cls.classType || '', recordKey }
          });
        }
      }
      await runFirestoreBatch(ops);
      showToast(`${drafts.length} class${drafts.length !== 1 ? 'es' : ''} finalized!`, 'success');
      refreshAll();
      renderWeeklyCalendar();
    } catch (error) {
      showToast('Finalize failed: ' + error.message, 'error');
    }
  }
  window.finalizeDayDrafts = finalizeDayDrafts;
  async function handleModalDelete() {
    const cls = state.selectedClass;
    if (!cls) return;
    if (!confirm('Are you sure you want to delete this class?')) return;

    const key = createDateTimeKey(cls.date, cls.time);
    state.selectedRecommendationClassKeys.delete(key);

    if (state.firebaseUser) {
      const classesRef = getUserCollectionRef('classes');
      const ops = [{ action: 'delete', ref: classesRef.doc(safeDocId(key)) }];

      // Also delete attendance records if this was a finalized class
      if (cls.status === 'finalized') {
        const recordsRef = getUserCollectionRef('records');
        const oldPlaylist = normalizePlaylistId(cls.playlist);
        if (oldPlaylist) {
          const oldAttendees = cls.attendees instanceof Set ? cls.attendees : new Set(cls.attendees || []);
          const oldTime = normalizeTime(cls.time);
          oldAttendees.forEach(guest => {
            const recordKey = buildRecordKey({ date: cls.date, time: oldTime, guest, playlist: oldPlaylist });
            ops.push({ action: 'delete', ref: recordsRef.doc(safeDocId(recordKey)) });
          });
        }
      }

      await runFirestoreBatch(ops);
    } else {
      state.weeklyPlan.delete(key);
      saveStateToLocalStorage();
      renderWeeklyCalendar();
    }
    refreshAll();
    showToast('Class deleted.', 'info');
    $('#class-modal').classList.add('hidden');
  }
  async function deleteHistoryEntry(date, time, playlist) {
    const normalizedTime = normalizeTime(time, '00:00');
    const normalizedPlaylist = normalizePlaylistId(playlist);
    if (!confirm('Delete this class and all its attendance records? This cannot be undone.')) return;

    const dateTimeKey = createDateTimeKey(date, normalizedTime);
    const matchingRecords = state.records.filter(r =>
      r.date === date &&
      normalizeTime(r.time) === normalizedTime &&
      normalizePlaylistId(r.playlist) === normalizedPlaylist
    );

    if (state.firebaseUser) {
      try {
        const classesRef = getUserCollectionRef('classes');
        const recordsRef = getUserCollectionRef('records');
        const ops = [
          { action: 'delete', ref: classesRef.doc(safeDocId(dateTimeKey)) },
          ...matchingRecords.map(record => ({
            action: 'delete',
            ref: recordsRef.doc(safeDocId(buildRecordKey(record)))
          }))
        ];
        await runFirestoreBatch(ops);
        showToast('Class and records deleted.', 'info');
      } catch (error) {
        showToast('Delete failed: ' + error.message, 'error');
      }
    } else {
      state.weeklyPlan.delete(dateTimeKey);
      state.records = state.records.filter(r =>
        !(r.date === date &&
          normalizeTime(r.time) === normalizedTime &&
          normalizePlaylistId(r.playlist) === normalizedPlaylist)
      );
      saveStateToLocalStorage();
      refreshAll();
      refreshHistory();
      refreshGuests();
      showToast('Class and records deleted.', 'info');
    }
  }
  // --- CSV Import/Export ---
  function exportToCsv() {
      if (state.records.length === 0) {
          showToast('No data to export.', 'info');
          return;
      }
      const headers = ['Date', 'Time', 'Guest', 'Playlist', 'Class Type', 'Class Number'];
      const csvRows = [headers.join(',')];
      state.records.forEach(r => {
          csvRows.push([r.date, r.time, `"${r.guest.replace(/"/g, '""')}"`, r.playlist, `"${(r.classType || '').replace(/"/g, '""')}"`, `"${(r.classNumber || '').replace(/"/g, '""')}"`].join(','));
      });
      const csvString = csvRows.join('\r\n');
      const blob = new Blob([csvString], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hilo_playlist_export_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV export complete.', 'success');
  }

  function parseCsvRow(row) {
      const fields = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < row.length; i++) {
          const ch = row[i];
          if (inQuotes) {
              if (ch === '"' && row[i + 1] === '"') {
                  current += '"';
                  i++; // skip escaped quote
              } else if (ch === '"') {
                  inQuotes = false;
              } else {
                  current += ch;
              }
          } else {
              if (ch === '"') {
                  inQuotes = true;
              } else if (ch === ',') {
                  fields.push(current);
                  current = '';
              } else {
                  current += ch;
              }
          }
      }
      fields.push(current);
      return fields;
  }
  function parseCsvText(text) {
      const rows = [];
      let currentRow = [];
      let currentField = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
          const ch = text[i];
          if (inQuotes) {
              if (ch === '"' && text[i + 1] === '"') {
                  currentField += '"';
                  i++;
              } else if (ch === '"') {
                  inQuotes = false;
              } else {
                  currentField += ch;
              }
              continue;
          }
          if (ch === '"') {
              inQuotes = true;
          } else if (ch === ',') {
              currentRow.push(currentField);
              currentField = '';
          } else if (ch === '\n') {
              currentRow.push(currentField);
              currentField = '';
              if (currentRow.some(col => (col || '').trim().length > 0)) {
                  rows.push(currentRow);
              }
              currentRow = [];
          } else if (ch === '\r') {
              if (text[i + 1] !== '\n') {
                  currentRow.push(currentField);
                  currentField = '';
                  if (currentRow.some(col => (col || '').trim().length > 0)) {
                      rows.push(currentRow);
                  }
                  currentRow = [];
              }
          } else {
              currentField += ch;
          }
      }

      if (currentField.length > 0 || currentRow.length > 0) {
          currentRow.push(currentField);
          if (currentRow.some(col => (col || '').trim().length > 0)) {
              rows.push(currentRow);
          }
      }
      return rows;
  }
  function normalizeCsvHeader(header) {
      return (header || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
  }
  function buildCsvHeaderLookup(headers) {
      const map = new Map();
      headers.forEach((header, index) => {
          const normalized = normalizeCsvHeader(header);
          if (normalized && !map.has(normalized)) map.set(normalized, index);
      });
      return map;
  }
  function getCsvValue(cols, headerLookup, aliases, fallbackIndex = -1) {
      for (const alias of aliases) {
          const idx = headerLookup.get(alias);
          if (idx !== undefined && idx < cols.length) return (cols[idx] || '').trim();
      }
      if (fallbackIndex >= 0 && fallbackIndex < cols.length) return (cols[fallbackIndex] || '').trim();
      return '';
  }
  function normalizeImportedDate(rawDate) {
      const parsed = parseDateInput((rawDate || '').toString().trim());
      return parsed ? formatDateKey(parsed) : '';
  }

  function handleCsvImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
          const text = (e.target.result || '').toString();
          const rows = parseCsvText(text);
          if (rows.length === 0) {
              showToast('CSV appears empty.', 'error');
              return;
          }

          const headerCols = rows[0];
          const headerLookup = buildCsvHeaderLookup(headerCols);
          const knownHeaders = new Set([
            'date', 'time', 'guest', 'playlist',
            'date of class', 'class time', 'guest name', 'playlist number', 'class type',
            'class level', 'level', 'status', 'playlist status',
            'class number', 'class id', 'class', 'class no'
          ]);
          const hasKnownHeaders = headerCols.some(h => knownHeaders.has(normalizeCsvHeader(h)));
          const dataRows = hasKnownHeaders ? rows.slice(1) : rows;

          let importedCount = 0;
          const importedRecords = [];
          const taggedPlaylists = new Set();
          const statusPlaylists = new Set();
          dataRows.forEach(cols => {
              if (!Array.isArray(cols) || cols.every(col => !(col || '').trim())) return;
              const rawPlaylistValue = getCsvValue(cols, headerLookup, ['playlist', 'playlist number', 'playlist id'], 3);
              const parsedPlaylist = parseImportedPlaylist(rawPlaylistValue);
              const playlistId = parsedPlaylist.playlistId;
              const explicitStatus = normalizePlaylistStatus(getCsvValue(cols, headerLookup, ['status', 'playlist status']));
              const playlistStatus = explicitStatus || parsedPlaylist.inferredStatus;
              if (playlistId && playlistStatus) {
                if (state.playlistStatus.get(playlistId) !== playlistStatus) {
                  state.playlistStatus.set(playlistId, playlistStatus);
                }
                statusPlaylists.add(playlistId);
                ensurePlaylistInState(playlistId);
              }
              const date = normalizeImportedDate(getCsvValue(cols, headerLookup, ['date', 'date of class', 'class date'], 0));
              const time = normalizeTime(getCsvValue(cols, headerLookup, ['time', 'class time'], 1), '09:00');
              const guest = getCsvValue(cols, headerLookup, ['guest', 'guest name', 'name'], 2);
              const classType = getCsvValue(cols, headerLookup, ['class type', 'type', 'class level', 'level'], 4).replace(/\s+/g, ' ').trim();
              const classNumber = normalizeClassNumber(getCsvValue(cols, headerLookup, ['class number', 'class id', 'class no', 'class'], -1));
              const normalized = normalizeRecord({ date, time, guest, playlist: playlistId, classType, classNumber });
              if (!normalized) return;
              if (addRecordIfNew(normalized)) {
                  importedCount++;
                  importedRecords.push(normalized);
              }
              state.allGuests.add(normalized.guest);
              if (classType) {
                  const existingTags = state.playlistTags.get(normalized.playlist) || [];
                  if (!existingTags.includes(classType)) {
                    state.playlistTags.set(normalized.playlist, [...existingTags, classType]);
                    taggedPlaylists.add(normalized.playlist);
                  }
              }
          });
          rebuildPlaylistsFromData();
          saveStateToLocalStorage();
          updateRecordsPill();
          refreshAll();

          // Build import details suffix
          const details = [];
          if (taggedPlaylists.size > 0) details.push(`${taggedPlaylists.size} class-type tag set${taggedPlaylists.size !== 1 ? 's' : ''}`);
          if (statusPlaylists.size > 0) details.push(`${statusPlaylists.size} playlist status${statusPlaylists.size !== 1 ? 'es' : ''}`);

          // Push to Firestore in chunked batches
          if (state.firebaseUser && (importedRecords.length > 0 || taggedPlaylists.size > 0 || statusPlaylists.size > 0)) {
            try {
              if (importedRecords.length > 0) {
                const recordsRef = getUserCollectionRef('records');
                const ops = importedRecords.map(r => {
                  const key = buildRecordKey(r);
                  return { action: 'set', ref: recordsRef.doc(safeDocId(key)), data: { ...r, recordKey: key } };
                });
                await runFirestoreBatch(ops);
              }
              const playlistsRef = getUserCollectionRef('playlists');
              const playlistDocUpdates = new Set([...taggedPlaylists, ...statusPlaylists]);
              for (const playlistId of playlistDocUpdates) {
                const payload = {};
                if (taggedPlaylists.has(playlistId)) payload.classTypes = state.playlistTags.get(playlistId) || [];
                if (statusPlaylists.has(playlistId)) payload.status = state.playlistStatus.get(playlistId) || '';
                if (Object.keys(payload).length === 0) continue;
                await playlistsRef.doc(playlistId).set(payload, { merge: true });
              }
              const detailMsg = details.length > 0 ? ` and synced ${details.join(' and ')}` : '';
              showToast(`Imported ${importedCount} records${detailMsg} to Firebase`, 'success');
            } catch (err) {
              showToast(`Imported locally but Firebase sync failed: ${err.message}`, 'error');
            }
          } else {
            const detailMsg = details.length > 0 ? ` and ${details.join(' and ')}` : '';
            showToast(`Imported ${importedCount} records${detailMsg}.`, 'success');
          }
      };
      reader.readAsText(file);
      $('#fileInput').value = ''; // Reset for next import
  }
  // --- Start the App ---
  document.addEventListener('DOMContentLoaded', initializeApp);
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(function(reg) {
      console.log('Service worker registered:', reg.scope);
    }).catch(function(err) {
      console.log('Service worker registration failed:', err);
    });
  }
</script>
</body>
</html>
